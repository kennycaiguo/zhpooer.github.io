
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>传智播客-OA系统 | Poe&#39;s World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zhpooer">
    
    <meta name="description" content="入门
OA: Office Automation, 办公自动化CRM: 客户关系管理系统ERP: 企业资源管理系统BBS: 论坛系统CMS: 内容管理系统
软件开发流程

需求调研, 形成调研文档
分析需求, 形成需求分析文档
设计(概要设计, 详细设计), 形成设计文档
编码
测试, 测试用例, ">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="Poe&#39;s World" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Poe&#39;s World" title="Poe&#39;s World"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Poe&#39;s World">Poe&#39;s World</a></h1>
				<h2 class="blog-motto">竹杖芒鞋轻胜马，一蓑烟雨任平生</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/english-monthly">英语角</a></li>
					
						<li><a href="/about">关于</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:zhpooer.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/06/20/传智播客-oa系统/" title="传智播客-OA系统" itemprop="url">传智播客-OA系统</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://zhpooer.github.io" title="zhpooer">zhpooer</a>
    </p>
  <p class="article-time">
    <time datetime="2014-06-20T01:02:49.000Z" itemprop="datePublished">6月 20 2014</time>
    更新日期:<time datetime="2014-06-30T13:38:57.616Z" itemprop="dateModified">6月 30 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">1.</span> <span class="toc-text">入门</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">1.1.</span> <span class="toc-text">整体设计</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">2.</span> <span class="toc-text">搭建开发环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-3-"><span class="toc-number">3.</span> <span class="toc-text">系统管理(3)</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">3.1.</span> <span class="toc-text">岗位管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">3.2.</span> <span class="toc-text">部门管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">3.3.</span> <span class="toc-text">用户管理</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-"><span class="toc-number">3.3.1.</span> <span class="toc-text">用户名重复客户端校验</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">4.</span> <span class="toc-text">权限管理</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">4.1.</span> <span class="toc-text">权限实体</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-"><span class="toc-number">4.1.1.</span> <span class="toc-text">初始化数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-"><span class="toc-number">4.1.2.</span> <span class="toc-text">显示层</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">5.</span> <span class="toc-text">应用主页面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">6.</span> <span class="toc-text">用户登陆和注销</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">7.</span> <span class="toc-text">使用权限</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.1.</span> <span class="toc-text">权限拦截器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.2.</span> <span class="toc-text">页面嵌套显示</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">8.</span> <span class="toc-text">个人信息</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#struts-"><span class="toc-number">8.1.</span> <span class="toc-text">struts文件下载</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">9.</span> <span class="toc-text">论坛管理</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.1.</span> <span class="toc-text">论坛管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.2.</span> <span class="toc-text">论坛模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.3.</span> <span class="toc-text">发表主题</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ckeditor-"><span class="toc-number">9.3.1.</span> <span class="toc-text">CKEditor编辑内容</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.4.</span> <span class="toc-text">显示单个主题(回复列表)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.5.</span> <span class="toc-text">回复功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.6.</span> <span class="toc-text">分页</span></a></li></ol>
		</div>
		
		<h1 id="-">入门</h1>
<p>OA: Office Automation, 办公自动化<br>CRM: 客户关系管理系统<br>ERP: 企业资源管理系统<br>BBS: 论坛系统<br>CMS: 内容管理系统</p>
<p>软件开发流程</p>
<ol>
<li>需求调研, 形成调研文档</li>
<li>分析需求, 形成需求分析文档</li>
<li>设计(概要设计, 详细设计), 形成设计文档</li>
<li>编码</li>
<li>测试, 测试用例, 测试计划, 测试报告, 性能测试, 压力测试(HP LoadRunner)</li>
<li>运维</li>
</ol>
<h2 id="-">整体设计</h2>
<p>分层: 表现层, 业务层, 持久层</p>
<p>技术: Struts + Spring3.2 + Hibernate3.6 + Jquery1.8 + Ajax</p>
<p>代码规范:</p>
<ul>
<li>常量字母都大写, 单词之间使用<code>_</code>隔开, 例如 <code>DEFAULT_PAGE_SIZE</code></li>
<li>注释, 在代码中加入适当注释, 说明步骤, 与说明非简单逻辑</li>
<li>空行, 在代码中加入适当空行, 增加可读性</li>
<li>要格式化代码, 一个Java文件中代码不要过多, 一个方法中的代码不要过多</li>
</ul>
<p>约定:</p>
<ul>
<li>文件中都采用 UTF-8 编码, JDK版本, 编译环境统一</li>
<li>实体的主键属性的类型使用<code>Long</code>类型</li>
</ul>
<h1 id="-">搭建开发环境</h1>
<ol>
<li>创建Web项目<code>itcastOA</code></li>
<li>导入jar包(struts2, spring3.2, hibernate3.6, 数据库驱动, c3p0)</li>
<li><p>配置 web.xml</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre>
<span class="tag">&lt;<span class="title">filter</span>&gt;</span>
    <span class="tag">&lt;<span class="title">filter-name</span>&gt;</span> openSessionInView<span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span>
    <span class="tag">&lt;<span class="title">filter-class</span>&gt;</span>OpenSessionInView<span class="tag">&lt;/<span class="title">filter-class</span>&gt;</span>
<span class="tag">&lt;/<span class="title">filter</span>&gt;</span>

<span class="tag">&lt;<span class="title">filter</span>&gt;</span>
    <span class="tag">&lt;<span class="title">filter-name</span>&gt;</span> struts<span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span>
    <span class="tag">&lt;<span class="title">filter-class</span>&gt;</span>StrtusPrepareAndExcutorFilter<span class="tag">&lt;/<span class="title">filter-class</span>&gt;</span>
<span class="tag">&lt;/<span class="title">filter</span>&gt;</span>

<span class="tag">&lt;<span class="title">filter-mapping</span>&gt;</span>
    <span class="tag">&lt;<span class="title">filter-name</span>&gt;</span>openSessionInView <span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span>
    <span class="tag">&lt;<span class="title">url-pattern</span>&gt;</span> /* <span class="tag">&lt;/<span class="title">url-pattern</span>&gt;</span>
<span class="tag">&lt;/<span class="title">filter-mapping</span>&gt;</span>

<span class="tag">&lt;<span class="title">filter-mapping</span>&gt;</span>
    <span class="tag">&lt;<span class="title">filter-name</span>&gt;</span>struts2 <span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span>
    <span class="tag">&lt;<span class="title">url-pattern</span>&gt;</span> /* <span class="tag">&lt;/<span class="title">url-pattern</span>&gt;</span>
<span class="tag">&lt;/<span class="title">filter-mapping</span>&gt;</span>

<span class="comment">&lt;!-- spring监听器 --&gt;</span>
<span class="tag">&lt;<span class="title">listener</span>&gt;</span>
   <span class="tag">&lt;<span class="title">listener-class</span>&gt;</span> org.spring.web.context.ContextLoaderListener <span class="tag">&lt;/<span class="title">listener-class</span>&gt;</span>
<span class="tag">&lt;/<span class="title">listener</span>&gt;</span>
<span class="tag">&lt;<span class="title">context-param</span>&gt;</span>
    <span class="tag">&lt;<span class="title">param-name</span>&gt;</span> contextConfigLocation<span class="tag">&lt;/<span class="title">param-name</span>&gt;</span>
    <span class="tag">&lt;<span class="title">param-value</span>&gt;</span>classpath:beans.xml<span class="tag">&lt;/<span class="title">param-value</span>&gt;</span>
<span class="tag">&lt;/<span class="title">context-param</span>&gt;</span>
</pre></td></tr></table></figure>
</li>
<li><p>加入 <code>struts.xml</code>, <code>beans.xml</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">beans</span>&gt;</span>
    <span class="comment">&lt;!-- 读取属性文件的配置  --&gt;</span>
    <span class="tag">&lt;<span class="title">context:property-placeholder</span> <span class="attribute">locaction</span>=<span class="value">"classpath:jdbc.properties"</span>/&gt;</span>

    <span class="comment">&lt;!-- dataSource  --&gt;</span>
    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"dataSrouce"</span> <span class="attribute">class</span>=<span class="value">"com.mchange.ComboPooledDataSource"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"driverClass"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"jdbcUrl"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"user"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"password"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"initialPoolSize"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"maxPoolSize"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"minPoolSize"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span>
    <span class="comment">&lt;!-- 本地会话工厂bean, LocalSessonFactoryBean --&gt;</span>
    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"sessionFactory"</span> <span class="attribute">class</span>=<span class="value">"org.spring.hibernate.LocalSessionFactory"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"dataSource"</span> <span class="attribute">ref</span>=<span class="value">"dataSource"</span>&gt;</span> <span class="tag">&lt;/<span class="title">property</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"hibernateProperties"</span>&gt;</span>
            <span class="tag">&lt;<span class="title">props</span>&gt;</span>
                <span class="tag">&lt;<span class="title">prop</span> <span class="attribute">key</span>=<span class="value">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQL5Dialect<span class="tag">&lt;/<span class="title">prop</span>&gt;</span>
                <span class="tag">&lt;<span class="title">prop</span> <span class="attribute">key</span>=<span class="value">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="tag">&lt;/<span class="title">prop</span>&gt;</span>
                <span class="tag">&lt;<span class="title">prop</span> <span class="attribute">key</span>=<span class="value">"hibernate.show_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">prop</span>&gt;</span>
                <span class="tag">&lt;<span class="title">prop</span> <span class="attribute">key</span>=<span class="value">"hibernate.format_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">prop</span>&gt;</span>
            <span class="tag">&lt;/<span class="title">props</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">property</span>&gt;</span>
        <span class="comment">&lt;!-- hbm的映射文件 --&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"mappingDirectoryLocations"</span> &gt;</span>
            <span class="tag">&lt;<span class="title">list</span>&gt;</span>
                <span class="tag">&lt;<span class="title">value</span>&gt;</span>classpath:cn/itcast/or/domain <span class="tag">&lt;/<span class="title">value</span>&gt;</span>
            <span class="tag">&lt;/<span class="title">list</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span>
    <span class="comment">&lt;!-- 事务管理器, HibernateTransactonManager --&gt;</span>
    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"transactionManager"</span> <span class="attribute">class</span>=<span class="value">"HibernateTransactionManager"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"sessionFactory"</span> <span class="attribute">ref</span>=<span class="value">"sessionFactory"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span>
    <span class="comment">&lt;!-- 事务通知, AOP切面, 事务注解驱动, 组件扫描 --&gt;</span>
    <span class="tag">&lt;<span class="title">tx:advice</span> <span class="attribute">id</span>=<span class="value">"oaAdvice"</span> <span class="attribute">transaction-manager</span>=<span class="value">"transactionManager"</span>&gt;</span>
        <span class="comment">&lt;!-- 事务属性 --&gt;</span>
        <span class="tag">&lt;<span class="title">tx:attributes</span>&gt;</span>
            <span class="tag">&lt;<span class="title">tx:method</span> <span class="attribute">name</span>=<span class="value">"save*"</span> <span class="attribute">propagation</span>=<span class="value">"REQUIERD"</span> <span class="attribute">isolation</span>=<span class="value">"DEFAULT"</span>&gt;</span>
            <span class="tag">&lt;<span class="title">tx:method</span> <span class="attribute">name</span>=<span class="value">"update*"</span> <span class="attribute">propagation</span>=<span class="value">"REQUIERD"</span> <span class="attribute">isolation</span>=<span class="value">"DEFAULT"</span>&gt;</span>
            <span class="tag">&lt;<span class="title">tx:method</span> <span class="attribute">name</span>=<span class="value">"delete*"</span> <span class="attribute">propagation</span>=<span class="value">"REQUIERD"</span> <span class="attribute">isolation</span>=<span class="value">"DEFAULT"</span>&gt;</span>
            <span class="tag">&lt;<span class="title">tx:method</span> <span class="attribute">name</span>=<span class="value">"find*"</span> <span class="attribute">read-only</span>=<span class="value">"true"</span>&gt;</span>
            <span class="tag">&lt;/<span class="title">tx:method</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">tx:attributes</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">tx:advice</span>&gt;</span>
    <span class="tag">&lt;<span class="title">aop:config</span>&gt;</span>
        <span class="comment">&lt;!-- 切点  --&gt;</span>
        <span class="tag">&lt;<span class="title">aop:pointcut</span> <span class="attribute">expression</span>=<span class="value">"execution(* cn.itcast.oa.service..*Service.*())"</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">aop:pointcut</span>&gt;</span>
        <span class="comment">&lt;!-- 切面 --&gt;</span>
        <span class="tag">&lt;<span class="title">aop:adviser</span> <span class="attribute">advice-ref</span>=<span class="value">"oaAdvice"</span> <span class="attribute">pointcut-ref</span>=<span class="value">"oaPC"</span>&gt;</span><span class="tag">&lt;/<span class="title">aop:adviser</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">aop:config</span>&gt;</span>
    <span class="comment">&lt;!-- 组建扫描--&gt;</span>
    <span class="tag">&lt;<span class="title">context:compoent-scan</span> <span class="attribute">bas-package</span>=<span class="value">"cn.itcast.oa"</span>&gt;</span><span class="tag">&lt;/<span class="title">context:compoent-scan</span>&gt;</span>
    <span class="comment">&lt;!-- 支持注解  --&gt;</span>
    <span class="tag">&lt;<span class="title">context:annotation-config</span>&gt;</span><span class="tag">&lt;/<span class="title">context:annotation-config</span>&gt;</span>
    <span class="comment">&lt;!-- 事务注解驱动 --&gt;</span>
    <span class="tag">&lt;<span class="title">tx:annotation-driver</span> <span class="attribute">transaction-manager</span>=<span class="value">"transactionManager"</span>&gt;</span><span class="tag">&lt;/<span class="title">tx:annotation-driver</span>&gt;</span>
<span class="tag">&lt;/<span class="title">beans</span>&gt;</span>
</pre></td></tr></table></figure>
</li>
<li><p>创建数据库</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="operator"><span class="keyword">create</span> <span class="keyword">database</span> itcastOA <span class="keyword">default</span> <span class="keyword">character</span> <span class="keyword">set</span> utf8;</span>
<span class="operator"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'xiaoming'</span> identified <span class="keyword">by</span> <span class="string">'123'</span>;</span>  <span class="comment">-- 创建一个普通用户</span>
<span class="operator"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> itcast_oa.* <span class="keyword">to</span> itcast@localhost identified <span class="keyword">by</span> <span class="string">"123"</span>;</span>
</pre></td></tr></table></figure>
</li>
<li><p>数据连接参数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>;; TODO
<span class="constant">driverClass</span>=
<span class="constant">jdbcUrl</span>=
<span class="constant">user</span>=
<span class="constant">password</span>=
<span class="constant">initPoolSize</span>=
<span class="constant">maxPoolSize</span>=
minPoolSize
</pre></td></tr></table></figure>
</li>
<li><p>创建包结构</p>
<pre><code> cn.itcast.oa.domain
 cn.itcast.oa.dao
 cn.itcast.oa.service
 cn.itcast.oa.web
 cn.itcast.oa.web.action
 cn.itcast.oa.web.filter
 cn.itcast.oa.web.interceptor
 cn.itcast.oa.web.listener
 cn.itcast.oa.utils
 cn.itcast.oa.base
</code></pre></li>
<li><p>抽取通用DAO</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="code"><pre>package cn.itcast.oa.<span class="keyword">base</span>;
<span class="comment">// 抽取通用DAO</span>
<span class="keyword">public</span> <span class="keyword">interface</span> IBaseDao&lt;T&gt; {
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span>(T entity);
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span>(Long id);
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span>(T entity)
    <span class="keyword">public</span> T <span class="title">findById</span>(Long id);
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">findAll</span>();
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">findByIds</span>(Long[] ids);
}
<span class="comment">// class UserDaoImpl extends BaseDaoImpl&lt;User&gt; implements IUserDao</span>
<span class="keyword">public</span> <span class="keyword">class</span> BaseDaoImpl&lt;T&gt; implements IBaseDao&lt;T&gt; {
    <span class="comment">// 在执行过程中, 获得实体类类型</span>
    Class&lt;T&gt; clazz;
    
    <span class="keyword">public</span> <span class="title">BaseDaoImpl</span>(){
        <span class="comment">// 获得父类类型的泛型</span>
        ParameterziedType genericSuperclass = <span class="keyword">this</span>.getClass().getGenericSuperclass();
        Type[] types = genericSuperclass.getActualTypedArguments();
        <span class="comment">// 获得实体类类型</span>
        clazz = (Class&lt;T&gt;)types[<span class="number">0</span>];
    }

    @Resource
    <span class="keyword">private</span> SessionFactory sessoinFactory;

    <span class="keyword">public</span> Session <span class="title">getSession</span>(){
        <span class="keyword">return</span> sessionFactory.getCurrentSession();
    }

    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span>(T entity){
        getSessoin().save(entity);
    }
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span>(Long id){
        <span class="comment">//先查询, 再删除</span>
        getSession().delete(<span class="keyword">this</span>.findById(id));
    }
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span>(T entity){
        getSessoin().update(entity);
    }
    <span class="keyword">public</span> T <span class="title">findById</span>(Long id){
       <span class="keyword">return</span> <span class="keyword">this</span>.getSession().<span class="keyword">get</span>(clazz, id)
    }
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">findAll</span>(){
        String hql = <span class="string">"from "</span> + clazz.getSimpleName();
        getSession().createQeury(query);
        <span class="keyword">return</span> query.list();
    }
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">findByIds</span>(Long[] ids){
        <span class="keyword">if</span>(ids!=<span class="keyword">null</span> && ids.length &gt;<span class="number">0</span> ){
        String hql = <span class="string">"From "</span> + clazz.getSimpleName() + <span class="string">" where id in (:ids)"</span>;
        Qeury query = getSession().createQuery(hql);
        query.setParameterList(<span class="string">"ids"</span>, ids); <span class="comment">// 为命名参数赋值</span>
        <span class="keyword">return</span> query.list();
        }
        Collections.EMPTY_LIST;
    }
}
</pre></td></tr></table></figure>
</li>
<li><p>抽取通用 Action</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">BaseAction</span>&lt;<span class="title">T</span>&gt; <span class="inheritance"><span class="keyword">extends</span></span> <span class="title">ActionSupport</span> <span class="inheritance"><span class="keyword">implements</span></span> <span class="title">ModelDriver</span>&lt;<span class="title">T</span>&gt; {</span>
    <span class="keyword">protected</span> T model;
    <span class="keyword">public</span> BaseAction(){
        <span class="comment">// 构造方法中实例化模型对象</span>
        ParameterzedTypes superclass = <span class="keyword">this</span>.getClass().getGernericSuperclass();
        Type[] types = superclass.getActualTypedArguments();
        <span class="comment">// 获得实体类类型</span>
        Class&lt;T&gt; clazz = (Class&lt;T&gt;)types[<span class="number">0</span>];
        model = clazz.newInstance();
    }
    <span class="keyword">public</span> T getModel(){
        <span class="keyword">return</span> model;
    }
    <span class="comment">// 将集合属性压入值栈</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> set(String key, List&lt;?&gt; value) {
        ActionContext.getContext().getValueStack().set(key, value);
    }
    <span class="comment">// 将单个属性压入值栈</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> push(Ojbect obj) {
        ActionContext.getContext().push(obj);
    }
}
</pre></td></tr></table></figure>

</li>
</ol>
<h1 id="-3-">系统管理(3)</h1>
<p>抽取实体类: 岗位(Role), 部门(Department), 用户(User)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="keyword">class</span> Role {
    <span class="keyword">private</span> Long id;
    <span class="keyword">private</span> String name;
    <span class="keyword">private</span> String description;
    <span class="keyword">private</span> Set&lt;User&gt; users = <span class="keyword">new</span> HashSet();
}
<span class="keyword">public</span> <span class="keyword">class</span> Department {
    <span class="keyword">private</span> Long id;
    <span class="keyword">private</span> String name;
    <span class="keyword">private</span> String description;
    <span class="keyword">private</span> Department parent;
    <span class="keyword">private</span> Set&lt;Department&gt; children = <span class="keyword">new</span> HashSet();
    <span class="keyword">private</span> Set&lt;User&gt; users = <span class="keyword">new</span> HashSet();
}
<span class="keyword">public</span> <span class="keyword">class</span> User {
    <span class="keyword">private</span> Long id;
    <span class="keyword">private</span> loginName:String
    <span class="keyword">private</span> String name;
    <span class="keyword">private</span> String password;
    <span class="keyword">private</span> String email;
    <span class="keyword">private</span> <span class="keyword">int</span> gender;
    <span class="keyword">private</span> String phoneNumber
    <span class="keyword">private</span> Department department;
    <span class="keyword">private</span> Set&lt;Role&gt; roles = <span class="keyword">new</span> HashSet();
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="code"><pre>&lt;hibernate-mapping&gt;
    &lt;<span class="type">class</span> <span class="property">name</span>=<span class="string">"Role"</span>&gt;
        &lt;<span class="property">id</span> <span class="property">name</span>=<span class="string">"id"</span>&gt;
            &lt;gernerator <span class="type">class</span>=<span class="string">"native"</span>&gt;
            &lt;/gernerator&gt;
        &lt;/<span class="property">id</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"name"</span> <span class="property">length</span>=<span class="string">"32"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"description"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;<span class="keyword">set</span> <span class="property">name</span>=<span class="string">"user"</span> table=<span class="string">"itcast_user_role"</span>&gt;
            &lt;key column=<span class="string">"roleId"</span>&gt;&lt;/key&gt;
            &lt;many-<span class="keyword">to</span>-many <span class="type">class</span>=<span class="string">"user"</span> column=<span class="string">"userId"</span>&gt;&lt;/many-<span class="keyword">to</span>-many&gt;
        &lt;/<span class="keyword">set</span>&gt;
    &lt;/<span class="type">class</span>&gt;

    &lt;<span class="type">class</span> <span class="property">name</span>=<span class="string">"Department"</span> table=<span class="string">"itcast_department"</span>&gt;
        &lt;<span class="property">id</span> <span class="property">name</span>=<span class="string">"id"</span>&gt;
            &lt;gernerator <span class="type">class</span>=<span class="string">"native"</span>&gt;
            &lt;/gernerator&gt;
        &lt;/<span class="property">id</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"name"</span> <span class="property">length</span>=<span class="string">"32"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"description"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        
        &lt;many-<span class="keyword">to</span>-one <span class="property">name</span>=<span class="string">"parent"</span> <span class="type">class</span>=<span class="string">"Department"</span> column=<span class="string">"parentId"</span>&gt;&lt;/many-<span class="keyword">to</span>-one&gt;
        &lt;<span class="keyword">set</span> <span class="property">name</span>=<span class="string">"children"</span>&gt;
            &lt;key column=<span class="string">"parentId"</span>&gt;
            &lt;/key&gt;
            &lt;one-<span class="keyword">to</span>-many <span class="type">class</span>=<span class="string">"Department"</span>/&gt;
        &lt;/<span class="keyword">set</span>&gt;
        &lt;<span class="keyword">set</span> <span class="property">name</span>=<span class="string">"users"</span>&gt;
            &lt;key column=<span class="string">"department"</span>&gt;
            &lt;/key&gt;
            &lt;one-<span class="keyword">to</span>-many <span class="type">class</span>=<span class="string">"User"</span>&gt;&lt;/one-<span class="keyword">to</span>-many&gt;
        &lt;/<span class="keyword">set</span>&gt;
    &lt;/<span class="type">class</span>&gt;
    &lt;<span class="type">class</span> <span class="property">name</span>=<span class="string">"User"</span> table=<span class="string">"itcast_user"</span>&gt;
        &lt;<span class="property">id</span> <span class="property">name</span>=<span class="string">"id"</span>&gt;
            &lt;generator <span class="type">class</span>=<span class="string">"native"</span>&gt; &lt;/generator&gt;
        &lt;/<span class="property">id</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"loginName"</span> <span class="property">length</span>=<span class="string">"32"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"name"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"descrption"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"gender"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"email"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"phoneNumber"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"password"</span>&gt;&lt;/<span class="keyword">property</span>&gt;
        &lt;many-<span class="keyword">to</span>-one <span class="property">name</span>=<span class="string">"department"</span> <span class="type">class</span>=<span class="string">"Department"</span>&gt;&lt;/many-<span class="keyword">to</span>-one&gt;
        &lt;<span class="keyword">set</span> <span class="property">name</span>=<span class="string">"roles"</span> table=<span class="string">"itcast_user_rols"</span>&gt;
            &lt;key column=<span class="string">"userId"</span>&gt;
            &lt;/key&gt;
            &lt;many-<span class="keyword">to</span>-many <span class="type">class</span>=<span class="string">"Role"</span> column=<span class="string">"roleId"</span>&gt;&lt;/many-<span class="keyword">to</span>-many&gt;
        &lt;/<span class="keyword">set</span>&gt;
    &lt;/<span class="type">class</span>&gt;
&lt;/hibernate-mapping&gt;
</pre></td></tr></table></figure>

<h2 id="-">岗位管理</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="code"><pre>@Controller
@Scope(<span class="string">"prototype"</span>)
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleAction</span> <span class="keyword">extends</span> <span class="title">BaseAction</span>&lt;<span class="title">Role</span>&gt; {</span>
    @Resource
    <span class="keyword">private</span> IRoleService roleService;
    <span class="comment">// 查询所有岗位列表</span>
    @Action(value=<span class="string">"role_List"</span> results = {@Results(name=<span class="string">"list"</span>, location=<span class="string">"rolsList.jsp"</span>)})
    <span class="keyword">public</span> String <span class="keyword">list</span>(){
        <span class="keyword">List</span>&lt;Role&gt; roleList = roleService.findAll();
        set(<span class="string">"roleList"</span>, roleList);
        <span class="keyword">return</span> <span class="string">"list"</span>;
    }
    
    @Action(value=<span class="string">"role_delete"</span> results = {@Results(name=<span class="string">"list"</span>, location=<span class="string">"roleList"</span>, type=<span class="string">"redirectAction"</span>)})
    <span class="keyword">public</span> String delete(){
        <span class="keyword">return</span> <span class="string">"toList"</span>;
    }
    
    @Action(value=<span class="string">"role_save"</span> results = {@Results(name=<span class="string">"list"</span>, location=<span class="string">"roleList"</span>, type=<span class="string">"redirectAction"</span>)})
    <span class="keyword">public</span> String save(){
        <span class="keyword">return</span> <span class="string">"toList"</span>;
    }

    <span class="comment">// 跳转到updateUI页面</span>
    <span class="keyword">public</span> String updateUI(){
        Role role = roleService.findById(model.getId);
        push(role);
        <span class="keyword">return</span> <span class="string">"updateUI"</span>;
    }

}

@Service
@Transaction
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl</span> <span class="keyword">implements</span> <span class="title">IRoleService</span> {</span>
    @Resource
    <span class="keyword">private</span> IRoleDao roleDao;
    <span class="comment">// 查询岗位列表</span>
    @Transactional(readOnly=<span class="keyword">true</span>)
    <span class="keyword">public</span> <span class="keyword">List</span>&lt;Role&gt; findAll(){
        roleDao.findAll();
    }
}

<span class="comment">// 岗位管理</span>
@Repository
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleDaoImpl</span> <span class="keyword">extends</span> <span class="title">BaseDao</span>&lt;<span class="title">Role</span>&gt; <span class="keyword">implements</span> <span class="title">IRoleDao</span> {</span>
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="comment">&lt;!-- RoleAction-role_save-validation.xml --&gt;</span>
<span class="tag">&lt;<span class="title">validators</span>&gt;</span>
    <span class="tag">&lt;<span class="title">field</span> <span class="attribute">name</span>=<span class="value">"name"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">field-validator</span> <span class="attribute">type</span>=<span class="value">"requiedstring"</span>&gt;</span>
            <span class="tag">&lt;<span class="title">message</span> <span class="attribute">key</span>=<span class="value">"roleNameNotNull"</span>&gt;</span><span class="tag">&lt;/<span class="title">message</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">field-validator</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">field</span>&gt;</span>
<span class="tag">&lt;/<span class="title">validators</span>&gt;</span>
<span class="comment">&lt;!-- messages.properties --&gt;</span>
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">table</span>&gt;</span>
    <span class="tag">&lt;<span class="title">tr</span>&gt;</span>
        <span class="tag">&lt;<span class="title">th</span>&gt;</span>岗位名称<span class="tag">&lt;/<span class="title">th</span>&gt;</span>
        <span class="tag">&lt;<span class="title">th</span>&gt;</span>描述<span class="tag">&lt;/<span class="title">th</span>&gt;</span>
        <span class="tag">&lt;<span class="title">th</span>&gt;</span>相关操作<span class="tag">&lt;/<span class="title">th</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">tr</span>&gt;</span>
    <span class="tag">&lt;<span class="title">s:iterator</span> <span class="attribute">value</span>=<span class="value">"roleList"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">tr</span>&gt;</span>
            <span class="tag">&lt;<span class="title">td</span>&gt;</span> ${name} <span class="tag">&lt;/<span class="title">td</span>&gt;</span>
            <span class="tag">&lt;<span class="title">td</span>&gt;</span> ${description} <span class="tag">&lt;/<span class="title">td</span>&gt;</span>
            <span class="tag">&lt;<span class="title">td</span>&gt;</span>  <span class="tag">&lt;/<span class="title">td</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">tr</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">s:iterator</span>&gt;</span>
<span class="tag">&lt;/<span class="title">table</span>&gt;</span>
</pre></td></tr></table></figure>

<h2 id="-">部门管理</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre>@Controller
@Scope(<span class="string">"prototype"</span>)
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DepartmentAction</span> <span class="keyword">extends</span> <span class="title">BaseAction</span>&lt;<span class="title">Departemnt</span>&gt;{</span>
    <span class="comment">// 注意返回上一级时的设计</span>
    <span class="keyword">private</span> Long parentId; <span class="comment">// 属性驱动, 上级部门的Id</span>
    
    <span class="comment">// 查询部门列表功能</span>
    <span class="keyword">public</span> String <span class="keyword">list</span>(){
        <span class="keyword">if</span>(parentId == <span class="keyword">null</span>) {
            <span class="comment">// 查询顶级部门列表</span>
            <span class="comment">// hql: from department where parent is null</span>
            <span class="keyword">List</span> <span class="keyword">list</span> = departmentService.findTopTist();
        } <span class="keyword">else</span> {
            <span class="comment">// 查询下级部门</span>
            <span class="comment">// hql: from department where parent.id=:parentId;</span>
            <span class="keyword">list</span> = departmentService.findChildren(parentId);
        }
        
        set(<span class="string">"list"</span>, <span class="keyword">list</span>);
        <span class="keyword">return</span> <span class="keyword">LIST</span>;
    }
    <span class="comment">// 删除上级部门同时删除下级部门, 配置cascade</span>
    <span class="keyword">public</span> String delete(){
        <span class="keyword">if</span>(getParent().getId()!=<span class="keyword">null</span>)parentId = model.getParent().getId();
        <span class="keyword">return</span> TOLIST;
    }
    <span class="comment">// 新建 删除时,要注意传过来 parentId</span>
    <span class="keyword">public</span> String saveUI(){
        <span class="comment">// 准备部门列表数据, 用户填充下拉框</span>
        <span class="comment">// 使用递归, 包装成树形结构, 使用缩进</span>
        <span class="comment">// 空格 替换成 &nbsp;</span>
    }
    <span class="keyword">public</span> String save(){}
    <span class="keyword">public</span> String updateUI(){
        <span class="comment">// 准备部门列表数据, 用户填充下拉框</span>
        <span class="comment">// 使用递归, 包装成树形结构名字</span>
        <span class="comment">// 空格 替换成 &nbsp;</span>
        <span class="comment">// 在修改时展示的不应该是全的树</span>
    }
    <span class="keyword">public</span> String update(){}
}
</pre></td></tr></table></figure>

<h2 id="-">用户管理</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="annotation">@Controller</span>
<span class="annotation">@Scope</span>(<span class="string">"prototype"</span>)
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAction</span> {</span>
    <span class="keyword">private</span> Long departmentId;
    <span class="keyword">private</span> Long[] roleIds ;
    
    <span class="keyword">public</span> String <span class="title">updateUI</span>(){
        <span class="comment">// 准备部门列表, 可以使用 json-lib和ajax, 异步获得</span>
        <span class="comment">// 准备岗位列表</span>
    }
    <span class="keyword">public</span> String <span class="title">save</span>(){
        <span class="comment">// 根据departmentid 和 roleids手动配置;</span>

        <span class="comment">// 某人密码是"1234"</span>
        <span class="comment">// 使用 md5 加密</span>
    }

    <span class="comment">// 初始化密码</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initPassword</span>(){
    }
}
</pre></td></tr></table></figure>

<h3 id="-">用户名重复客户端校验</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript">
    $(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        <span class="comment">// 绑定离焦时间</span>
        $(<span class="string">"#loginName"</span>).blur(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
            <span class="keyword">var</span> v = <span class="keyword">this</span>.value;
            $.post(${contextPath/user_checkLoginName}, {<span class="string">'loginName'</span>: v}, <span class="function"><span class="keyword">function</span><span class="params">(data)</span>{</span>
                <span class="keyword">if</span>(data==<span class="number">1</span>) {
                    <span class="comment">// 当前登陆名字已经存在</span>
                    $(<span class="string">"#showMsg"</span>).html(<span class="string">"当前登陆名已经存在"</span>);
                    $(<span class="string">"#saveBtn"</span>).hide();
                } <span class="keyword">else</span> {
                    $(<span class="string">"#showMsg"</span>).html(<span class="string">"当前输入名可以使用"</span>);
                    $(<span class="string">"#saveBtn"</span>).show();
                }
            })
        });
    })
</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="comment">// UserAction</span>
<span class="keyword">public</span> <span class="built_in">String</span> checkLoginName(){
    <span class="built_in">String</span> loginName <span class="subst">=</span> model<span class="built_in">.</span>getLoginName()<span class="built_in">.</span>trim();
    <span class="built_in">List</span><span class="subst">&lt;</span>User<span class="subst">&gt;</span> <span class="built_in">list</span> <span class="subst">=</span> userService<span class="built_in">.</span>findByLoginName(loginName);
    response<span class="built_in">.</span>setContentType(<span class="string">"text/html;charset=utf-8"</span>);
    <span class="built_in">String</span> flag <span class="subst">=</span> <span class="number">0</span>;
    <span class="keyword">if</span>(<span class="built_in">list</span><span class="subst">!=</span><span class="built_in">null</span> <span class="subst">&&</span> <span class="built_in">list</span><span class="built_in">.</span>size()<span class="subst">&gt;</span><span class="number">0</span>) {
        <span class="comment">// 当前登录名已经存在</span>
        flag <span class="subst">=</span> <span class="string">"1"</span>
    }
    out<span class="built_in">.</span>print(flag);
    <span class="keyword">return</span> <span class="literal">NONE</span>;
}
</pre></td></tr></table></figure>

<h1 id="-">权限管理</h1>
<p>角色就是权限的集合, 角色关联权限.
在进行任何一个操作之前, 先判断用户是否有权限</p>
<h2 id="-">权限实体</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="keyword">class</span> Privilege {
    <span class="keyword">private</span> Long id;
    <span class="keyword">private</span> String name;
    <span class="keyword">private</span> String url;        <span class="comment">//权限对应的访问url地址</span>
    <span class="keyword">private</span> Privilege parent;  <span class="comment">// 对应的上级权限</span>
    <span class="keyword">private</span> Set&lt;Privilege&gt; children = <span class="keyword">new</span> HashSet();
    <span class="keyword">private</span> Set&lt;Role&gt; roles = <span class="keyword">new</span> HashSet();
}

<span class="keyword">public</span> <span class="keyword">class</span> Role {
    <span class="keyword">private</span> Set&lt;Privilege&gt; privileges = <span class="keyword">new</span> HashSet();
}
</pre></td></tr></table></figure>

<h3 id="-">初始化数据</h3>
<figure class="highlight sql:"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre>&gt; source privilege<span class="class">.sql</span>; -- 导入初始化数据
&gt; insert into <span class="function">user(loginName, name, password)</span> <span class="function">values(<span class="string">"admin"</span>, <span class="string">"超级用户"</span>, <span class="function">md5(admin)</span>)</span>;
</pre></td></tr></table></figure>

<h3 id="-">显示层</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="keyword">class</span> RoleAction {
    <span class="keyword">public</span> String <span class="title">setPrivilegeUI</span>() {
        <span class="comment">// 根据id 查询当前设置权限的角色</span>
        Role role = roleService.findById();
        push(role);

        <span class="comment">// 准备权限列表数据</span>
        <span class="comment">// 使用 ul li 可以来展示树形结构</span>
        <span class="comment">// 配合使用 jquery TreeView 插件</span>
        List privileges = privilegeService.findTopPrivilege();

        <span class="comment">// 设置privilegesIds属性驱动的值, 用于页面回显</span>
        <span class="keyword">return</span> <span class="string">"setPrivilegeUI"</span>;
    }
    
    <span class="keyword">private</span> Long[] privilegeIds;
    <span class="keyword">public</span> String <span class="title">setPrivilege</span>(){
        Role role = roleService.findById();
        <span class="keyword">if</span>(privilegeIds != <span class="keyword">null</span> && privilegeIds.length&gt;<span class="number">0</span>) {
            List privilegeList = priprivilegeService.findByIds(privilegeIds);
        } <span class="keyword">else</span> {
            
        }
        
        <span class="keyword">return</span> TOLIST;
    }
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="comment">&lt;!-- set order-by=id 设置权限树有序  --&gt;</span>
<span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript">
<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
    $(<span class="string">"#root"</span>).treeview();
    <span class="comment">//为复选框绑定事件</span>
    <span class="comment">// 当选中或取消某个权限时, 同时选中或者取消下级权限</span>
    $(<span class="string">"input[name=privilegeIds]"</span>).click(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        $(<span class="keyword">this</span>).siblings(<span class="string">"ul"</span>).find(<span class="string">"input"</span>).attr(<span class="string">'checked'</span>, <span class="keyword">this</span>.checked);
    });
    <span class="comment">// 当选中某个权限时, 同时选中上级选项</span>
    <span class="keyword">if</span>(<span class="keyword">this</span>.checked){
        $(<span class="keyword">this</span>).parents(<span class="string">"li"</span>).children(<span class="string">"input"</span>).attr(<span class="string">'checked'</span>, <span class="literal">true</span>);
    } <span class="keyword">else</span> {
        <span class="keyword">if</span>($(<span class="keyword">this</span>).parent(<span class="string">'li'</span>).siblings(<span class="string">'li'</span>).children(<span class="string">'input:checked'</span>).size()==<span class="number">0</span>){
            $(<span class="keyword">this</span>).parent().parent().siblings(<span class="string">"input"</span>).attr(<span class="string">"checked"</span>, <span class="literal">false</span>);
        }
    }
    <span class="comment">// 当取消某个权限时, 如果兄弟权限没有选中, 取消上级选项</span>
}
</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"root"</span>&gt;</span>
   <span class="tag">&lt;<span class="title">s:iterator</span> <span class="attribute">value</span>=<span class="value">"children"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">li</span>&gt;</span>
            <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"abc"</span>/&gt;</span>
            <span class="comment">&lt;!--  label的案件效果和input绑定--&gt;</span>
            <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"abc"</span>&gt;</span><span class="tag">&lt;/<span class="title">label</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">li</span>&gt;</span>
   <span class="tag">&lt;/<span class="title">s:iterator</span>&gt;</span>
<span class="tag">&lt;/<span class="title">ul</span>&gt;</span>
</pre></td></tr></table></figure>

<h1 id="-">应用主页面</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="annotation">@Controller</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span> {</span>
    <span class="keyword">public</span> String <span class="title">index</span>(){
        <span class="keyword">return</span> <span class="string">"index"</span>;
    }
    <span class="keyword">public</span> String <span class="title">top</span>(){}
    <span class="keyword">public</span> String <span class="title">left</span>(){}
    <span class="keyword">public</span> String <span class="title">right</span>(){}
    <span class="keyword">public</span> String <span class="title">bottom</span>(){}
}
</pre></td></tr></table></figure>

<h1 id="-">用户登陆和注销</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="comment">// UserAction</span>
<span class="keyword">public</span> String <span class="title">login</span>(){
    User user = userService.login(model);
    <span class="keyword">if</span>(user != <span class="keyword">null</span>) {
        session().put(key, <span class="keyword">value</span>);
    } <span class="keyword">else</span> {
        <span class="keyword">this</span>.addActionError(<span class="string">"用户名或者密码不正确"</span>);
        <span class="keyword">return</span> <span class="string">"loginUI"</span>;
    }
    <span class="keyword">return</span> <span class="string">"home"</span>;
}

<span class="keyword">public</span> String <span class="title">logout</span>(){
    session.remove(<span class="string">"loginUser"</span>);
    <span class="keyword">return</span> <span class="string">"loginUI"</span>;
}

<span class="comment">// UserService</span>
<span class="keyword">public</span> User <span class="title">login</span>(){
    model.setPassword(md5(model.getPassword()));
    <span class="comment">// 根据用户名和密码查询用户</span>
    <span class="keyword">return</span> userDao.findUserByLoginNameAndPassword()
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>&lt;<span class="keyword">global</span>-<span class="constant">result</span>&gt;
    &lt;<span class="constant">result</span> <span class="property">name</span>=<span class="string">"loginUI"</span>&gt;
        index.jsp
    &lt;/<span class="constant">result</span>&gt;
&lt;/<span class="keyword">global</span>-<span class="constant">result</span>&gt;
</pre></td></tr></table></figure>

<h1 id="-">使用权限</h1>
<p>左侧菜单数据从数据库中获取，编写监听器, 当项目启动时加载权限数据, 将权限数据放入 <code>application</code> 作用域</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="comment">// 在web.xml配置监听器</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAIniitListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> {</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span>(ServletContextEvent sce) {
        <span class="comment">// 获得 spring 工厂对象</span>
        <span class="comment">// 方式一: application.getAttribute(WebApplicationContextUtil.ROOT_WEB_APPLICATION_CONTEXT);</span>
        WebApplicationContext cxt =
            WebApplicationContextUtil.getWebApplicationContext(sce.getServletContext());
        IPrivilegeService ps = cxt.getBean(<span class="string">"privilegeService"</span>);
        <span class="comment">// 从工厂中获得一个权限的Service对象</span>
        List&lt;Privilege&gt; privilegeTopList = ps.findTopList();
        <span class="comment">// 将权限数据放入作用域, lazy要设置为 false</span>
        sce.getServletContext().setAttribute(<span class="string">"privilegeTopList"</span>, privilegeTopList);

        <span class="comment">//需要全部权限对应的url</span>
        List&lt;String&gt; allUrls = ps.findAllUrls();
        sce.getServletContext().setAttribute(<span class="string">"allUrls"</span>, allUrls);        
    }
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span>(ServletContextEvent sce){}
}

<span class="comment">// User.class, role privileges都要立即加载</span>
<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPrivilegeByName</span>(String privilegeName){
    <span class="keyword">if</span>(isAdmin()) <span class="keyword">return</span> <span class="keyword">true</span>;
    <span class="keyword">for</span>(Role r: roles) {
       Set&lt;Privilege&gt; privileges = r.getPrivileges();
       <span class="keyword">for</span>(Privilege privilege : privileges) {
           <span class="keyword">if</span>(privilegeName.equals(privilege.getName())) {
               <span class="keyword">return</span> <span class="keyword">true</span>;
           }
       }
    }
    <span class="keyword">return</span> <span class="keyword">false</span>;
}

<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAdmin</span>(){
    <span class="keyword">return</span> <span class="string">"admin"</span>.equals(loginName);
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="comment">&lt;!-- 侧边栏根据权限显示 --&gt;</span>
<span class="tag">&lt;<span class="title">s:iterator</span> <span class="attribute">value</span>=<span class="value">"#application.privilegeTopList"</span>&gt;</span>
     <span class="comment">&lt;!-- 使用 ongl表达式调用对象方法 --&gt;</span>
     <span class="tag">&lt;<span class="title">s:if</span> <span class="attribute">test</span>=<span class="value">"#session.loginUser.checkPrivilegeByName(name)"</span>&gt;</span>
     <span class="tag">&lt;/<span class="title">s:if</span>&gt;</span>
<span class="tag">&lt;/<span class="title">s:iterator</span>&gt;</span>
</pre></td></tr></table></figure>

<h2 id="-">权限拦截器</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="code"><pre><span class="xml"><span class="php"><span class="comment">// 在struts中注册 interceptor</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckPrivilegeInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractInterceptor</span> {</span>
    <span class="keyword">public</span> String intercept(ActionInvocation ai) {
        ActionProxy actionProxy = ai.getProxy();  <span class="comment">// 获得当前 Action的代理对象</span>
        
        String <span class="keyword">namespace</span> = <span class="title">actionProxy</span>.<span class="title">getNamespace</span>();
        String actionName = actionProxy.getActionName();
        
        String url = <span class="keyword">namespace</span> + <span class="title">actionName</span>;
        <span class="comment">// 如果有UI结尾的去掉</span>
        <span class="keyword">if</span>(url.endsWith(<span class="string">"UI"</span>)) {
            url.subString(<span class="number">0</span>, url.length()-<span class="number">2</span>);
        }
        
        User user = ActionContext.getSession().get(<span class="string">"loginUser"</span>);
        <span class="comment">//如果用户没有登陆</span>
        <span class="keyword">if</span>(user == <span class="keyword">null</span>) {
            <span class="comment">// 如果用户访问的是登陆页面,方向</span>
            <span class="keyword">if</span>(<span class="string">"user_login"</span>.equals(url)) {
                <span class="keyword">return</span> ai.invoke();
            } 
            <span class="comment">// 如果用户访问的不是登陆, 跳转到登陆页面</span>
            <span class="keyword">return</span> <span class="string">"loginUI"</span>;
        } <span class="keyword">else</span> {
            <span class="comment">// 如果用户已经登陆</span>
            <span class="keyword">List</span>&lt;String&gt; allUrls = servletContext().getAttribute(<span class="string">"allUrls"</span>);
            <span class="comment">// 如果当前访问的功能不需要控制</span>
            <span class="keyword">if</span>(!allUrls.contains(url)) <span class="keyword">return</span> ai.invoke();
            
            boolean hasPrivilege = usesr.checkPrivilegeByUrl(url);
            <span class="comment">// 如果用户有权限</span>
            <span class="keyword">if</span>(hasPrivilege) <span class="keyword">return</span> ai.invoke();
            <span class="comment">// 如果用户没有,掉转到没有权限的提示页面</span>
            <span class="keyword">return</span> <span class="string">"noPrivilege"</span>;
        }

        <span class="keyword">return</span> <span class="keyword">null</span>;
    }
}</span></span>
</pre></td></tr></table></figure>

<h2 id="-">页面嵌套显示</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="comment">// index.jsp</span>
<span class="keyword">if</span>(<span class="keyword">window</span>.<span class="keyword">parent</span> != <span class="keyword">window</span>) {
    <span class="keyword">window</span>.<span class="keyword">parent</span>.location.href = <span class="string">"index.jsp"</span>
}
</pre></td></tr></table></figure>

<h1 id="-">个人信息</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> itcast_privilege (<span class="number">21</span>, <span class="string">"个人设置"</span>, <span class="keyword">null</span>);</span>
<span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> itcast_privilege (<span class="number">22</span>, <span class="string">"个人信息"</span>, <span class="number">21</span>);</span>
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="comment">// userAction</span>
<span class="comment">// 设置个人信息</span>
<span class="keyword">private</span> File resource;
<span class="keyword">private</span> String resourceFileName;
<span class="keyword">private</span> resourceContentType;

<span class="keyword">public</span> String <span class="title">setUserInfo</span>(){
    <span class="keyword">if</span>(model.getId()==<span class="keyword">null</span>) {
        <span class="comment">// 跳转的设置页面</span>
        <span class="comment">// 在是视图层, user 中的集合还没有初始化, opensessionInview,</span>
        <span class="comment">// 在一次请求中才生效</span>
        User user = session.<span class="keyword">get</span>(<span class="string">"loginUser"</span>);
        push( userService.findById(user.getId()) );
        <span class="keyword">return</span> <span class="string">"SetUserInfo"</span>
    } <span class="keyword">else</span> {
        <span class="comment">// 设置信息</span>
        User user = userService.findById(model.getId());
        <span class="comment">// 可以抽到 BaseAction, 文件夹按日期存储文件</span>
        <span class="comment">// 获得uploadFiles的绝对磁盘路径</span>
        String realPath = servletContext.getRealPath(<span class="string">"uploadFiles"</span>);
        <span class="keyword">int</span> position = resourceFileName.lastIndexOf(<span class="string">"."</span>);
        String suffix = resourceFileName.subString(position);

        String filename = UUID.randomUUID().toString() + suffix;

        File destFile = <span class="keyword">new</span> File(realPath + File.separator+ filename);
        resource.renameto(destFile);
        user.setSavePath(filename);
        userService.update(user);
        <span class="keyword">return</span> <span class="string">"toSetUserInfoUI"</span>;
    }
}
<span class="comment">// User</span>
class User {
    <span class="keyword">private</span> String savePath;
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="comment">&lt;!-- 文件上传 --&gt;</span>
<span class="tag">&lt;<span class="title">form</span> <span class="attribute">enctype</span>=<span class="value">"multipart/form-data"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"file"</span> <span class="attribute">name</span>=<span class="value">"resource"</span>/&gt;</span>
<span class="tag">&lt;/<span class="title">form</span>&gt;</span>
</pre></td></tr></table></figure>

<h2 id="struts-">struts文件下载</h2>
<ul>
<li>Action中提供 <code>InputStream inputName</code></li>
<li>配置结果集<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">result</span> <span class="attribute">name</span>=<span class="value">"stream"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">param</span> <span class="attribute">name</span>=<span class="value">"inputName"</span>&gt;</span><span class="tag">&lt;/<span class="title">param</span>&gt;</span>
    <span class="tag">&lt;<span class="title">param</span> <span class="attribute">name</span>=<span class="value">"contentType"</span>&gt;</span><span class="tag">&lt;/<span class="title">param</span>&gt;</span>
    <span class="tag">&lt;<span class="title">param</span> <span class="attribute">name</span>=<span class="value">"contentDisposition"</span>&gt;</span><span class="tag">&lt;/<span class="title">param</span>&gt;</span>
<span class="tag">&lt;/<span class="title">result</span>&gt;</span>
</pre></td></tr></table></figure>

</li>
</ul>
<h1 id="-">论坛管理</h1>
<ol>
<li>提取实体, 版块(form), 主题(Topic), 回复(Reply);
帖子类型, 普通帖子, 精华帖, 置顶帖, 热门帖;
不同类型的帖子会影响列表排序<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="comment">// FormManagerAction, 重写Dao, findAll按position排序</span>
<span class="keyword">public</span> <span class="keyword">class</span> Form {
    Long id;
    String name;
    String description;
    <span class="keyword">int</span> position = <span class="number">0</span>; <span class="comment">// 默认为0, 在新建时等于id的值</span>
    Set&lt;Topic&gt; topics;
    <span class="comment">// 提高检索效率</span>
    Int topicCount; <span class="comment">// 主题数量</span>
    Int articleCount; <span class="comment">// 文章数量(回复数)</span>
    Topic lastTopic;   <span class="comment">// 最后发表主题</span>
}

<span class="keyword">public</span> <span class="keyword">class</span> Topic {
    Long id;
    String title;
    String content;
    <span class="keyword">int</span> type;
    User author;  <span class="comment">// 多对一</span>
    Date postTime;
    String ip;
    Date lastUpdateTime; <span class="comment">// 针对主题最后回复时间</span>
    Set&lt;Reply&gt; replies;
    <span class="comment">// 提高检索效率</span>
    Int replyCount;
    Reply lastReply;
}

<span class="keyword">public</span> <span class="keyword">class</span> Reply {
    Long id;
    String content;
    Date postTime;
    User author;
    String ip;
    Int deleted;
    Topic topic;
}
</pre></td></tr></table></figure>

</li>
</ol>
<h2 id="-">论坛管理模块</h2>
<p>论坛版块管理, 添加, 删除, 上移下移</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>class FormManagerAction{}
<span class="comment">// 上移</span>

<span class="comment">// Service</span>
<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">moveUp</span>(Long id) {
    <span class="comment">// select * from form where position &lt; :up desc limit 0,1</span>
    <span class="comment">// 相互交换位置信息</span>
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>&lt;s:<span class="keyword">if</span> test=<span class="string">"#s.first"</span>&gt; 上移 &lt;/s:<span class="keyword">if</span>&gt;
</pre></td></tr></table></figure>

<h2 id="-">论坛模块</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre>
class FormAction {
    <span class="comment">// 排序按照 position</span>
    <span class="comment">// `form/list.jsp`</span>
    <span class="comment">// 版块列表</span>
    <span class="keyword">public</span> String <span class="title">list</span>(){}

    <span class="comment">// 主题列表</span>
    <span class="comment">// 需要排序: 置顶帖在最上方, 剩下的按时间降序排序</span>
    <span class="comment">// select * from itcast_topic order by (case type when 2 then 2 else 1 end) desc, postTime desc;</span>
    <span class="comment">// 注意 order by type desc, postTime desc 区别</span>
    <span class="keyword">public</span> String <span class="title">show</span>(){
        <span class="comment">// 根据版块id查询版块信息</span>
        Form form = formManagerService.findById(model.getId);
        <span class="comment">// 根据 版块id查询主题列表</span>
        List topicList = topicService.findTopicListByForum(model);
        <span class="keyword">set</span>(<span class="string">"topicList"</span>, topicList);
        <span class="keyword">return</span> <span class="string">"formShow"</span>;
    }
}
</pre></td></tr></table></figure>

<h2 id="-">发表主题</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicAction</span> <span class="keyword">extends</span> <span class="title">BaseAction</span>{</span>
    <span class="keyword">private</span> Long forumId;
    
    <span class="keyword">public</span> String <span class="title">saveUI</span>(){
        Forum form = findById(forumId);
        push(form);
    }

    <span class="keyword">public</span> String <span class="title">save</span>(){
        Forum form = findById(forumId);
        model.setForum(forum);
        model.setAuthor(getCurrentUser());
        model.setIp(getIpAddress()); <span class="comment">//request.getRemoteAddress();</span>
        model.setPostTime(<span class="keyword">new</span> Date());
        model.setLastUpdateTime(model.getPostTime());
        model.setReplyCount(<span class="number">0</span>);
        model.setType(<span class="number">0</span>);
        
        topicService.save(model);
        <span class="keyword">return</span> <span class="string">"toTopicList"</span>;
    }
}

<span class="comment">// topicService</span>
<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span>(Topic model) {
    topicDao.save(model);
    Forum forum = model.getforum();
    <span class="comment">// 版块主题</span>
    forum.setTopicCount(forum.getTopicCount() + <span class="number">1</span>);
    <span class="comment">// 版块文章 </span>
    forum.setArticleCount(forum.getArticleCount() + <span class="number">1</span>);
    forum.setLastTopic(model);
}
</pre></td></tr></table></figure>

<h3 id="ckeditor-">CKEditor编辑内容</h3>
<p>使用 ckEditor 插件内容编辑器</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="tag">&lt;textarea id='editor&gt;</span>
<span class="tag">&lt;/textarea&gt;</span>
<span class="tag">&lt;script&gt;</span>
<span class="keyword">CKEDITOR</span>.repalce('editor', {});
<span class="tag">&lt;/script&gt;</span>
</pre></td></tr></table></figure>

<h2 id="-">显示单个主题(回复列表)</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="comment">// TopicAction</span>
<span class="keyword">public</span> String <span class="title">show</span>(){
    Topic topic = topicService.findById(model.getId);
    push(topic);
    <span class="comment">// 根据主题查询回复列表, order by postTime asc</span>
    List replyList = findReplyListByTopic(model.getId());
    <span class="keyword">set</span>(<span class="string">"replyList"</span>, replyList);
    
    <span class="keyword">return</span> <span class="string">"topicshow"</span>;
}
</pre></td></tr></table></figure>

<h2 id="-">回复功能</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="comment">// ### 快速回复功能 ###</span>
<span class="keyword">public</span> <span class="keyword">class</span> ReplyAction {
    <span class="keyword">private</span> Long topicId;
    <span class="comment">// 针对某个主题, 快速回复</span>
    <span class="keyword">public</span> String <span class="title">save</span>(){
        Topic topic = topicService.findById(topicId);
        model.setTopic(topic);
        model.setAuthor(getCurrentUser());
        model.setDeleted(<span class="number">0</span>);
        model.setIp(getIpAddress());
        model.setPostTime(<span class="keyword">new</span> Date());

        replyService.save(model);
        <span class="keyword">return</span> <span class="string">"toTopicShow"</span>;
    }
    <span class="comment">//普通回复(单页)</span>
    <span class="keyword">public</span> String <span class="title">saveUI</span>(){
        Topic topic = topicService.findById(model.getId());
        push(topic);
        <span class="keyword">return</span> <span class="string">"SAVEUI"</span>;
    }
}
<span class="comment">// replyService</span>
<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span>(Reply mode) {
    replyDao.save(model);
    Topic topic = model.getTopic();
    Forum forum = topic.getForum();
    topic.setLastUpdateTime(model.getPostTime());
    topic.getReplyCount(topic.setReplyCount() + <span class="number">1</span>);
    topic.setLastReply(model);
    <span class="comment">// 文章数+1</span>
    forum.setArticleCount(aticalAcount + <span class="number">1</span>);
}
</pre></td></tr></table></figure>

<h2 id="-">分页</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span class="comment">// 封装分页信息</span>
<span class="keyword">public</span> <span class="keyword">class</span> PageBean {
   <span class="comment">// 页面传递参数</span>
   <span class="keyword">private</span> <span class="keyword">int</span> currentPage; <span class="comment">// 当前页码 </span>
   <span class="keyword">private</span> <span class="keyword">int</span> pageSize;  <span class="comment">// 每页显示记录数</span>
   <span class="comment">// 查询数据库获得</span>
   <span class="keyword">private</span> <span class="keyword">int</span> recordCount; <span class="comment">// 总记录数</span>
   <span class="keyword">private</span> List recorderList;

   <span class="keyword">private</span> <span class="keyword">int</span> pageCount;  <span class="comment">// 总页数</span>
   <span class="keyword">private</span> <span class="keyword">int</span> beginPageIndex; 
   <span class="keyword">private</span> <span class="keyword">int</span> endPageIndex;

    <span class="keyword">public</span> <span class="title">PageBean</span>(){}
    <span class="keyword">public</span> <span class="title">PageBean</span>(<span class="keyword">int</span> currentPage, <span class="keyword">int</span> pageSize, <span class="keyword">int</span> recordCount, List recorderList){
        <span class="comment">// 计算总页数</span>
        <span class="keyword">this</span>.pageCount = (<span class="keyword">this</span>.recordCount + <span class="keyword">this</span>.pageSize - <span class="number">1</span>)/pageSize;
        <span class="comment">// 计算开始索引和结束索引</span>
        <span class="keyword">if</span>(tihs.pageCount &lt;= <span class="number">10</span>) {
            <span class="keyword">this</span>.beginPageIndex = <span class="number">1</span>;
            <span class="keyword">this</span>.endPageIndex = <span class="keyword">this</span>.pageCount
        } <span class="keyword">else</span> {
            <span class="keyword">this</span>.beginPageIndex = <span class="keyword">this</span>.currentPage - <span class="number">4</span>;
            <span class="keyword">this</span>.endPageIndex = <span class="keyword">this</span>.currentPage + <span class="number">5</span>;
            <span class="keyword">if</span>(<span class="keyword">this</span>.beginPageIndex &lt; <span class="number">1</span>) {
                beginPageIndex = <span class="number">1</span>;
                endPageIndex = <span class="number">10</span>
            }
            <span class="keyword">if</span>(endPageIndex &gt; pageCount) {
                endPageIndex = pageCount;
                beginPageIndex = endPageIndex - <span class="number">9</span>;
            }
        }
    }
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="comment">// topicAction</span>
<span class="comment">// BaseAction{ private int currentPage } // 属性驱动当前页码</span>
<span class="comment">// 使用 form 表单提交分页信息(因为表单还有其他信息, 如排序条件, 过滤条件)</span>
<span class="keyword">public</span> String <span class="title">show</span>(){
    push(topic);

    PageBean pb = replyService.findReplyListByTopic(model, currentPage);
    push(pb);
    <span class="keyword">return</span> <span class="string">"topicShow"</span>;
}
<span class="comment">// 手动配置 配置 pagesize</span>
<span class="comment">// &lt;context:property-palceholder loacation="classpath:jdbc.properties,classpath:pageSize.properties"&gt;</span>
<span class="comment">// &lt;/context:property-palceholder&gt;</span>
</pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/传智播客/">传智播客</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://zhpooer.github.io/2014/06/20/传智播客-oa系统/" data-title="传智播客-OA系统 | Poe&#39;s World" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/06/22/scala培训monad/" title="scala培训monad">
  <strong>PREVIOUS:</strong><br/>
  <span>
  scala培训monad</span>
</a>
</div>


<div class="next">
<a href="/2014/06/18/photoshop钢笔工具/"  title="photoshop钢笔工具">
 <strong>NEXT:</strong><br/> 
 <span>photoshop钢笔工具
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">1.</span> <span class="toc-text">入门</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">1.1.</span> <span class="toc-text">整体设计</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">2.</span> <span class="toc-text">搭建开发环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-3-"><span class="toc-number">3.</span> <span class="toc-text">系统管理(3)</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">3.1.</span> <span class="toc-text">岗位管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">3.2.</span> <span class="toc-text">部门管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">3.3.</span> <span class="toc-text">用户管理</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-"><span class="toc-number">3.3.1.</span> <span class="toc-text">用户名重复客户端校验</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">4.</span> <span class="toc-text">权限管理</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">4.1.</span> <span class="toc-text">权限实体</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-"><span class="toc-number">4.1.1.</span> <span class="toc-text">初始化数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-"><span class="toc-number">4.1.2.</span> <span class="toc-text">显示层</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">5.</span> <span class="toc-text">应用主页面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">6.</span> <span class="toc-text">用户登陆和注销</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">7.</span> <span class="toc-text">使用权限</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.1.</span> <span class="toc-text">权限拦截器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.2.</span> <span class="toc-text">页面嵌套显示</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">8.</span> <span class="toc-text">个人信息</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#struts-"><span class="toc-number">8.1.</span> <span class="toc-text">struts文件下载</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">9.</span> <span class="toc-text">论坛管理</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.1.</span> <span class="toc-text">论坛管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.2.</span> <span class="toc-text">论坛模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.3.</span> <span class="toc-text">发表主题</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ckeditor-"><span class="toc-number">9.3.1.</span> <span class="toc-text">CKEditor编辑内容</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.4.</span> <span class="toc-text">显示单个主题(回复列表)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.5.</span> <span class="toc-text">回复功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">9.6.</span> <span class="toc-text">分页</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/AJAX/" title="AJAX">AJAX<sup>1</sup></a></li>
		
			<li><a href="/tags/Akka/" title="Akka">Akka<sup>1</sup></a></li>
		
			<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
		
			<li><a href="/tags/DOM/" title="DOM">DOM<sup>2</sup></a></li>
		
			<li><a href="/tags/EL表达式/" title="EL表达式">EL表达式<sup>1</sup></a></li>
		
			<li><a href="/tags/HBase/" title="HBase">HBase<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>2</sup></a></li>
		
			<li><a href="/tags/HttpSession/" title="HttpSession">HttpSession<sup>1</sup></a></li>
		
			<li><a href="/tags/IO/" title="IO">IO<sup>1</sup></a></li>
		
			<li><a href="/tags/Illustrator/" title="Illustrator">Illustrator<sup>3</sup></a></li>
		
			<li><a href="/tags/JSP/" title="JSP">JSP<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaBean/" title="JavaBean">JavaBean<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>1</sup></a></li>
		
			<li><a href="/tags/Mybatis/" title="Mybatis">Mybatis<sup>1</sup></a></li>
		
			<li><a href="/tags/NoSql/" title="NoSql">NoSql<sup>1</sup></a></li>
		
			<li><a href="/tags/SASS/" title="SASS">SASS<sup>1</sup></a></li>
		
			<li><a href="/tags/SAX/" title="SAX">SAX<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletRequest/" title="ServletRequest">ServletRequest<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletResponse/" title="ServletResponse">ServletResponse<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://zhpooer.github.io" target="_blank" title="zhpooer">zhpooer</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"zhpoooer"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
