
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>传智播客day58-Mybatis提高 | Poe&#39;s World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zhpooer">
    
    <meta name="description" content="1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
public class User{
    id: Int;
    username: String;
    birthday: Date">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="Poe&#39;s World" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Poe&#39;s World" title="Poe&#39;s World"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Poe&#39;s World">Poe&#39;s World</a></h1>
				<h2 class="blog-motto">竹杖芒鞋轻胜马，一蓑烟雨任平生</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/english-monthly">英语角</a></li>
					
						<li><a href="/about">关于</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:zhpooer.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/07/16/传智播客day58-mybatis提高/" title="传智播客day58-Mybatis提高" itemprop="url">传智播客day58-Mybatis提高</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://zhpooer.github.io" title="zhpooer">zhpooer</a>
    </p>
  <p class="article-time">
    <time datetime="2014-07-16T01:09:13.000Z" itemprop="datePublished">7月 16 2014</time>
    更新日期:<time datetime="2014-07-19T23:43:16.000Z" itemprop="dateModified">7月 20 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">1.</span> <span class="toc-text">延迟加载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-sql"><span class="toc-number">2.</span> <span class="toc-text">动态 SQL</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#if"><span class="toc-number">2.1.</span> <span class="toc-text">if</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#where"><span class="toc-number">2.2.</span> <span class="toc-text">where</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#foreach"><span class="toc-number">2.3.</span> <span class="toc-text">foreach</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#set"><span class="toc-number">2.4.</span> <span class="toc-text">set</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#sql-"><span class="toc-number">3.</span> <span class="toc-text">Sql 片段</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">4.</span> <span class="toc-text">缓存</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">4.1.</span> <span class="toc-text">一级缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">4.2.</span> <span class="toc-text">二级缓存</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-"><span class="toc-number">4.2.1.</span> <span class="toc-text">配置二级缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ehcache-"><span class="toc-number">4.2.2.</span> <span class="toc-text">Ehcache 配置</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#mybatis-springmvc-"><span class="toc-number">5.</span> <span class="toc-text">Mybatis 和 SpringMVC 整合</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-dao-"><span class="toc-number">5.1.</span> <span class="toc-text">方式一 编写 dao 方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-mapper-bean"><span class="toc-number">5.2.</span> <span class="toc-text">方式二 mapper bean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-mapper-"><span class="toc-number">5.3.</span> <span class="toc-text">方式三 mapper 注解</span></a></li></ol>
		</div>
		
		<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre>public class User{
    id<span class="value">: Int;</span>
    username<span class="value">: String;</span>
    birthday<span class="value">: Date;</span>
    sex<span class="value">: Int;</span>
    <span class="tag">address</span><span class="value">: String;</span>
    detail<span class="value">: String;</span>
    score<span class="value">: Float;</span>
    orders<span class="value">:List;</span>
}
public class <span class="attribute">Order</span> {
    id<span class="value">:Int;</span>
    user<span class="value">:User;</span>
    orderNumber<span class="value">:String;</span> <span class="comment">// 订单号</span>
    orderDetails<span class="value">: List;</span>
}
public class OrderDetail {
    id<span class="value">:Int;</span>
    <span class="attribute">order</span><span class="value">:Order;</span>
    item<span class="value">:Item;</span>
    num<span class="value">:Int;</span>n
    itemPrice<span class="value">:Float;</span>
}

public class Item {
    name<span class="value">:String;</span>
    price<span class="value">:Float;</span>
    detail<span class="value">:String;</span>
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
</pre></td><td class="code"><pre><span class="comment">&lt;!-- 一对一查询 --&gt;</span>
<span class="comment">&lt;!-- 订单用户关联 --&gt;</span>
<span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"findOrdersUsers"</span> <span class="attribute">resultMap</span>=<span class="value">"userOrderMap"</span>&gt;</span>
    select orders.*, user.username, user.sex, user.address
    from orders, user where orders.user_id = user.id;
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>
<span class="tag">&lt;<span class="title">resultMap</span> <span class="attribute">id</span>=<span class="value">"userOrderMap"</span> <span class="attribute">type</span>=<span class="value">"order"</span>&gt;</span>
    <span class="comment">&lt;!-- order信息  --&gt;</span>
    <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"id"</span>/&gt;</span>
    <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"user_id"</span> <span class="attribute">column</span>=<span class="value">"user_id"</span>&gt;</span> <span class="tag">&lt;/<span class="title">result</span>&gt;</span>
    <span class="comment">&lt;!-- 用户信息 --&gt;</span>
    <span class="comment">&lt;!-- 将用户信息封装成一个user对象 --&gt;</span>
    <span class="tag">&lt;<span class="title">association</span> <span class="attribute">property</span>=<span class="value">"user"</span> <span class="attribute">javaType</span>=<span class="value">"po.User"</span>&gt;</span>
        <span class="comment">&lt;!-- 指定user表的id  --&gt;</span>
        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"user_id"</span>&gt;</span><span class="tag">&lt;/<span class="title">id</span>&gt;</span>
        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"username"</span> <span class="attribute">column</span>=<span class="value">"username"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"sex"</span> <span class="attribute">column</span>=<span class="value">"sex"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"address"</span> <span class="attribute">column</span>=<span class="value">"address"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">association</span>&gt;</span>
<span class="tag">&lt;/<span class="title">resultMap</span>&gt;</span>

<span class="comment">&lt;!-- 一对多查询 --&gt;</span>
<span class="comment">&lt;!-- 订单 及 订单明细 --&gt;</span>
<span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">""</span> <span class="attribute">resultMap</span>=<span class="value">"userOrdersDetailsMap"</span>&gt;</span>
    select orders.*, orderdetial.id orderdetail_id,
    orderdetail.item_id, orderdetail.item_num, orderdetail.item_price
    from orders, orderdetail where orders.id=orderdetail.orders_id;
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>

<span class="tag">&lt;<span class="title">resultMap</span> <span class="attribute">type</span>=<span class="value">"order"</span> <span class="attribute">id</span>=<span class="value">"userOrdersDetailsMap"</span>&gt;</span>
    <span class="comment">&lt;!--  订单id --&gt;</span>
    <span class="comment">&lt;!-- id是指定结果集的主键, 指定mybatis返回最终list的结果集主键 --&gt;</span>
    <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"id"</span>&gt;</span><span class="tag">&lt;/<span class="title">id</span>&gt;</span>
    <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"orderNumber"</span> <span class="attribute">column</span>=<span class="value">"order_number"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
    <span class="comment">&lt;!-- 集合中用 orderDetail --&gt;</span>
    <span class="tag">&lt;<span class="title">collection</span> <span class="attribute">property</span>=<span class="value">"orderdetails"</span> <span class="attribute">ofType</span>=<span class="value">"orderDetail"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"orderdetail_id"</span>&gt;</span> <span class="tag">&lt;/<span class="title">id</span>&gt;</span>
        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"itemNum"</span> <span class="attribute">column</span>=<span class="value">"item_num"</span>&gt;</span> <span class="tag">&lt;/<span class="title">id</span>&gt;</span>
        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"itemPrice"</span> <span class="attribute">column</span>=<span class="value">"item_price"</span>&gt;</span> <span class="tag">&lt;/<span class="title">id</span>&gt;</span>
        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"itemDetail"</span> <span class="attribute">column</span>=<span class="value">"item_detail"</span>&gt;</span> <span class="tag">&lt;/<span class="title">id</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">collection</span>&gt;</span>
    <span class="comment">&lt;!-- 订单明细信息 --&gt;</span>
<span class="tag">&lt;/<span class="title">resultMap</span>&gt;</span>

<span class="comment">&lt;!-- 三表关联, 使用继承 --&gt;</span>
<span class="comment">&lt;!-- 订单 用户 订单明细 --&gt;</span>
<span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">""</span> <span class="attribute">resultMap</span>=<span class="value">"userOrdersDetailsMap"</span>&gt;</span>
select orders.*, user.username, user.sex, user.address,
       orderdetial.id orderdetail_id,
       orderdetail.item_id, orderdetail.item_num, orderdetail.item_price
       from orders, user, orderdetail
       where orders.id=orderdetail.orders_id and  orders.user_id = user.id;
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>

<span class="tag">&lt;<span class="title">resultMap</span> <span class="attribute">type</span>=<span class="value">"order"</span> <span class="attribute">id</span>=<span class="value">"userOrdersDetailsMap"</span> <span class="attribute">extends</span>=<span class="value">"userOrdersMap"</span>&gt;</span>
    <span class="comment">&lt;!--  订单id 继承 订单用户信息 --&gt;</span>
    <span class="comment">&lt;!-- 集合中用 orderDetail --&gt;</span>
    <span class="tag">&lt;<span class="title">collection</span> <span class="attribute">property</span>=<span class="value">"orderdetails"</span> <span class="attribute">ofType</span>=<span class="value">"orderDetail"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"orderdetail_id"</span>&gt;</span> <span class="tag">&lt;/<span class="title">id</span>&gt;</span>
        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"itemNum"</span> <span class="attribute">column</span>=<span class="value">"item_num"</span>&gt;</span> <span class="tag">&lt;/<span class="title">id</span>&gt;</span>
        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"itemPrice"</span> <span class="attribute">column</span>=<span class="value">"item_price"</span>&gt;</span> <span class="tag">&lt;/<span class="title">id</span>&gt;</span>
        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"itemDetail"</span> <span class="attribute">column</span>=<span class="value">"item_detail"</span>&gt;</span> <span class="tag">&lt;/<span class="title">id</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">collection</span>&gt;</span>
<span class="tag">&lt;/<span class="title">resultMap</span>&gt;</span>

<span class="comment">&lt;!-- 查询用户及用户下的订单 --&gt;</span>
<span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"findUserInOrders"</span> <span class="attribute">resultMap</span>=<span class="value">""</span>&gt;</span>
    select orders.*
    user.username,
    user.sex,
    user.address
    from user, order where user.id = order.user_id
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>

<span class="tag">&lt;<span class="title">resultMap</span> <span class="attribute">type</span>=<span class="value">"user"</span> <span class="attribute">id</span>=<span class="value">"userInOrdersMap"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"username"</span> <span class="attribute">column</span>=<span class="value">"username"</span>&gt;</span><span class="tag">&lt;/<span class="title">id</span>&gt;</span>
    <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"user_id"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
    <span class="comment">&lt;!-- 订单信息 --&gt;</span>
    <span class="tag">&lt;<span class="title">collection</span> <span class="attribute">property</span>=<span class="value">"orders"</span> <span class="attribute">ofType</span>=<span class="value">"order"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"order_number"</span> <span class="attribute">column</span>=<span class="value">"order_number"</span>/&gt;</span>
        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"id"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="title">collection</span>&gt;</span>
<span class="tag">&lt;/<span class="title">resultMap</span>&gt;</span>

<span class="comment">&lt;!-- 查询用户及用户下的订单, 和订单明细 --&gt;</span>
<span class="comment">&lt;!-- 查询用户及用户下的订单 --&gt;</span>
<span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"findUserInOrderDetailInOrder"</span> <span class="attribute">resultMap</span>=<span class="value">""</span>&gt;</span>
    TODO: sql
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>
<span class="comment">&lt;!-- 一对多 嵌套 一对多 --&gt;</span>
<span class="tag">&lt;<span class="title">resultMap</span> <span class="attribute">type</span>=<span class="value">"user"</span> <span class="attribute">id</span>=<span class="value">"userInOrdersMap"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"username"</span> <span class="attribute">column</span>=<span class="value">"username"</span>&gt;</span><span class="tag">&lt;/<span class="title">id</span>&gt;</span>
    <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"user_id"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
    <span class="comment">&lt;!-- 订单信息 --&gt;</span>
    <span class="tag">&lt;<span class="title">collection</span> <span class="attribute">property</span>=<span class="value">"orders"</span> <span class="attribute">ofType</span>=<span class="value">"order"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"order_number"</span> <span class="attribute">column</span>=<span class="value">"order_number"</span>/&gt;</span>
        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"id"</span>/&gt;</span>
        <span class="tag">&lt;<span class="title">collection</span> <span class="attribute">property</span>=<span class="value">"orderdetails"</span> <span class="attribute">ofType</span>=<span class="value">"orderDetail"</span>&gt;</span>
            ...
        <span class="tag">&lt;/<span class="title">collection</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">collection</span>&gt;</span>
<span class="tag">&lt;/<span class="title">resultMap</span>&gt;</span>

<span class="comment">&lt;!-- 多对多 --&gt;</span>
<span class="comment">&lt;!-- 查询用户下的订单及订单下的明细商品信息 --&gt;</span>
<span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"findUserOrdersItemList"</span> <span class="attribute">resultMap</span>=<span class="value">"userOrdersItemListMap"</span>&gt;</span>
  select orders.*
    user.username,
    user.sex,
    user.address,
    orderdetial.id orderdetail_id,
    orderdetail.item_id,
    orderdetail.item_num,
    orderdetial.item_price,
    items.item_name
    items.item_price item_price_,
    items.item_detail
  from orders, user, orderdetail,items
  where orders.user_id = user.id
    and orders.id=orderdetail.orders_id
    and items.id = orderdetail.item_id
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>

<span class="tag">&lt;<span class="title">resultMap</span> <span class="attribute">type</span>=<span class="value">"user"</span> <span class="attribute">id</span>=<span class="value">"userOrdersItemListMap"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"username"</span> <span class="attribute">column</span>=<span class="value">"username"</span>&gt;</span><span class="tag">&lt;/<span class="title">id</span>&gt;</span>
    <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"user_id"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
    <span class="comment">&lt;!-- 订单信息 --&gt;</span>
    <span class="tag">&lt;<span class="title">collection</span> <span class="attribute">property</span>=<span class="value">"orders"</span> <span class="attribute">ofType</span>=<span class="value">"order"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"order_number"</span> <span class="attribute">column</span>=<span class="value">"order_number"</span>/&gt;</span>
        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"id"</span>/&gt;</span>
        <span class="tag">&lt;<span class="title">collection</span> <span class="attribute">property</span>=<span class="value">"orderdetails"</span> <span class="attribute">ofType</span>=<span class="value">"orderDetail"</span>&gt;</span>
            ...
            <span class="tag">&lt;<span class="title">association</span> <span class="attribute">property</span>=<span class="value">"items"</span> <span class="attribute">javaType</span>=<span class="value">"items"</span>&gt;</span>
                <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"item_id"</span>&gt;</span><span class="tag">&lt;/<span class="title">id</span>&gt;</span>
                <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"itemName"</span> <span class="attribute">column</span>=<span class="value">"item_name"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
                <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"itemPrice"</span> <span class="attribute">column</span>=<span class="value">"item_price"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
                <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"itemDetail"</span> <span class="attribute">column</span>=<span class="value">"item_detail"</span>&gt;</span><span class="tag">&lt;/<span class="title">result</span>&gt;</span>
            <span class="tag">&lt;/<span class="title">association</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">collection</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">collection</span>&gt;</span>
<span class="tag">&lt;/<span class="title">resultMap</span>&gt;</span>
</pre></td></tr></table></figure>

<h1 id="-">延迟加载</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre>select orders.*
    user<span class="preprocessor">.username</span>,
    user<span class="preprocessor">.sex</span>,
    user<span class="preprocessor">.address</span>,
    orderdetial<span class="preprocessor">.id</span> orderdetail_id,
    orderdetail<span class="preprocessor">.item</span>_id,
    orderdetail<span class="preprocessor">.item</span>_num,
    orderdetial<span class="preprocessor">.item</span>_price,
--    items<span class="preprocessor">.item</span>_name
--    items<span class="preprocessor">.item</span>_price item_price_,
--     items<span class="preprocessor">.item</span>_detail,
  (select items<span class="preprocessor">.item</span>_name from items where orderdetail<span class="preprocessor">.item</span>_id = items<span class="preprocessor">.id</span>) item_name,
  (select items<span class="preprocessor">.item</span>_price from items where orderdetail<span class="preprocessor">.item</span>_id = items<span class="preprocessor">.id</span>) item_price,
  (select items<span class="preprocessor">.item</span>_detail from items where orderdetail<span class="preprocessor">.item</span>_id = items<span class="preprocessor">.id</span>) item_detail
  from orders, user, orderdetail
  where orders<span class="preprocessor">.user</span>_id = user<span class="preprocessor">.id</span>
    <span class="keyword">and</span> orders<span class="preprocessor">.id</span>=orderdetail<span class="preprocessor">.orders</span>_id
    <span class="keyword">and</span> items<span class="preprocessor">.id</span> = orderdetail<span class="preprocessor">.item</span>_id
-- 解决子查询问题, 如下&gt;
</pre></td></tr></table></figure>


<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="comment">&lt;!-- select 子查询, column 根据 column 进行子查询 --&gt;</span>
<span class="comment">&lt;!-- 可以通过设置 懒加载 来延迟查询, 一对一 不推荐使用 --&gt;</span>
<span class="tag">&lt;<span class="title">association</span> <span class="attribute">property</span>=<span class="value">"items"</span> <span class="attribute">javaType</span>=<span class="value">"items"</span>
      <span class="attribute">select</span>=<span class="value">"findItemsById"</span> <span class="attribute">column</span>=<span class="value">"item_id"</span>&gt;</span>
    <span class="comment">&lt;!-- 使用子查询, 可以通过 findItemsById 查询 --&gt;</span>
    <span class="comment">&lt;!-- 一一对应? TODO: 属性和值的对应关系如何设置!!!! --&gt;</span>
    <span class="comment">&lt;!-- &lt;id property="id" column="item_id"&gt;&lt;/id&gt; --&gt;</span>
    <span class="comment">&lt;!-- &lt;result property="itemName" column="item_name"&gt;&lt;/result&gt; --&gt;</span>
    <span class="comment">&lt;!-- &lt;result property="itemPrice" column="item_price"&gt;&lt;/result&gt; --&gt;</span>
    <span class="comment">&lt;!-- &lt;result property="itemDetail" column="item_detail"&gt;&lt;/result&gt; --&gt;</span>
<span class="tag">&lt;/<span class="title">association</span>&gt;</span>

<span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"findItemsById"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span> <span class="attribute">resultType</span>=<span class="value">"items"</span>&gt;</span>
    select * from items where id=#{id}
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>
</pre></td></tr></table></figure>

<p>开启全局延迟加载</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">settings</span>&gt;</span>
    <span class="comment">&lt;!-- 全局性设置懒加载。如果设为‘false’，则所有相关联的都会被初始化加载 --&gt;</span>
    <span class="comment">&lt;!-- 默认为false --&gt;</span>
    <span class="tag">&lt;<span class="title">setting</span> <span class="attribute">name</span>=<span class="value">"lazyLoadingEnable"</span> <span class="attribute">value</span>=<span class="value">"true"</span>&gt;</span><span class="tag">&lt;/<span class="title">setting</span>&gt;</span>
    <span class="comment">&lt;!-- 当设置为‘true’的时候，懒加载的对象可能被任何懒属性全部加载。
         否则，每个属性都按需加载。 --&gt;</span>
    <span class="comment">&lt;!-- 默认为true --&gt;</span>
    <span class="tag">&lt;<span class="title">setting</span> <span class="attribute">name</span>=<span class="value">"aggressiveLazyLoading"</span> <span class="attribute">value</span>=<span class="value">"false"</span>&gt;</span><span class="tag">&lt;/<span class="title">setting</span>&gt;</span>
<span class="tag">&lt;/<span class="title">settings</span>&gt;</span>
</pre></td></tr></table></figure>

<h1 id="-sql">动态 SQL</h1>
<h2 id="if">if</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre>&lt;select id=<span class="string">"findUserInOrderDetailInOrder"</span> parameterType=<span class="string">"user"</span> resultMap=<span class="string">""</span>&gt;
  select orders.*
      user<span class="preprocessor">.username</span>,
      user<span class="preprocessor">.sex</span>,
      user<span class="preprocessor">.address</span>,
      orderdetial<span class="preprocessor">.id</span> orderdetail_id,
      orderdetail<span class="preprocessor">.item</span>_id,
      orderdetail<span class="preprocessor">.item</span>_num,
      orderdetial<span class="preprocessor">.item</span>_price,
    from orders, user, orderdetail
    where orders<span class="preprocessor">.user</span>_id = user<span class="preprocessor">.id</span>
      <span class="keyword">and</span> orders<span class="preprocessor">.id</span>=orderdetail<span class="preprocessor">.orders</span>_id
    
    &lt;!-- 注意不是 user<span class="preprocessor">.id</span> --&gt;
    &lt;if test=<span class="string">"id!=null and id!=''"</span>&gt;
        <span class="keyword">AND</span> user<span class="preprocessor">.id</span>=<span class="preprocessor">#{id}</span>
    &lt;/if&gt;
&lt;/select&gt;
</pre></td></tr></table></figure>

<h2 id="where">where</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"findUserList"</span> <span class="attribute">parameterType</span>=<span class="value">"user"</span> <span class="attribute">resultType</span>=<span class="value">"user"</span>&gt;</span>
    select * from user
    <span class="comment">&lt;!-- 解决如果条件都不符合, 会多出一个 where --&gt;</span>
    <span class="tag">&lt;<span class="title">where</span>&gt;</span>
        <span class="tag">&lt;<span class="title">if</span> <span class="attribute">test</span>=<span class="value">"id!=null and id!=''"</span>&gt;</span>
            and user.id=#{id}
        <span class="tag">&lt;/<span class="title">if</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">where</span>&gt;</span>
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>
</pre></td></tr></table></figure>

<h2 id="foreach">foreach</h2>
<p>向sql传递数组或List，mybatis使用foreach解析</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="comment">&lt;!-- User{ids:Array[Int]} --&gt;</span>
<span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"findUserList"</span> <span class="attribute">parameterType</span>=<span class="value">"user"</span> <span class="attribute">resultType</span>=<span class="value">"user"</span>&gt;</span>
    select * from user
    <span class="comment">&lt;!-- 解决如果条件都不符合, 会多出一个 where --&gt;</span>
    <span class="tag">&lt;<span class="title">where</span>&gt;</span>
        <span class="comment">&lt;!-- ids是集合, item 是集合中的项目 --&gt;</span>
        <span class="comment">&lt;!-- 生成 user.id in (1, 2, 3) --&gt;</span>
        <span class="tag">&lt;<span class="title">foreach</span> <span class="attribute">collection</span>=<span class="value">"ids"</span> <span class="attribute">item</span>=<span class="value">"items"</span> <span class="attribute">open</span>=<span class="value">"user.id in("</span> <span class="attribute">close</span>=<span class="value">")"</span> <span class="attribute">separator</span>=<span class="value">","</span>&gt;</span>
            #{items}
        <span class="tag">&lt;/<span class="title">foreach</span>&gt;</span>
        
        <span class="comment">&lt;!-- 第二种写法  --&gt;</span>
        <span class="comment">&lt;!-- 生成 and user.id=1 or user.id=1 --&gt;</span>
        <span class="tag">&lt;<span class="title">foreach</span> <span class="attribute">collection</span>=<span class="value">"ids"</span> <span class="attribute">item</span>=<span class="value">"items"</span> <span class="attribute">open</span>=<span class="value">"and ("</span> <span class="attribute">close</span>=<span class="value">")"</span> <span class="attribute">separator</span>=<span class="value">"or"</span>&gt;</span>
            user.id=#{items}
        <span class="tag">&lt;/<span class="title">foreach</span>&gt;</span>

        <span class="tag">&lt;<span class="title">foreach</span> <span class="attribute">collection</span>=<span class="value">"array"</span> <span class="attribute">index</span>=<span class="value">"index"</span> <span class="attribute">item</span>=<span class="value">"item"</span>
             <span class="attribute">open</span>=<span class="value">"and id in("</span> <span class="attribute">separator</span>=<span class="value">","</span> <span class="attribute">close</span>=<span class="value">")"</span> &gt;</span>
		    #{item.id} 
		 <span class="tag">&lt;/<span class="title">foreach</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">where</span>&gt;</span>
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>
</pre></td></tr></table></figure>

<h2 id="set">set</h2>
<p>TODO</p>
<h1 id="sql-">Sql 片段</h1>
<p>抽取重用的 sql 片段</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">sql</span> <span class="attribute">id</span>=<span class="value">"user_query"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">if</span> <span class="attribute">test</span>=<span class="value">"id!=null and id!=''"</span>&gt;</span>
      and user.id=#{id}
    <span class="tag">&lt;/<span class="title">if</span>&gt;</span>
<span class="tag">&lt;/<span class="title">sql</span>&gt;</span>

<span class="tag">&lt;<span class="title">select</span>&gt;</span>
    ...
    <span class="tag">&lt;<span class="title">where</span>&gt;</span>
        <span class="tag">&lt;<span class="title">include</span> <span class="attribute">refid</span>=<span class="value">"user_query"</span>&gt;</span> <span class="tag">&lt;/<span class="title">include</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">where</span>&gt;</span>
<span class="tag">&lt;/<span class="title">select</span>&gt;</span>
<span class="comment">&lt;!-- 如果引用其他mapper.xml的sql片段, 需要及啊家辉命名空间--&gt;</span>
<span class="tag">&lt;<span class="title">include</span> <span class="attribute">refid</span>=<span class="value">"namespace.sql片段名"</span>&gt;</span>
<span class="tag">&lt;/<span class="title">include</span>&gt;</span>
</pre></td></tr></table></figure>

<h1 id="-">缓存</h1>
<h2 id="-">一级缓存</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre>SqlSession sqlSession = sqlSessionFactory<span class="preprocessor">.openSession</span>()<span class="comment">;</span>
UserMapper userMapper = sqlSession<span class="preprocessor">.getMapper</span>(UserMapper<span class="preprocessor">.class</span>)<span class="comment">;</span>
// 从数据库中取出来, 写入缓存
user<span class="preprocessor">.findUserById</span>(<span class="number">1</span>)<span class="comment">;</span>
// 同一个sql中, 相同的两次次查询发出一个sql
user<span class="preprocessor">.findUserById</span>(<span class="number">1</span>)<span class="comment">;</span>

// 第二次测试
// open new session
user<span class="preprocessor">.findUserById</span>(<span class="number">1</span>)<span class="comment">;</span>
// 任何数据库更新, 删除, 插入之后都会将 sqlSession 的缓存清空
// 更新
User user_update = new User<span class="comment">;</span>
user_update<span class="preprocessor">.setId</span>(<span class="number">1</span>)<span class="comment">;</span>
user_update<span class="preprocessor">.setUsername</span>(<span class="string">""</span>)<span class="comment">;</span>
// update 会清除本地缓存
userMapper<span class="preprocessor">.updateUserById</span>(user_update)<span class="comment">;</span>
sqlSession<span class="preprocessor">.commit</span>()<span class="comment">;</span>

user<span class="preprocessor">.findUserById</span>(<span class="number">1</span>)<span class="comment">;</span>
</pre></td></tr></table></figure>

<h2 id="-">二级缓存</h2>
<p>一个项目中肯定会存在很多共用的查询数据，对于这一部分的数据，没必要
每一个用户访问时都去查询数据库，因此配置二级缓存将是非常必要的</p>
<p>Mybatis 的二级缓存即查询缓存, 它的作用域是一个 mapper 的 namespace,
即在同一个 namespace 中查询 sql 可以从缓存中获取数据</p>
<p>二级缓存是可以跨 SqlSession 的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="comment">&lt;!-- 开启二级缓存 --&gt;</span>
<span class="comment">&lt;!-- 全局设置 --&gt;</span>
<span class="tag">&lt;<span class="title">settings</span>&gt;</span>
    <span class="tag">&lt;<span class="title">setting</span> <span class="attribute">name</span>=<span class="value">"cacheEnabled"</span> <span class="attribute">value</span>=<span class="value">"true"</span>/&gt;</span>
<span class="tag">&lt;/<span class="title">settings</span>&gt;</span>

<span class="comment">&lt;!-- 开启mapper的二级缓存 --&gt;</span>
<span class="tag">&lt;<span class="title">mapper</span>&gt;</span>
    <span class="tag">&lt;<span class="title">cache</span> &gt;</span><span class="tag">&lt;/<span class="title">cache</span>&gt;</span>
<span class="tag">&lt;/<span class="title">mapper</span>&gt;</span>
</pre></td></tr></table></figure>

<p>二级缓存测试</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre>SqlSession session1 = openSession()<span class="comment">;</span>
SqlSession session2 = openSession()<span class="comment">;</span>

UserMapper userMapper1 = session1<span class="preprocessor">.getMapper</span>(UserMapper<span class="preprocessor">.class</span>)<span class="comment">;</span>
UserMapper userMapper2 = session2<span class="preprocessor">.getMapper</span>(UserMapper<span class="preprocessor">.class</span>)<span class="comment">;</span>

userMapper1<span class="preprocessor">.findUserList</span>()<span class="comment">;</span>
session1<span class="preprocessor">.close</span>()<span class="comment">;</span>
// 必须先要关闭 session1, 关闭session的时候, session1的缓存会被写入到二级缓存
// 如果开启二级缓存, 那么不会再发出sql语句
userMapper2<span class="preprocessor">.findUserList</span>()<span class="comment">;</span>


// 测试二:
SqlSession session1 = openSession()<span class="comment">;</span>
SqlSession session2 = openSession()<span class="comment">;</span>
SqlSession session3 = openSession()<span class="comment">;</span>

UserMapper userMapper1 = session1<span class="preprocessor">.getMapper</span>(UserMapper<span class="preprocessor">.class</span>)<span class="comment">;</span>
UserMapper userMapper2 = session2<span class="preprocessor">.getMapper</span>(UserMapper<span class="preprocessor">.class</span>)<span class="comment">;</span>
UserMapper userMapper3 = session2<span class="preprocessor">.getMapper</span>(UserMapper<span class="preprocessor">.class</span>)<span class="comment">;</span>

User user1 = userMapper1<span class="preprocessor">.findUserById</span>(<span class="number">1</span>)<span class="comment">;</span>
session1<span class="preprocessor">.close</span>()<span class="comment">;</span>

user1<span class="preprocessor">.setUsername</span>(<span class="string">"changed"</span>)<span class="comment">;</span>
session2<span class="preprocessor">.updateUserById</span>(user1)<span class="comment">;</span>
session2<span class="preprocessor">.commit</span>()<span class="comment">;</span>

// 如果 &lt;update id=<span class="string">"updateUserById"</span> flushcache=<span class="string">"true"</span>&gt;, 那么更新时, 会刷新二级缓存
session3<span class="preprocessor">.findUserById</span>(<span class="number">1</span>)<span class="comment">;</span>
</pre></td></tr></table></figure>

<h3 id="-">配置二级缓存</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="comment">&lt;!-- 默认60秒刷新一次, 存数结果对象或列表 512个引用,
     返回的对象认为是只读的 --&gt;</span>
<span class="comment">&lt;!-- LRU 最近最少使用的:移除最长时间不被使用的对象。 --&gt;</span>
<span class="comment">&lt;!-- FIFO 先进先出:按对象进入缓存的顺序来移除它们。 --&gt;</span>
<span class="comment">&lt;!-- SOFT 软引用:移除基于垃圾回收器状态和软引用规则的对象。 --&gt;</span>
<span class="comment">&lt;!-- WEAK 弱引用:更积极地移除基于垃圾收集器状态和弱引用规则的对象。      --&gt;</span>
<span class="comment">&lt;!-- size 默认值是1024, readOnly 默认是false --&gt;</span>
<span class="tag">&lt;<span class="title">cache</span> <span class="attribute">eviction</span>=<span class="value">"FIFO"</span> <span class="attribute">flushInterval</span>=<span class="value">"60000"</span> <span class="attribute">size</span>=<span class="value">"512"</span> <span class="attribute">readOnly</span>=<span class="value">"true"</span>/&gt;</span>
</pre></td></tr></table></figure>

<h3 id="ehcache-">Ehcache 配置</h3>
<p><code>ehcache.xml</code> defaultCache 配置说明</p>
<ul>
<li>maxElementsInMemory 内存中最大缓存对象数.
当超过最大对象数的时候,ehcache会按指定的策略去清理内存</li>
<li>eternal 缓存对象是否永久有效,一但设置了,timeout将不起作用.</li>
<li>timeToIdleSeconds 设置Element在失效前的允许闲置时间.仅当element不是永久有效时使用,
可选属性,默认值是0,也就是可闲置时间无穷大.</li>
<li>timeToLiveSeconds：设置Element在失效前允许存活时间.
最大时间介于创建时间和失效时间之间.
仅当element是永久有效时使用,默认是0.,也就是element存活时间无穷大.</li>
<li>overflowToDisk 配置此属性,当内存中Element数量达到maxElementsInMemory时,
Ehcache将会Element写到磁盘中.</li>
<li>diskSpoolBufferSizeMB 这个参数设置DiskStore(磁盘缓存)的缓存区大小.
默认是30MB.每个Cache都应该有自己的一个缓冲区.</li>
<li>maxElementsOnDisk 磁盘中最大缓存对象数,若是0表示无穷大.</li>
<li>diskPersistent 是否在重启服务的时候清楚磁盘上的缓存数据.
true不清除.</li>
<li>diskExpiryThreadIntervalSeconds 磁盘失效线程运行时间间隔.</li>
<li>memoryStoreEvictionPolicy：当达到maxElementsInMemory限制时,
Ehcache将会根据指定的策略去清理内存.
默认策略是LRU(最近最少使用).
你可以设置为FIFO(先进先出)或是LFU(较少使用).</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="comment">&lt;!-- 这样设置 echcache --&gt;</span>
<span class="tag">&lt;<span class="title">cache</span> <span class="attribute">type</span>=<span class="value">"org.mybatis.caches.ehcache.EhcacheCache"</span>/&gt;</span>
</pre></td></tr></table></figure>

<h1 id="mybatis-springmvc-">Mybatis 和 SpringMVC 整合</h1>
<p>导入 <code>mybatis-spring1.2.2.jar</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="tag">&lt;<span class="title">beans</span> <span class="attribute">xmlns</span>=<span class="value">"http://www.springframework.org/schema/beans"</span>
    <span class="attribute">xmlns:xsi</span>=<span class="value">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attribute">xmlns:mvc</span>=<span class="value">"http://www.springframework.org/schema/mvc"</span>
    <span class="attribute">xmlns:context</span>=<span class="value">"http://www.springframework.org/schema/context"</span>
    <span class="attribute">xmlns:aop</span>=<span class="value">"http://www.springframework.org/schema/aop"</span> <span class="attribute">xmlns:tx</span>=<span class="value">"http://www.springframework.org/schema/tx"</span>
    <span class="attribute">xsi:schemaLocation</span>=<span class="value">"http://www.springframework.org/schema/beans 
    http://www.springframework.org/schema/beans/spring-beans-3.1.xsd 
    http://www.springframework.org/schema/mvc 
    http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd 
    http://www.springframework.org/schema/context 
    http://www.springframework.org/schema/context/spring-context-3.1.xsd 
    http://www.springframework.org/schema/aop 
    http://www.springframework.org/schema/aop/spring-aop-3.1.xsd 
    http://www.springframework.org/schema/tx 
    http://www.springframework.org/schema/tx/spring-tx-3.1.xsd "</span>&gt;</span>

    <span class="comment">&lt;!-- 引用配置文件 --&gt;</span>
    <span class="comment">&lt;!-- 加载数据源配置文件 --&gt;</span>
    <span class="tag">&lt;<span class="title">context:property-placeholder</span> <span class="attribute">location</span>=<span class="value">"classpath:db.properties"</span> /&gt;</span>  
    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"dataSource"</span> <span class="attribute">class</span>=<span class="value">"org.apache.commons.dbcp.BasicDataSource"</span>
           <span class="attribute">destroy-method</span>=<span class="value">"close"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"driverClassName"</span> <span class="attribute">value</span>=<span class="value">"${mysql.driver}"</span> /&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"url"</span> <span class="attribute">value</span>=<span class="value">"${mysql.url}"</span> /&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"username"</span> <span class="attribute">value</span>=<span class="value">"${mysql.username}"</span> /&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"password"</span> <span class="attribute">value</span>=<span class="value">"${mysql.password}"</span> /&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"maxActive"</span> <span class="attribute">value</span>=<span class="value">"30"</span> /&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"maxIdle"</span> <span class="attribute">value</span>=<span class="value">"5"</span> /&gt;</span>
    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span>
<span class="tag">&lt;/<span class="title">beans</span>&gt;</span>
</pre></td></tr></table></figure>

<p>applicationContext-dao.xml</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="comment">&lt;!-- SqlSessioniFactory --&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"sqlSessionFactory"</span> <span class="attribute">class</span>=<span class="value">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"dataSource"</span> <span class="attribute">ref</span>=<span class="value">"dataSource"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"configLocation"</span> <span class="attribute">value</span>=<span class="value">"classpath:mybatic/SqlMapConfig.xml"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span>
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="pi">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="doctype">&lt;!DOCTYPE configuration
PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span>
<span class="tag">&lt;<span class="title">configuration</span>&gt;</span>
    <span class="tag">&lt;<span class="title">properties</span> <span class="attribute">resource</span>=<span class="value">"db.properties"</span> /&gt;</span>
    <span class="comment">&lt;!-- 全局参数配置  --&gt;</span>	
    <span class="tag">&lt;<span class="title">settings</span>&gt;</span>
        <span class="comment">&lt;!--开启全局性设置懒加载 --&gt;</span>
        <span class="tag">&lt;<span class="title">setting</span> <span class="attribute">name</span>=<span class="value">"lazyLoadingEnabled"</span> <span class="attribute">value</span>=<span class="value">"true"</span>/&gt;</span>
        <span class="comment">&lt;!-- 设置为按需加载 --&gt;</span>
        <span class="tag">&lt;<span class="title">setting</span> <span class="attribute">name</span>=<span class="value">"aggressiveLazyLoading"</span> <span class="attribute">value</span>=<span class="value">"false"</span>/&gt;</span>
        <span class="comment">&lt;!-- 开启二级缓存 --&gt;</span>
        <span class="tag">&lt;<span class="title">setting</span>  <span class="attribute">name</span>=<span class="value">"cacheEnabled"</span> <span class="attribute">value</span>=<span class="value">"true"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="title">settings</span>&gt;</span>
    <span class="comment">&lt;!-- 定义别名 --&gt;</span>
    <span class="tag">&lt;<span class="title">typeAliases</span>&gt;</span>
        <span class="comment">&lt;!-- &lt;typeAlias alias="user" type="cn.itcast.mybatis.po.User" /&gt; --&gt;</span>
        <span class="tag">&lt;<span class="title">package</span> <span class="attribute">name</span>=<span class="value">"cn.itcast.mybatis.po"</span>/&gt;</span>
        <span class="comment">&lt;!-- &lt;typeAlias alias="" type=""/&gt; --&gt;</span>
    <span class="tag">&lt;/<span class="title">typeAliases</span>&gt;</span>
	
    <span class="comment">&lt;!-- 定义databaseIdProvider --&gt;</span>
    <span class="tag">&lt;<span class="title">databaseIdProvider</span> <span class="attribute">type</span>=<span class="value">"DB_VENDOR"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"SQL Server"</span> <span class="attribute">value</span>=<span class="value">"sqlserver"</span>/&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"DB2"</span> <span class="attribute">value</span>=<span class="value">"db2"</span>/&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"Oracle"</span> <span class="attribute">value</span>=<span class="value">"oracle"</span> /&gt;</span><span class="comment">&lt;!-- oracle的databaseid为"oracle" --&gt;</span>
        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"MySQL"</span> <span class="attribute">value</span>=<span class="value">"mysql"</span> /&gt;</span><span class="comment">&lt;!-- mysql的databaseid为"mysql"，此名称和mapper.xml文件中下定义databaseId一致 --&gt;</span>
    <span class="tag">&lt;/<span class="title">databaseIdProvider</span>&gt;</span>
	
    <span class="comment">&lt;!-- 指定sql映射文件 --&gt;</span>
    <span class="tag">&lt;<span class="title">mappers</span>&gt;</span>
        <span class="comment">&lt;!-- 指定mapper映射文件的位置 
             &lt;mapper resource="sqlmap/User.xml" /&gt; --&gt;</span>
        <span class="comment">&lt;!-- 
          通过class指定mapper接口，必须保证mapper接口名称和mapper映射文件名称相同，且放在同一个目录中
        &lt;mapper class="cn.itcast.mybatis.mapper.UserMapper"/&gt; --&gt;</span>
        <span class="comment">&lt;!--
          通过package指定扫描mapper包的路径 ，mybatis自动将此包下的mappre接口与mapper映射文件绑定
          必须保证mapper接口名称和mapper映射文件名称相同，且放在同一个目录中
        --&gt;</span>
        <span class="tag">&lt;<span class="title">package</span> <span class="attribute">name</span>=<span class="value">"cn.itcast.mybatis.mapper"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="title">mappers</span>&gt;</span>
<span class="tag">&lt;/<span class="title">configuration</span>&gt;</span>
</pre></td></tr></table></figure>

<h2 id="-dao-">方式一 编写 dao 方式</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="comment">// &lt;bean id=userDao class=UserDaoImpl&gt;</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">extends</span> <span class="title">SqlSessionDaoSupport</span>{</span>
}
</pre></td></tr></table></figure>

<h2 id="-mapper-bean">方式二 mapper bean</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="comment">&lt;!-- 使用工厂bean --&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"userMapper"</span> <span class="attribute">class</span>=<span class="value">"org.mybatis.pring.mapper.MapperFactoryBean"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"mapperInterface"</span> <span class="attribute">value</span>=<span class="value">"UserMapper"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"sqlSessionFactory"</span> <span class="attribute">ref</span>=<span class="value">"sqlSessionFactory"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span>
</pre></td></tr></table></figure>

<h2 id="-mapper-">方式三 mapper 注解</h2>
<p>mapper.xml文件编写，注意：</p>
<ul>
<li>mapper.xml中的namespace为mapper接口的地址</li>
<li>mapper接口中的方法名和mapper.xml中的定义的statement的id保持一致</li>
<li>如果将mapper.xml和mapper接口的名称保持一致则不用在 sqlMapConfig.xml 中进行配置</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="comment">&lt;!-- mapper 扫描器 --&gt;</span>
<span class="comment">&lt;!-- 对象名是 bean 的类名的头字母小写  --&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"basePackage"</span> <span class="attribute">value</span>=<span class="value">"mapper接口包地址"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"sqlSessionFactoryBeanName"</span> <span class="attribute">value</span>=<span class="value">"sqlSessionFactory"</span>/&gt;</span> 
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span>
</pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/传智播客/">传智播客</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://zhpooer.github.io/2014/07/16/传智播客day58-mybatis提高/" data-title="传智播客day58-Mybatis提高 | Poe&#39;s World" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/07/17/scala-in-action-working-with-scala/" title="Scala in Action-working with scala">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Scala in Action-working with scala</span>
</a>
</div>


<div class="next">
<a href="/2014/07/15/scala-in-action-functional-programming-in-scala/"  title="Scala in Action-Functional Programming in Scala">
 <strong>NEXT:</strong><br/> 
 <span>Scala in Action-Functional Programming in Scala
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">1.</span> <span class="toc-text">延迟加载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-sql"><span class="toc-number">2.</span> <span class="toc-text">动态 SQL</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#if"><span class="toc-number">2.1.</span> <span class="toc-text">if</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#where"><span class="toc-number">2.2.</span> <span class="toc-text">where</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#foreach"><span class="toc-number">2.3.</span> <span class="toc-text">foreach</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#set"><span class="toc-number">2.4.</span> <span class="toc-text">set</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#sql-"><span class="toc-number">3.</span> <span class="toc-text">Sql 片段</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">4.</span> <span class="toc-text">缓存</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">4.1.</span> <span class="toc-text">一级缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">4.2.</span> <span class="toc-text">二级缓存</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-"><span class="toc-number">4.2.1.</span> <span class="toc-text">配置二级缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ehcache-"><span class="toc-number">4.2.2.</span> <span class="toc-text">Ehcache 配置</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#mybatis-springmvc-"><span class="toc-number">5.</span> <span class="toc-text">Mybatis 和 SpringMVC 整合</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-dao-"><span class="toc-number">5.1.</span> <span class="toc-text">方式一 编写 dao 方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-mapper-bean"><span class="toc-number">5.2.</span> <span class="toc-text">方式二 mapper bean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-mapper-"><span class="toc-number">5.3.</span> <span class="toc-text">方式三 mapper 注解</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/AJAX/" title="AJAX">AJAX<sup>1</sup></a></li>
		
			<li><a href="/tags/Akka/" title="Akka">Akka<sup>1</sup></a></li>
		
			<li><a href="/tags/DOM/" title="DOM">DOM<sup>2</sup></a></li>
		
			<li><a href="/tags/EL表达式/" title="EL表达式">EL表达式<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>2</sup></a></li>
		
			<li><a href="/tags/HttpSession/" title="HttpSession">HttpSession<sup>1</sup></a></li>
		
			<li><a href="/tags/IO/" title="IO">IO<sup>1</sup></a></li>
		
			<li><a href="/tags/JSP/" title="JSP">JSP<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaBean/" title="JavaBean">JavaBean<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>1</sup></a></li>
		
			<li><a href="/tags/Mybatis/" title="Mybatis">Mybatis<sup>1</sup></a></li>
		
			<li><a href="/tags/NoSql/" title="NoSql">NoSql<sup>1</sup></a></li>
		
			<li><a href="/tags/SAX/" title="SAX">SAX<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletRequest/" title="ServletRequest">ServletRequest<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletResponse/" title="ServletResponse">ServletResponse<sup>1</sup></a></li>
		
			<li><a href="/tags/Spring/" title="Spring">Spring<sup>1</sup></a></li>
		
			<li><a href="/tags/Spring MVC/" title="Spring MVC">Spring MVC<sup>1</sup></a></li>
		
			<li><a href="/tags/String/" title="String">String<sup>1</sup></a></li>
		
			<li><a href="/tags/StringBuffer/" title="StringBuffer">StringBuffer<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2014 
		
		<a href="http://zhpooer.github.io" target="_blank" title="zhpooer">zhpooer</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"zhpoooer"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
