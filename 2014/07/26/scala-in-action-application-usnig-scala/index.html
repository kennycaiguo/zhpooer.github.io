
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Scala in Action-applications using Akka | Poe&#39;s World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zhpooer">
    
    <meta name="description" content="The philosophy behind Akka
The philosophy behind Akka is simple:
make it easier for developers to build correct,
concurrent, scalable, and fault-toler">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="Poe&#39;s World" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Poe&#39;s World" title="Poe&#39;s World"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Poe&#39;s World">Poe&#39;s World</a></h1>
				<h2 class="blog-motto">竹杖芒鞋轻胜马，一蓑烟雨任平生</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/english-monthly">英语角</a></li>
					
						<li><a href="/about">关于</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:zhpooer.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/07/26/scala-in-action-application-usnig-scala/" title="Scala in Action-applications using Akka" itemprop="url">Scala in Action-applications using Akka</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://zhpooer.github.io" title="zhpooer">zhpooer</a>
    </p>
  <p class="article-time">
    <time datetime="2014-07-25T23:35:04.000Z" itemprop="datePublished">7月 26 2014</time>
    更新日期:<time datetime="2014-07-27T03:53:44.000Z" itemprop="dateModified">7月 27 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#the-philosophy-behind-akka"><span class="toc-number">1.</span> <span class="toc-text">The philosophy behind Akka</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#simple-concurrency-with-akka"><span class="toc-number">2.</span> <span class="toc-text">Simple concurrency with Akka</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#remote-actors"><span class="toc-number">2.1.</span> <span class="toc-text">Remote actors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#making-mutable-data-safe-with-stm"><span class="toc-number">2.2.</span> <span class="toc-text">Making mutable data safe with STM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#agents"><span class="toc-number">2.3.</span> <span class="toc-text">Agents</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dataflow"><span class="toc-number">2.4.</span> <span class="toc-text">Dataflow</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#building-a-real-time-pricing-system-akkaoogle"><span class="toc-number">3.</span> <span class="toc-text">Building a real-time pricing system: Akkaoogle</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#the-high-level-architecture-of-akkaoogle"><span class="toc-number">3.1.</span> <span class="toc-text">The high-level architecture of Akkaoogle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setting-up-the-project-for-akkaoogle"><span class="toc-number">3.2.</span> <span class="toc-text">Setting up the project for Akkaoogle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#implementing-the-domain-models"><span class="toc-number">3.3.</span> <span class="toc-text">Implementing the domain models</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#implementing-the-core-with-actors"><span class="toc-number">3.4.</span> <span class="toc-text">Implementing the core with actors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#increase-scalability-with-remote-actors-dispatchers-and-routers"><span class="toc-number">3.5.</span> <span class="toc-text">Increase scalability with remote actors, dispatchers, and routers</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#improve-performance-with-dispatchers"><span class="toc-number">3.5.1.</span> <span class="toc-text">IMPROVE PERFORMANCE WITH DISPATCHERS</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#handling-shared-resources-with-agent"><span class="toc-number">3.6.</span> <span class="toc-text">Handling shared resources with Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setting-up-play2-mini"><span class="toc-number">3.7.</span> <span class="toc-text">Setting up Play2-mini</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#running-with-play2-mini"><span class="toc-number">3.7.1.</span> <span class="toc-text">Running with Play2-mini</span></a></li></ol>
		</div>
		
		<h1 id="the-philosophy-behind-akka">The philosophy behind Akka</h1>
<p>The philosophy behind Akka is simple:
make it easier for developers to build correct,
concurrent, scalable, and fault-tolerant applications.</p>
<p>At the core, Akka is an event-based platform and relies on actors for message
passing and scalability. Akka puts both local and remote actors at your disposal. </p>
<h1 id="simple-concurrency-with-akka">Simple concurrency with Akka</h1>
<ul>
<li>Actors, An actor is an object that processes messages asynchronously and encapsulates
state.</li>
<li>STM, Software transactional memory is a concurrency model analogous to database
transactions for controlling access to a shared state</li>
<li>Agents, Agents provide abstraction over mutable data. They only allow you to mutate the
data through an asynchronous write action.</li>
<li>Dataflow, This means that it behaves the same every
time you execute it. So if your problem deadlocks the first time,
it will always deadlock, helping you to debug the problem.</li>
</ul>
<p>You can model an application using actors, handle muta-
ble state with STM or agents, and use dataflow concurrency to compose multiple
concurrent processes. </p>
<h2 id="remote-actors">Remote actors</h2>
<p>Akka remote actors allow you to deploy actors in remote machines and
send messages back and forth transparently.</p>
<p>The messages are automatically serialized using the Google protocol buffer.
Think of the Google protocol buffer as XML but smaller and faster, and Netty
as a non-blocking I/O (NIO) implementation, which allows Akka to efficiently use
threads for I/O operations.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>resolvers ++= <span class="constant">Seq</span>(
  <span class="string">"Akka Repo"</span> at <span class="string">"http://akka.io/repository"</span>,
  <span class="string">"Typesafe Repo"</span> at <span class="string">"http://repo.typesafe.com/typesafe/repo"</span>
)
libraryDependencies ++= <span class="constant">Seq</span>(
  <span class="string">"com.typesafe.akka"</span> <span class="string">%% "akka-actor" %</span> <span class="string">"2.1.0"</span>,
  <span class="string">"com.typesafe.akka"</span> <span class="string">%% "akka-remote %</span> <span class="string">"2.1.0"</span>
)
</pre></td></tr></table></figure>

<p>We will work with a list of URLs. The goal is to connect
to the URL and count all the words on the page. </p>
<h2 id="making-mutable-data-safe-with-stm">Making mutable data safe with STM</h2>
<p>STM is similar to database transactions, but is used for memory instead.</p>
<ul>
<li>Atomicity—This property states that all modifications should follow the “all or
nothing” rule. In STM, all the modification is done through an atomic transac-
tion, and if one change fails all the other changes are rolled back.</li>
<li>Consistency—This property ensures that an STM transaction takes the system
from one consistent state to another.</li>
<li>Isolation—This property requires that no other STM transaction sees partial
changes from other transactions.</li>
</ul>
<p>It rolls back from exceptions and is composable.</p>
<p>In STM, state is defined as the value that an entity
with a specific identity has at a particular point.</p>
<p>A value is something that doesn’t change (it’s immutable).
And identity is a stable reference to a value at a given point in time.
The mutable part here is the identity,
which gets associated with a series of values.
And STM makes the mutation of reference from one value to another atomic.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>resolvers += (<span class="string">"Typesafe Repository"</span> at <span class="string">"http://repo.typesafe.com/typesafe/releases/"</span>)
libraryDependencies ++= <span class="constant">Seq</span>(
  <span class="string">"org.scala-stm"</span> <span class="string">%% "scala-stm" %</span> <span class="string">"0.7"</span>,
  <span class="string">"org.specs2"</span> <span class="string">%% "specs2" %</span> <span class="string">"1.13"</span> % <span class="string">"test"</span>
)
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="comment">// Refs are nothing but mutable references to values that you</span>
<span class="comment">// can share safely with multiple concurrent participants.</span>
val ref1 = Ref(HashMap[String, Any](
  <span class="string">"service1"</span> -&gt; <span class="string">"10"</span>,
  <span class="string">"service2"</span> -&gt; <span class="string">"20"</span>,
  <span class="string">"service3"</span> -&gt; <span class="keyword">null</span>))
val ref2 = Ref(HashMap[String, Int]())

def atomicInsert(key: String, <span class="keyword">value</span>: Int) = atomic { <span class="keyword">implicit</span> txn =&gt;
  val oldMap = ref2.<span class="keyword">get</span>
  val newMap = oldMap + ( key -&gt; <span class="keyword">value</span>)
  <span class="comment">// using swap to replace the old value with the new value.</span>
  ref2.swap(newMap)
}

<span class="comment">// The transform method allows you to transform the value</span>
<span class="comment">// referenced by Ref by applying the given function</span>
def atomicDelete(key: String): Option[Any] = atomic {
  val oldMap = ref1.<span class="keyword">get</span>
  val <span class="keyword">value</span> = oldMap.<span class="keyword">get</span>(key)
  ref1.transform(_ - key)
  <span class="keyword">value</span>
}
</pre></td></tr></table></figure>

<p>To perform any operation on Ref you have to use the atomic
method defined in the STM package by passing an in-transaction parameter. The Scala
STM library creates the transaction object and grants the caller permission to perform
transactional reads and writes. Any refs you change in the closure will be done in an
STM transaction. </p>
<p>The transaction parameter is marked as implicit so you
don’t have to pass it around.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre>// <span class="operator">wrap</span> both <span class="operator">the</span> atomicDelete <span class="operator">and</span> atomicInsert functions <span class="operator">in</span> <span class="operator">an</span> atomic <span class="function"><span class="keyword">function</span></span>

def atomicSwap(key: String) = atomic { implicit txn =&gt;
  val <span class="built_in">value</span>: Option[Any] = atomicDelete(key)
  atomicInsert(key, Integer.parseInt(<span class="built_in">value</span>.<span class="built_in">get</span>.toString))
}
</pre></td></tr></table></figure>

<h2 id="agents">Agents</h2>
<p>Agents provide asynchronous changes to any individual storage location bound to it.
An agent only lets you mutate the location by applying an action.
Actions in this case are functions that asynchronously are applied to
the state of Agent and in which the
return value of the function becomes the new value of Agent .</p>
<p>Reading a value from Agent is synchronous and instantaneous.
The difference between Ref and Agent is that Ref
is a synchronous read and write; Agent is reactive.</p>
<p>Akka provides two methods: send and sendOff. The send
method uses the reactive thread pool allocated for agents,
and sendOff uses a dedicated thread, ideal for a long-running processes.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>libraryDependencies ++= <span class="constant">Seq</span>(
  <span class="string">"com.typesafe.akka"</span> <span class="string">%% "akka-actor" %</span> <span class="string">"2.1.0"</span>,
  <span class="string">"com.typesafe.akka"</span> <span class="string">%% "akka-agent" %</span> <span class="string">"2.1.0"</span>,
  <span class="string">"org.specs2"</span> <span class="string">%% "specs2" %</span> <span class="string">"1.13"</span> % <span class="string">"test"</span>
)
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>// <span class="operator">with</span> <span class="operator">a</span> <span class="built_in">file</span> writer that<span class="comment">
// logs messages to the log file through send actions</span>
import akka.agent.Agent
implicit val <span class="keyword">system</span> = ActorSystem(<span class="string">"agentExample"</span>)
val writer = <span class="built_in">new</span> FileWriter(<span class="string">"src/test/resources/log.txt"</span>)
val <span class="operator">a</span> = Agent(writer)
<span class="operator">a</span>.<span class="built_in">send</span> { w =&gt; w.<span class="built_in">write</span>(<span class="string">"This is a log message"</span>); w}<span class="comment">
// Shut Agent down</span>
<span class="operator">a</span>.<span class="built_in">close</span>
writer.<span class="built_in">close</span>
</pre></td></tr></table></figure>

<p>Agent will be running until you invoke the close method.
An actor system is created for the agent because,
behind the scenes, agents are implemented using actors. If
you have to do more than logging to a file,
something that will take time, use the sendOff method:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>a.sendOff <span class="list">{ someLongRunningProcess }</span>
</pre></td></tr></table></figure>

<p>Note that at any time, only one send action is invoked.
Even if actions are sent from multiple concurrent processes,
the actions will be executed in sequential order.</p>
<p>This is important because if you
have a side-effect action, like logging to a file,
you don’t want to do that with STM.
Why? Because if STM transactions fail,
they retry automatically, meaning your
sideeffecting operation is executed multiple times.</p>
<p>Agent is associated with data, and you send behavior to Agent
from outside, in the form of a function. In the case of actors,
the behavior is defined
inside the actor, and you send data in the form of a message.</p>
<h2 id="dataflow">Dataflow</h2>
<p>Dataflow concurrency is a deterministic concurrency model.
If you run it and it works,
it will always work without deadlock.
Alternatively, if it deadlocks the first time, it will
always deadlock. </p>
<p>The dataflow concurrency allows you to
write sequential code that performs parallel operations.
The limitation is that your code should be completely side-effect free.</p>
<p>Dataflow is implemented in Akka using Scala’s delimited continuations compiler
plug-in. <code>build.sbt</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>autoCompilerPlugins <span class="symbol">:</span>= <span class="keyword">true</span>

libraryDependencies &lt;+= scalaVersion { v =&gt; compilerPlugin(
<span class="string">"org.scala-lang.plugins"</span> % <span class="string">"continuations"</span> % v) }

scalacOptions += <span class="string">"-P:continuations:enable"</span>

libraryDependencies += <span class="string">"com.typesafe.akka."</span> <span class="string">%% " akka-dataflow" %</span> <span class="string">"2.1.0"</span>
</pre></td></tr></table></figure>

<p>A dataflow variable is like a single-assignment variable.
Once the value is bound, it won’t change,
and any subsequent attempt to bind a new value will be ignored.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>// dataflow variable
// Here Akka Promise is used to <span class="operator"><span class="keyword">create</span> a dataflow variable.
// A Promise <span class="keyword">is</span> a <span class="keyword">read</span> handle <span class="keyword">to</span> a <span class="keyword">value</span> that will
// be available <span class="keyword">at</span> <span class="keyword">some</span> point <span class="keyword">in</span> the future.
val messageFromFuture = Promise[String]()

// <span class="keyword">Any</span> dataflow operation <span class="keyword">is</span> performed <span class="keyword">in</span> the Future.flow block:
Future.flow {
  messageFromFuture()
}</span>
</pre></td></tr></table></figure>

<p>The preceding call will wait in a thread unless a value is bound to messageFromFuture.
Future.flow returns a Future so you can perform other operations without blocking
the main thread of execution. Think of a Future as a data structure to retrieve the
result of some concurrent operation. To assign a value to a dataflow variable, use the
<code>&lt;&lt;</code> method as in the following:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>Future<span class="preprocessor">.flow</span> {
  messsageFromFuture &lt;&lt; <span class="string">"Future looks very cool"</span>
}
</pre></td></tr></table></figure>

<p>Once a value is bound to a dataflow variable,
all the Futures that are waiting on the
value will be unblocked and able to continue with execution. </p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre>importimportimportakka.actor._
akka.dispatch._
Future.flow

<span class="class"><span class="keyword">object</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">App</span> {</span>
  implicit <span class="keyword">val</span> system = ActorSystem(<span class="string">"dataflow"</span>)
  <span class="keyword">val</span> messageFromFuture, rawMessage, parsedMessage = Promise[String]()
  flow {
    messageFromFuture &lt;&lt; parsedMessage()
    println(<span class="string">"z = "</span> + messageFromFuture())
  }
  flow { rawMessage &lt;&lt; <span class="string">"olleh"</span> }
  flow { parsedMessage &lt;&lt; toPresentFormat(rawMessage()) }
  <span class="keyword">def</span> toPresentFormat (s: String) = s.reverse
}
</pre></td></tr></table></figure>

<h1 id="building-a-real-time-pricing-system-akkaoogle">Building a real-time pricing system: Akkaoogle</h1>
<p>You’ll build a large web-based product search site
called Akkaoogle (see figure 12.4). It will be similar to Google’s
product search application (www.google.com/products) except that,
instead of returning all products matching your criteria,
your application will only return the cheapest deal found on
the web.</p>
<p>It gets the product price from two types of vendors
that are offering the product.
You can pay money to Akkaoogle and become an
internal vendor.
In this case, the product information is stored in Akkaoogle,
and you pay a small service charge.
You can also sign up as external vendor,
in which case Akkaoogle makes a RESTful web
service call to fetch the price -- but the downside is
you pay a bigger service charge. </p>
<p>When the user is looking for the cheapest deal,
Akkaoogle checks with all the vendors (internal and external)
and finds the lowest price for the user.</p>
<p>You have to find the cheapest deal in no more than
200 to 300 milliseconds.</p>
<h2 id="the-high-level-architecture-of-akkaoogle">The high-level architecture of Akkaoogle</h2>
<p><img src="/img/akkaoogle.png" alt="akkaoogle"></p>
<ul>
<li>Request handler—This is an actor that handles HTTP requests from the user.
You’ll use an asynchronous HTTP library called Mist, provided by Akka, to
implement this actor.</li>
<li>Search cheapest product—This is the main entry point to execute a search to find
the cheapest deal. This actor will search both internal and external vendors.</li>
<li>Internal load balancer—This is a load-balancing actor that sends messages to
worker actors to find the cheapest product available in the internal database.</li>
<li>External load balancer—This actor invokes all the external vendor services and
finds the cheapest price among them.</li>
<li>Find product price and find vendor price —The worker actors do the work of finding
the price.</li>
<li>Monitor—A simple monitor actor logs the failures that happen in external ven-
dor services.</li>
<li>Data loader—An actor that loads data to the database. This could be used to
load product data for internal vendors.</li>
</ul>
<h2 id="setting-up-the-project-for-akkaoogle">Setting up the project for Akkaoogle</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="code"><pre><span class="comment">// Build.scala</span>
<span class="class"><span class="keyword">object</span> <span class="title">H2TaskManager</span> {</span>
  <span class="keyword">var</span> process: Option[Process] = None
  <span class="keyword">lazy</span> <span class="keyword">val</span> H2 = config(<span class="string">"h2"</span>) extend(Compile)
  <span class="keyword">val</span> startH2 = TaskKey[Unit](<span class="string">"start"</span>, <span class="string">"Starts H2 database"</span>)
  <span class="keyword">val</span> startH2Task =
  startH2 in H2 &lt;&lt;= (fullClasspath in Compile) map { cp =&gt;
      startDatabase(cp.map(_.data).map(_.getAbsolutePath()).filter(_.contains(
      <span class="string">"h2database"</span>)))}
  <span class="keyword">def</span> startDatabase(paths: Seq[String]) = {
    process <span class="keyword">match</span> {
      <span class="keyword">case</span> None =&gt;
        <span class="keyword">val</span> cp = paths.mkString(System.getProperty(<span class="string">"path.seperator"</span>))
        <span class="keyword">val</span> command = <span class="string">"java -cp "</span> + cp + <span class="string">" org.h2.tools.Server"</span>
        println(<span class="string">"Starting Database with command: "</span> + command)
        process = Some(Process(command).run())
        println(<span class="string">"Database started ! "</span>)
      <span class="keyword">case</span> Some(_) =&gt;
        println(<span class="string">"H2 Database already started"</span>)
    }
  }
  <span class="keyword">val</span> stopH2 = TaskKey[Unit](<span class="string">"stop"</span>, <span class="string">"Stops H2 database"</span>)
  <span class="keyword">val</span> stopH2Task = stopH2 in H2 :={
    process <span class="keyword">match</span> {
      <span class="keyword">case</span> None =&gt; println(<span class="string">"Database already stopped"</span>)
      <span class="keyword">case</span> Some(_) =&gt;
        println(<span class="string">"Stopping database..."</span>)
        process.foreach{_.destroy()}
        process = None
        println(<span class="string">"Database stopped..."</span>)
    }
  }
}

<span class="class"><span class="keyword">object</span> <span class="title">AkkaoogleBuild</span> <span class="keyword">extends</span> <span class="title">Build</span> <span class="keyword">with</span> <span class="title">ConfigureScalaBuild</span> {</span>
  <span class="keyword">import</span> H2TaskManager._
  <span class="keyword">lazy</span> <span class="keyword">val</span> root = project(id = <span class="string">"akkaoogle"</span>, base = file(<span class="string">"."</span>))
    .settings(startH2Task, stopH2Task)
    .settings(
      organization := <span class="string">"scalainaction"</span>,
      scalaVersion := <span class="string">"2.10.0"</span>,
      scalacOptions ++= Seq(<span class="string">"-unchecked"</span>, <span class="string">"-deprecation"</span>),
      resolvers +=
      <span class="string">"Typesafe Repo"</span> at <span class="string">"http://repo.typesafe.com/typesafe/repo"</span>,
      parallelExecution in Test := <span class="keyword">false</span>
    )
    .settings(
      libraryDependencies ++= Seq(
        <span class="string">"com.typesafe.akka"</span> % <span class="string">"akka-actor"</span> % <span class="string">"2.1.0"</span>,
        <span class="string">"com.typesafe.akka"</span> % <span class="string">"akka-remote"</span> % <span class="string">"2.1.0"</span>,
        <span class="string">"com.typesafe.akka"</span> % <span class="string">"akka-agent"</span> % <span class="string">"2.1.0"</span>,
        <span class="string">"org.specs2"</span> %% <span class="string">"specs2"</span> % <span class="string">"1.13"</span> % <span class="string">"test"</span>,
        <span class="string">"com.h2database"</span> % <span class="string">"h2"</span> % <span class="string">"1.2.127"</span>,
        <span class="string">"org.squery1"</span> % <span class="string">"squery1_2.10.0-RC5"</span> % <span class="string">"0.9.5-5"</span>,
        <span class="string">"org.eclipse.jetty"</span> % <span class="string">"jetty-distribution"</span> % <span class="string">"8.0.0.M2"</span>)
    )
}
</pre></td></tr></table></figure>

<p>I test drove most of the application,
but I won’t show you test cases here.
I encourage you to go through the test cases
in this chapter’s accompanying codebase.</p>
<h2 id="implementing-the-domain-models">Implementing the domain models</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="code"><pre><span class="comment">//  create a common trait called Model that extends the KeyedEntity trait</span>
<span class="comment">//  This trait provides an id field that acts as a primary key</span>

implicit <span class="keyword">val</span> transactionFailures: Table[TransactionFailure] = AkkaoogleSchema.transactionFailures
implicit <span class="keyword">val</span> vendors: Table[ExternalVendor] = AkkaoogleSchema.vendors
implicit <span class="keyword">val</span> products: Table[Product] = AkkaoogleSchema.products
<span class="class"><span class="keyword">trait</span> <span class="title">Model</span>[<span class="title">A</span>] <span class="keyword">extends</span> <span class="title">KeyedEntity</span>[<span class="title">Long</span>] {</span> <span class="keyword">this</span>: A =&gt;
  <span class="keyword">val</span> id: Long = <span class="number">0</span>
  <span class="keyword">def</span> save(implicit table: Table[A]): Either[Throwable, String] = {
    tx {
      <span class="keyword">try</span> {
        table.insert(<span class="keyword">this</span>)
        Right(<span class="string">"Domain object is saved successfully"</span>)
      } <span class="keyword">catch</span> {
        <span class="keyword">case</span> exception =&gt; Left(exception)
      }
    }
  }

}

<span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(val description: String,
              val vendorName: String,
              val basePrice: Double,
              val plusPercent: Double)</span> <span class="keyword">extends</span> <span class="title">Model</span>[<span class="title">Product</span>] {</span>
  <span class="keyword">def</span> calculatePrice = basePrice + (basePrice * plusPercent / <span class="number">100</span>)
}
              
<span class="class"><span class="keyword">class</span> <span class="title">ExternalVendor</span><span class="params">(val name: String, val url: String)</span></span>
      <span class="keyword">extends</span> Model[ExternalVendor]

<span class="comment">//  You’ll log (to the database) every time a call to</span>
<span class="comment">// an external vendor service fails </span>
<span class="class"><span class="keyword">class</span> <span class="title">TransactionFailure</span><span class="params">(val vendorId: String,
        val message: String,
        val timestamp: Date)</span> <span class="keyword">extends</span> <span class="title">Model</span>[<span class="title">TransactionFailure</span>]</span>

<span class="class"><span class="keyword">object</span> <span class="title">TransactionFailure</span> {</span>
  <span class="keyword">def</span> findAll = tx {
    from(transactionFailures)(s =&gt; select(s)) map(s =&gt; s)
  }
}

<span class="class"><span class="keyword">object</span> <span class="title">Product</span> {</span>
  <span class="keyword">def</span> findByDescription(description: String): Option[Product] =
    tx {
      products.where(p =&gt; p.description like description).headOption
    }
}

<span class="class"><span class="keyword">object</span> <span class="title">ExternalVendor</span> {</span>
  <span class="keyword">def</span> findAll = tx {
    from(vendors)(s =&gt; select(s)) map(s =&gt; s)
  }
}
</pre></td></tr></table></figure>

<p>Schema</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre>package com.akkaoogle.db
import org.squeryl._
import org.squeryl.adapters._
import org.squeryl.PrimitiveTypeMode._
import java.sql.DriverManager
import com.akkaoogle.db.models._

object AkkaoogleSchema extends Schema {
  val products = table[<span class="link_label">Product</span>](<span class="link_url">"PRODUCTS"</span>)
  val vendors = table[<span class="link_label">ExternalVendor</span>](<span class="link_url">"VENDORS"</span>)
  val transactionFailures = table[<span class="link_label">TransactionFailure</span>](<span class="link_url">"TRANSACTION_LOG"</span>)
  def init = {
<span class="code">    import org.squeryl.SessionFactory</span>
<span class="code">    Class.forName("org.h2.Driver")</span>
<span class="code">    if(SessionFactory.concreteFactory.isEmpty) {</span>
<span class="code">      SessionFactory.concreteFactory = Some(()=&gt;</span>
<span class="code">        Session.create(</span>
<span class="code">          DriverManager.getConnection("jdbc:h2:tcp://localhost/~/test", "sa", ""),</span>
<span class="code">          new H2Adapter))</span>
<span class="code">    }</span>
  }
  def tx[<span class="link_label">A</span>](<span class="link_url">a: =&gt;A</span>): A = {
<span class="code">    init</span>
<span class="code">    inTransaction(a)</span>
  }
  def createSchema() {
<span class="code">    tx { drop ; create }</span>
  }
}
</pre></td></tr></table></figure>

<h2 id="implementing-the-core-with-actors">Implementing the core with actors</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="keyword">package</span> com.akkaoogle.calculators
<span class="comment">// deal on the web and track the availability of the external services for quality purposes</span>
<span class="class"><span class="keyword">object</span> <span class="title">messages</span> {</span>
  <span class="comment">// represents a request triggered by a user looking for the cheapest deal.</span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">FindPrice</span><span class="params">(productDescription: String, quantity: Int)</span></span>
  <span class="comment">// The response of the FindPrice message</span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">LowestPrice</span><span class="params">(vendorName: String,
  case class LogTimeout(actorId: String, msg: String)</span></span>
  <span class="comment">//  The FindStats and Stats messages are used for administration purposes</span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">FindStats</span><span class="params">(actorId: String)</span></span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">Stats</span><span class="params">(actorId: String, timeouts: Int)</span></span>
}
</pre></td></tr></table></figure>

<p>The InternalPriceCalculator actor calculates the lowest price by looking
up the product by description, shown in the following listing.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</pre></td><td class="code"><pre><span class="keyword">package</span> com.akkaoogle.calculators
<span class="keyword">import</span> messages._
<span class="keyword">import</span> com.akkaoogle.db.models._
<span class="keyword">import</span> akka.actor._
<span class="class"><span class="keyword">class</span> <span class="title">InternalPriceCalculator</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> FindPrice(productDescription, quantity) =&gt;
      <span class="keyword">val</span> price = calculatePrice(productDescription, quantity)
      sender ! price
  }
  <span class="keyword">def</span> calculatePrice( productDescription: String, qty: Int): Option[LowestPrice] = {
    Product.findByDescription(productDescription) map { product =&gt;
      Some(
        LowestPrice(product.vendorName,
                    product.description,
                    product.calculatePrice * qty) )
    } getOrElse Option.empty[LowestPrice]
  }
}
<span class="comment">//  you can have many external vendors for your application, you can’t make</span>
<span class="comment">// the remote service calls sequentially</span>
<span class="comment">// set a timeout for each service so you can</span>
<span class="comment">// respond to the user within a reasonable time</span>
<span class="class"><span class="keyword">class</span> <span class="title">ExternalVendorProxyActor</span><span class="params">(val v: ExternalVendor)</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">var</span> result: Option[LowestPrice] = Option.empty[LowestPrice]
    <span class="keyword">val</span> f = Future({
      <span class="keyword">val</span> params = <span class="string">"?pd="</span> + fp.productDescription + <span class="string">"&q="</span> + fp.quantity
      <span class="keyword">val</span> price = Source.fromURL(v.url + params).mkString.toDouble
      Some(LowestPrice(v.name, fp.productDescription, price * fp.quantity))
    }) recover { <span class="keyword">case</span> t =&gt; Option.empty[LowestPrice] }
    f pipeTo sender
  }
}

<span class="comment">// You need the actor in the following listing to broadcast</span>
<span class="comment">// the FindPrice message to each proxy actor</span>

<span class="comment">// The ExternalPriceCalculator actor is created with references to ExternalVendorProxyActor.</span>
<span class="comment">// The FindPrice message is broadcast to all the proxy actors using the ? method</span>
<span class="class"><span class="keyword">class</span> <span class="title">ExternalPriceCalculator</span><span class="params">(val proxies: Iterable[ActorRef])</span></span>
      <span class="keyword">extends</span> Actor {
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> FindPrice(productId, quantity) =&gt;
      <span class="keyword">val</span> futures = proxies map { proxy =&gt;
        <span class="keyword">val</span> fp = FindPrice(productId, quantity)
        
        (proxy ? fp).mapTo[Option[LowestPrice]] recover {
          <span class="keyword">case</span> e: AskTimeoutException =&gt;
            AkkaoogleActorServer.lookup(<span class="string">"monitor"</span>) ! LogTimeout(proxy.path.name, <span class="string">"Timeout for "</span> + fp)
            Option.empty[LowestPrice]
          }
      }
      <span class="keyword">val</span> lowestPrice: Future[Option[LowestPrice]] =
        findLowestPrice(futures)
      <span class="keyword">val</span> totalPrice: Future[Option[LowestPrice]] = lowestPrice.map {
        l =&gt; l.map(p =&gt; p.copy(price = p.price + (p.price * <span class="number">.02</span>)))
      }
      totalPrice pipeTo sender
  }
}  

<span class="keyword">def</span> findLowestPrice(futures: Iterable[Future[Option[LowestPrice]]]):
    Future[Option[LowestPrice]] = {
  <span class="keyword">val</span> f: Future[Option[LowestPrice]] = Future.fold(futures)(Option.empty[LowestPrice]) {
    (lowestPrice: Option[LowestPrice], currentPrice: Option[LowestPrice]) =&gt; {
      currentPrice <span class="keyword">match</span> {
        <span class="keyword">case</span> Some(first) <span class="keyword">if</span> (lowsetPrice.isEmpty) =&gt; Some(first)
        <span class="keyword">case</span> Some(c) <span class="keyword">if</span> (c.price &lt; lowestPrice.get.price) =&gt; Some(c)
        <span class="keyword">case</span> _ =&gt; lowestPrice
      }
    }
  }
  f
}

<span class="comment">// find the lowest price from both internal and external vendors and return the result.</span>
<span class="class"><span class="keyword">class</span> <span class="title">CheapestDealFinder</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> req: FindPrice =&gt;
      <span class="keyword">val</span> internalPrice =
        (AkkaoogleActorServer.lookup(<span class="string">"internal-load-balancer"</span>) ? req).mapTo[Option[LowestPrice]]
      <span class="keyword">val</span> externalPrice =
        (AkkaoogleActorServer.lookup(<span class="string">"external-load-balancer"</span>) ?
          req).mapTo[Option[LowestPrice]] recover {
            <span class="keyword">case</span> e: AskTimeoutException =&gt; Option.empty[LowestPrice]
        }
      <span class="keyword">val</span> lowestPrice: Future[Option[LowestPrice]] = findLowestPrice(internalPrice :: externalPrice :: Nil)
      lowestPrice pipeTo sender
  }
}
</pre></td></tr></table></figure>

<h2 id="increase-scalability-with-remote-actors-dispatchers-and-routers">Increase scalability with remote actors, dispatchers, and routers</h2>
<p>Akka comes with special kinds of actors called routers, which can
effectively route messages between multiple instances of actors. The router actor acts
as a gateway to a collection of actors. You send a message to the router actor, and the
router actor forwards the message to one of the actors, based on some routing policy.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre>//  <span class="operator">the</span> SmallestMailboxRouter router routes messages based <span class="command"><span class="keyword">on</span> <span class="title">the</span> <span class="title">mailbox</span>.</span><span class="comment">
// creates 10 instances of CheapestDealFinder actors and</span><span class="comment">
// creates a SmallestMailboxRouter to route messages to them</span>
val cheapestDealFinderLoadBalancer = <span class="keyword">system</span>.actorOf(
  Props[CheapestDealFinder].withRouter(SmallestMailboxRouter(nrOfInstances = <span class="number">10</span>)),
  name = <span class="string">"cheapest-deal-finder-balancer"</span>)
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="keyword">val</span> internalPriceCalculators: List[ActorRef] = createInternalPriceCalculators(<span class="number">10</span>)

<span class="comment">// RoundRobinRouter routes messages to actors in round-robin fashion. </span>
<span class="keyword">val</span> internalLoadBalancer = system.actorOf(<span class="number">1</span>
    Props[InternalPriceCalculator]
  .withRouter(RoundRobinRouter (routees = internalPriceCalculators)),
  name = <span class="string">"internal-load-balancer"</span>)
  
<span class="keyword">val</span> proxies = createExternalProxyActors(ExternalVendor.findAll)

<span class="keyword">val</span> externalPriceCalculators: List[ActorRef] = createExternalPriceCalculators(<span class="number">10</span>, proxies)

<span class="keyword">val</span> externalLoadBalancer = system.actorOf(
    Props [ExternalPriceCalculator]
  .withRouter(RoundRobinRouter(routees = externalPriceCalculators)),
  name=<span class="string">"external-load-balancer"</span>)
</pre></td></tr></table></figure>

<p>Instead of allowing the router to create the actor instances,
the instances are passed as a parameter(they are called routees).</p>
<h3 id="improve-performance-with-dispatchers">IMPROVE PERFORMANCE WITH DISPATCHERS</h3>
<p>Every actor system has a default dispatcher that’s used if nothing is configured.
In Akka, message dispatchers are the engine behind the actors that makes Actor run.</p>
<p>Think of a dispatcher as a service with a thread pool that knows how to execute actors
when a message is received.</p>
<p>But if you notice some contention on a single dispatcher, you can start creating
dedicated dispatchers for a group of actors. </p>
<p>Remember, all the actors are created from the same actor system.
You can easily configure the default dispatcher by adding more threads to it</p>
<ul>
<li>Dispatcher—The default dispatcher used by the actor system. It’s an event-based
dispatcher that binds actors to a thread pool. It creates one mailbox per actor.</li>
<li>PinnedDispatcher—Dedicates one thread per actor. It’s like creating thread-based actors.</li>
<li>BalancingDispatcher—This event-driven dispatcher redistributes work from busy
actors to idle actors. All the actors of the same type share one mailbox.</li>
<li>CallingThreadDispatcher—It runs the actor on the calling thread.
It doesn’t create any new thread. Great for unit testing purposes.</li>
</ul>
<p>Using dispatchers in Akka is a simple two-step process: first,
specify them in the configuration file, then set up the actor with the dispatcher. </p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre>akkaoogle {
  dispatchers {
    external-price-calculator-actor-dispatcher {
      # Dispatcher is the name <span class="keyword">of</span> the event-based dispatcher
      <span class="class"><span class="keyword">type</span> =</span> Dispatcher
      # What kind <span class="keyword">of</span> ExecutionService <span class="keyword">to</span> <span class="keyword">use</span>
      executor = <span class="string">"fork-join-executor"</span>
      # Configuration <span class="keyword">for</span> the fork-join pool
      fork-join-executor {
        # Min number <span class="keyword">of</span> threads <span class="keyword">to</span> cap factor-based parallelism number <span class="keyword">to</span>
        parallelism-min = <span class="number">2</span>
        # Parallelism (threads) ... ceil(available processors * factor)
        parallelism-factor = <span class="number">2.0</span>
        # Max number <span class="keyword">of</span> threads <span class="keyword">to</span> cap factor-based parallelism number t
        parallelism-max = <span class="number">100</span>
      }
      # Throughput defines the maximum number <span class="keyword">of</span> messages <span class="keyword">to</span> be
      # processed per actor before the thread jumps <span class="keyword">to</span> the next actor.
      # Set <span class="keyword">to</span> <span class="number">1</span> <span class="keyword">for</span> <span class="keyword">as</span> fair <span class="keyword">as</span> possible.
      throughput = <span class="number">100</span>
    }
    <span class="keyword">internal</span>-price-calculator-actor-dispatcher {
      # Dispatcher is the name <span class="keyword">of</span> the event-based dispatcher
      <span class="class"><span class="keyword">type</span> =</span> BalancingDispatcher
      # What kind <span class="keyword">of</span> ExecutionService <span class="keyword">to</span> <span class="keyword">use</span>
      executor = <span class="string">"thread-pool-executor"</span>
      thread-pool-executor {
        # Minnumber <span class="keyword">of</span> threads <span class="keyword">to</span> cap factor-based core number <span class="keyword">to</span>
        core-pool-size-min = <span class="number">5</span>
      }
    }

  }
}
</pre></td></tr></table></figure>

<p>To use these dispatchers you will use the withDispatcher method of Props, as in
the following:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="keyword">private</span> def <span class="title">createInternalPriceCalculators</span>(initialLoad: Int)
     (<span class="keyword">implicit</span> system: ActorSystem) = {
  (<span class="keyword">for</span> (i &lt;- <span class="number">0</span> until initialLoad) <span class="keyword">yield</span>
    system.actorOf(Props[InternalPriceCalculator]
      .withDispatcher(<span class="string">"dispatchers.internal-price-calculator-actor-dispatcher"</span>),
    name=(<span class="string">"internal-price-calculator"</span> + i))).toList
}

<span class="keyword">private</span> def <span class="title">createExternalPriceCalculators</span>(initialLoad: Int,
     proxies: List[ActorRef])(<span class="keyword">implicit</span> system: ActorSystem) = {
  (<span class="keyword">for</span> (i &lt;- <span class="number">0</span> until initialLoad) <span class="keyword">yield</span> system.actorOf(
    Props(<span class="keyword">new</span> ExternalPriceCalculator(proxies))
      .withDispatcher(<span class="string">"dispatchers.external-price-calculator-actor-dispatcher"</span>),
    name = (<span class="string">"external-price-calculator"</span> + i))).toList
}
</pre></td></tr></table></figure>

<h2 id="handling-shared-resources-with-agent">Handling shared resources with Agent</h2>
<p>The monitor actor needs to log any transaction failure with external vendors. You
can always extend its functionality for internal use, but for now it needs to handle the
following two message types:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">LogTimeout</span><span class="params">(actorId: String, msg: String)</span></span>
<span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">FindStats</span><span class="params">(actorId: String)</span></span>
</pre></td></tr></table></figure>

<p>To build the monitoring piece for the Akkaoogle application, you have to rely on a
shared mutable state, and this section shows you how to put Agent to use.</p>
<p>The monitor actor needs to log any transaction failure with external vendors.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">LogTimeout</span><span class="params">(actorId: String, msg: String)</span></span>
<span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">FindStats</span><span class="params">(actorId: String)</span></span>
</pre></td></tr></table></figure>

<p>On receiving a LogTimeout message, it needs to save the transaction
failure information to the database and also keep track of
the number of times a particular service failed.</p>
<p>The side effect that’s saving information to the database
can’t be done safely within an STM transaction, because an STM transaction
could retry the operations in a transaction multiple times
if there’s any read/write inconsistency.
If you use Agent, it can participate in the STM transaction and
get executed only when the STM transaction completes successfully.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="keyword">package</span> com.akkaoogle.infrastructure
<span class="keyword">import</span> akka.agent.Agent
<span class="keyword">import</span> akka.actor.Actor
<span class="keyword">import</span> com.akkaoogle.calculators.messages.{Stats, FindStats, LogTimeout}
<span class="keyword">import</span> java.util.Date
<span class="keyword">import</span> com.akkaoogle.db.models._
<span class="class"><span class="keyword">class</span> <span class="title">MonitorActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">import</span> context._
  
  <span class="keyword">val</span> errorLogger = Agent(Map.empty[String, Int])
  <span class="comment">// ideally you may want to save the existing error count in some persistence</span>
  <span class="comment">// storage so you can fetch the errors for later use.</span>
  <span class="keyword">def</span> preRestart = errorLogger send { old =&gt; Map.empty[String, Int] }
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> LogTimeout(actorId, msg) =&gt;
      logTimeout(actorId, msg)
    <span class="keyword">case</span> FindStats(actorId) =&gt;
      <span class="keyword">val</span> timeouts = errorLogger().getOrElse(actorId, <span class="number">0</span>)
      sender ! Stats(actorId, timeouts = timeouts)
    }

  <span class="keyword">private</span> <span class="keyword">def</span> logTimeout(actorId: String, msg: String): Unit = {
    errorLogger send { errorLog =&gt;
      <span class="keyword">val</span> current = errorLog.getOrElse(actorId, <span class="number">0</span>)
      <span class="keyword">val</span> newErrorLog = errorLog + (actorId -&gt; (current + <span class="number">1</span>))
      <span class="keyword">val</span> l = <span class="keyword">new</span> TransactionFailure(actorId, msg, <span class="keyword">new</span> Date(System.currentTimeMillis))
      l.save
      newErrorLog
    }
  }
}
</pre></td></tr></table></figure>

<h2 id="setting-up-play2-mini">Setting up Play2-mini</h2>
<p>Play2-mini is a lightweight REST framework on top of the Play2 framework. It maps an
HTTP request to a function that takes an HTTP request and returns a response.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre><span class="class"><span class="keyword">trait</span> <span class="title">ConfigureScalaBuild</span> {</span>
  <span class="keyword">lazy</span> <span class="keyword">val</span> typesafe = <span class="string">"Typesafe Repository"</span> at <span class="string">"http://repo.typesafe.com/typesafe/releases/"</span>
  <span class="keyword">lazy</span> <span class="keyword">val</span> typesafeSnapshot = <span class="string">"Typesafe Snapshots Repository"</span> at <span class="string">"http://repo.typesafe.com/typesafe/snapshots/"</span>
  <span class="keyword">val</span> netty = Some(<span class="string">"play.core.server.NettyServer"</span>)
  <span class="keyword">def</span> scalaMiniProject(org: String, name: String, buildVersion: String,
        baseFile: java.io.File = file(<span class="string">"."</span>)) =
    Project(id = name, base = baseFile, settings = Project.defaultSettings).settings(
      version := buildVersion,
      organization := org,
      resolvers += typesafe,
      resolvers += typesafeSnapshot,
      libraryDependencies += <span class="string">"com.typesafe"</span> %% <span class="string">"play-mini"</span> % <span class="string">"2.1=RC2"</span>,
      mainClass in (Compile, run) := netty,
      ivyXML := &lt;dependencies&gt; &lt;exclude org=<span class="string">"org.springframework"</span>/&gt;&lt;/dependencies&gt;
    )
}

importimportsbt._
Keys._
<span class="class"><span class="keyword">object</span> <span class="title">AkkaoogleBuild</span> <span class="keyword">extends</span> <span class="title">Build</span> <span class="keyword">with</span> <span class="title">ConfigureScalaBuild</span> {</span>
  <span class="keyword">import</span> H2TaskManager._
  <span class="keyword">lazy</span> <span class="keyword">val</span> root =
    scalaMiniProject(<span class="string">"com.akkaoogle"</span>,<span class="string">"akkaoogle"</span>,<span class="string">"1.0"</span>)
      .settings(startH2Task, stopH2Task)
      .settings(
        organization := <span class="string">"scalainaction"</span>,
        scalaVersion := <span class="string">"2.10.0"</span>,
        scalacOptions ++= Seq(<span class="string">"-unchecked"</span>, <span class="string">"-deprecation"</span>),
        resolvers += <span class="string">"Typesafe Repo"</span> at <span class="string">"http://repo.typesafe.com/typesafe/repo"</span>,
        parallelExecution in Test := <span class="keyword">false</span>
      ).settings(
      libraryDependencies ++= Seq(
        <span class="string">"com.typesafe.akka"</span> %% <span class="string">"akka-actor"</span> % <span class="string">"2.1.0"</span>,
        <span class="string">"com.typesafe.akka"</span> %% <span class="string">"akka-remote"</span> % <span class="string">"2.1.0"</span>,
        <span class="string">"com.typesafe.akka"</span> %% <span class="string">"akka-agent"</span> % <span class="string">"2.1.0"</span>,
        <span class="string">"com.h2database"</span> % <span class="string">"h2"</span> % <span class="string">"1.2.127"</span>,
        <span class="string">"org.squeryl"</span> % <span class="string">"squery1_2.10-RC5"</span> % <span class="string">"0.9.5-5"</span>,
        <span class="string">"org.specs2"</span> %% <span class="string">"specs2"</span> % <span class="string">"1.13"</span> % <span class="string">"test"</span>,
        <span class="string">"org.eclipse.jetty"</span> % <span class="string">"jetty-distribution"</span> % <span class="string">"8.0.0.M2"</span> % <span class="string">"test"</span>)
      )
}
</pre></td></tr></table></figure>

<h3 id="running-with-play2-mini">Running with Play2-mini</h3>
<p>Play2-mini–based application needs to implement <code>com.typesafe.play.mini.Setup</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="keyword">package</span> com.typesafe.play.mini
<span class="class"><span class="keyword">class</span> <span class="title">Setup</span><span class="params">(a: Application)</span> <span class="keyword">extends</span> <span class="title">GlobalSettings</span> {</span>
  ...
}
<span class="comment">// Think of Application as a controller of the MVC model that handles all the requests.</span>
<span class="keyword">package</span> com.typesafe.play.mini
<span class="class"><span class="keyword">trait</span> <span class="title">Application</span> {</span>
  <span class="comment">// you have to implement is the routes method</span>
  <span class="keyword">def</span> route: PartialFunction[RequestHeader, Handler]
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre>import <span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.infrastructure</span>._
import org<span class="preprocessor">.h</span>2<span class="preprocessor">.tools</span><span class="preprocessor">.Server</span>
import <span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.db</span><span class="preprocessor">.AkkaoogleSchema</span>._

//  <span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.http</span><span class="preprocessor">.App</span> will handle all the HTTP requests for the Akkaoogle application. 
object Global extends <span class="keyword">com</span><span class="preprocessor">.typesafe</span><span class="preprocessor">.play</span><span class="preprocessor">.mini</span><span class="preprocessor">.Setup</span>(<span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.http</span><span class="preprocessor">.App</span>) {
  println(<span class="string">"initializing the Akkaoogle schema"</span>)
  //  initialize the various parts
  createSchema()
  AkkaoogleActorServer<span class="preprocessor">.run</span>()
}

package <span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.http</span>
import <span class="keyword">com</span><span class="preprocessor">.typesafe</span><span class="preprocessor">.play</span><span class="preprocessor">.mini</span>._
import play<span class="preprocessor">.api</span><span class="preprocessor">.mvc</span>._
import play<span class="preprocessor">.api</span><span class="preprocessor">.mvc</span><span class="preprocessor">.Results</span>._
import <span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.infrastructure</span>._
import akka<span class="preprocessor">.pattern</span>.{ ask, pipe, AskTimeoutException }
import <span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.calculators</span><span class="preprocessor">.messages</span>._
import play<span class="preprocessor">.api</span><span class="preprocessor">.libs</span><span class="preprocessor">.concurrent</span>._
import scala<span class="preprocessor">.collection</span><span class="preprocessor">.JavaConverters</span>._

object App extends Application {
  def route = {
    case GET(Path(<span class="string">"/"</span>)) =&gt; Action { request =&gt;
      Ok(views<span class="preprocessor">.index</span>())<span class="preprocessor">.as</span>(<span class="string">"text/html"</span>)
    }
    case GET(Path(<span class="string">"/akkaoogle/search"</span>)) & QueryString(qs) =&gt;
      Action { request =&gt;
        val desc = QueryString(qs, <span class="string">"productDescription"</span>)<span class="preprocessor">.get</span><span class="preprocessor">.asScala</span>
        val f =
          (AkkaoogleActorServer<span class="preprocessor">.lookup</span>(<span class="string">"cheapest-deal-finder-balancer"</span>) ?
             FindPrice(desc<span class="preprocessor">.head</span>, <span class="number">1</span>))<span class="preprocessor">.mapTo</span>[Option[LowestPrice]]
        val result = f<span class="preprocessor">.map</span>({
          case Some(lowestPrice) =&gt;
            Ok(lowestPrice<span class="preprocessor">.toString</span>)<span class="preprocessor">.as</span>(<span class="string">"text/html"</span>)
          case _ =&gt;
            Ok(<span class="string">"No price found"</span>)<span class="preprocessor">.as</span>(<span class="string">"text/html"</span>)
            Return
        })
        AsyncResult(result<span class="preprocessor">.asPromise</span>)
      }
  }
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="code"><pre>package <span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.infrastructure</span>

import <span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.calculators</span>._
import akka<span class="preprocessor">.actor</span>._
import <span class="keyword">com</span><span class="preprocessor">.akkaoogle</span><span class="preprocessor">.db</span><span class="preprocessor">.models</span>._
import akka<span class="preprocessor">.actor</span>.{ActorRef, Actor}
import akka<span class="preprocessor">.routing</span>._
import <span class="keyword">com</span><span class="preprocessor">.typesafe</span><span class="preprocessor">.config</span><span class="preprocessor">.ConfigFactory</span>

object AkkaoogleActorServer {
  var system: Option[ActorSystem] = None
  def run(): Unit = {
    println(<span class="string">"starting the remote server..."</span>)
    system = Some(ActorSystem(<span class="string">"akkaoogle"</span>, ConfigFactory<span class="preprocessor">.load</span><span class="preprocessor">.getConfig</span>(<span class="string">"akkaoogle"</span>)))
    system<span class="preprocessor">.foreach</span>(s =&gt; register(s))
  }
  
  private def register(implicit system: ActorSystem) {
    val monitor = system<span class="preprocessor">.actorOf</span>(Props[MonitorActor], name = <span class="string">"monitor"</span>)
    
    val cheapestDealFinderLoadBalancer = system<span class="preprocessor">.actorOf</span>(
      Props[CheapestDealFinder]<span class="preprocessor">.withRouter</span>(SmallestMailboxRouter(nrOfInstances = <span class="number">10</span>)),
      name = <span class="string">"cheapest-deal-finder-balancer"</span>)
      
    val internalPriceCalculators: List[ActorRef] = createInternalPriceCalculators(<span class="number">10</span>)
    val internalLoadBalancer = system<span class="preprocessor">.actorOf</span>(
      Props[InternalPriceCalculator]<span class="preprocessor">.withRouter</span>(RoundRobinRouter(routees = internalPriceCalculators)),
      name = <span class="string">"internal-load-balancer"</span>)
      
    val proxies = createExternalProxyActors(ExternalVendor<span class="preprocessor">.findAll</span>)
    val externalPriceCalculators: List[ActorRef] = createExternalPriceCalculators(<span class="number">10</span>, proxies)
    val externalLoadBalancer = system<span class="preprocessor">.actorOf</span>(
      Props [ExternalPriceCalculator]<span class="preprocessor">.withRouter</span>(RoundRobinRouter(routees = externalPriceCalculators)),
      name=<span class="string">"external-load-balancer"</span>)
  }
  
  def lookup(name: String): ActorRef = {
    system map { s =&gt;
      val path = s / name
      s<span class="preprocessor">.actorFor</span>(path)
    } getOrElse(throw new RuntimeException(<span class="string">"No actor found"</span>))
  }
  
  def stop(){
    system<span class="preprocessor">.foreach</span>(_<span class="preprocessor">.shutdown</span>())
  }
  
  private def createExternalProxyActors(vendors: Iterable[ExternalVendor])(implicit system: ActorSystem) = {
    val proxies = for(v &lt;- vendors) yield {
      println(<span class="string">"Creating vendor proxies for "</span> + v<span class="preprocessor">.name</span>)
      val ref = system<span class="preprocessor">.actorOf</span>(Props(new ExternalVendorProxyActor(v))
          <span class="preprocessor">.withDispatcher</span>(<span class="string">"dispatchers.proxy-actor-dispatcher"</span>),name=v<span class="preprocessor">.name</span>)
      ref
    }
    proxies<span class="preprocessor">.toList</span>
  }

  private def createInternalPriceCalculators(initialLoad: Int)(implicit system: ActorSystem) = {
    (for (i &lt;- <span class="number">0</span> until initialLoad) yield
    system<span class="preprocessor">.actorOf</span>(
      Props [InternalPriceCalculator]<span class="preprocessor">.withDispatcher</span>(<span class="string">"dispatchers.internal-price-calculator-actor-dispatcher"</span>),
      name=(<span class="string">"internal-price-calculator"</span> + i)))<span class="preprocessor">.toList</span>
  }
  
  private def createExternalPriceCalculators(
    initialLoad: Int, proxies: List[ActorRef])(
    implicit system: ActorSystem) = {
      (for (i &lt;- <span class="number">0</span> until initialLoad)
        yield
      system<span class="preprocessor">.actorOf</span>(
        Props(new ExternalPriceCalculator(proxies))<span class="preprocessor">.withDispatcher</span>(<span class="string">"dispatchers.external-price-calculator-actor-dispatcher"</span>),
        name = (<span class="string">"external-price-calculator"</span> + i)))<span class="preprocessor">.toList</span>
  }
}
</pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/scala/">scala</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://zhpooer.github.io/2014/07/26/scala-in-action-application-usnig-scala/" data-title="Scala in Action-applications using Akka | Poe&#39;s World" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/07/28/functional-programming-in-scala-函数式编程入门/" title="Functional Programming in Scala-函数式编程入门">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Functional Programming in Scala-函数式编程入门</span>
</a>
</div>


<div class="next">
<a href="/2014/07/25/scala-in-action-java-integration/"  title="Scala in Action-Java integration">
 <strong>NEXT:</strong><br/> 
 <span>Scala in Action-Java integration
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#the-philosophy-behind-akka"><span class="toc-number">1.</span> <span class="toc-text">The philosophy behind Akka</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#simple-concurrency-with-akka"><span class="toc-number">2.</span> <span class="toc-text">Simple concurrency with Akka</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#remote-actors"><span class="toc-number">2.1.</span> <span class="toc-text">Remote actors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#making-mutable-data-safe-with-stm"><span class="toc-number">2.2.</span> <span class="toc-text">Making mutable data safe with STM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#agents"><span class="toc-number">2.3.</span> <span class="toc-text">Agents</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dataflow"><span class="toc-number">2.4.</span> <span class="toc-text">Dataflow</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#building-a-real-time-pricing-system-akkaoogle"><span class="toc-number">3.</span> <span class="toc-text">Building a real-time pricing system: Akkaoogle</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#the-high-level-architecture-of-akkaoogle"><span class="toc-number">3.1.</span> <span class="toc-text">The high-level architecture of Akkaoogle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setting-up-the-project-for-akkaoogle"><span class="toc-number">3.2.</span> <span class="toc-text">Setting up the project for Akkaoogle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#implementing-the-domain-models"><span class="toc-number">3.3.</span> <span class="toc-text">Implementing the domain models</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#implementing-the-core-with-actors"><span class="toc-number">3.4.</span> <span class="toc-text">Implementing the core with actors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#increase-scalability-with-remote-actors-dispatchers-and-routers"><span class="toc-number">3.5.</span> <span class="toc-text">Increase scalability with remote actors, dispatchers, and routers</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#improve-performance-with-dispatchers"><span class="toc-number">3.5.1.</span> <span class="toc-text">IMPROVE PERFORMANCE WITH DISPATCHERS</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#handling-shared-resources-with-agent"><span class="toc-number">3.6.</span> <span class="toc-text">Handling shared resources with Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setting-up-play2-mini"><span class="toc-number">3.7.</span> <span class="toc-text">Setting up Play2-mini</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#running-with-play2-mini"><span class="toc-number">3.7.1.</span> <span class="toc-text">Running with Play2-mini</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/AJAX/" title="AJAX">AJAX<sup>1</sup></a></li>
		
			<li><a href="/tags/Akka/" title="Akka">Akka<sup>1</sup></a></li>
		
			<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
		
			<li><a href="/tags/DOM/" title="DOM">DOM<sup>2</sup></a></li>
		
			<li><a href="/tags/EL表达式/" title="EL表达式">EL表达式<sup>1</sup></a></li>
		
			<li><a href="/tags/HBase/" title="HBase">HBase<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>2</sup></a></li>
		
			<li><a href="/tags/HttpSession/" title="HttpSession">HttpSession<sup>1</sup></a></li>
		
			<li><a href="/tags/IO/" title="IO">IO<sup>1</sup></a></li>
		
			<li><a href="/tags/Illustrator/" title="Illustrator">Illustrator<sup>3</sup></a></li>
		
			<li><a href="/tags/JSP/" title="JSP">JSP<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaBean/" title="JavaBean">JavaBean<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>1</sup></a></li>
		
			<li><a href="/tags/Mybatis/" title="Mybatis">Mybatis<sup>1</sup></a></li>
		
			<li><a href="/tags/NoSql/" title="NoSql">NoSql<sup>1</sup></a></li>
		
			<li><a href="/tags/SASS/" title="SASS">SASS<sup>1</sup></a></li>
		
			<li><a href="/tags/SAX/" title="SAX">SAX<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletRequest/" title="ServletRequest">ServletRequest<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletResponse/" title="ServletResponse">ServletResponse<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://zhpooer.github.io" target="_blank" title="zhpooer">zhpooer</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"zhpoooer"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
