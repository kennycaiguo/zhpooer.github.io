
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>传智播客day64-NoSql | Poe&#39;s World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zhpooer">
    
    <meta name="description" content="NoSql 简介
Not Only SQL, 一系列非关系型数据库的总称
关系型数据库中的表存储一些格式化数据结构,
每条记录的字段的组成都一样, 即使不是每条记录都需要所有字段
非关系型数据库以键值对存储, 结构不固定, 每一条记录可以有不一样的键,
每条记录可以根据需要增加一些自己的键值对.
常">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="Poe&#39;s World" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Poe&#39;s World" title="Poe&#39;s World"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Poe&#39;s World">Poe&#39;s World</a></h1>
				<h2 class="blog-motto">竹杖芒鞋轻胜马，一蓑烟雨任平生</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/english-monthly">英语角</a></li>
					
						<li><a href="/about">关于</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:zhpooer.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/08/09/传智播客day64-nosql/" title="传智播客day64-NoSql" itemprop="url">传智播客day64-NoSql</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://zhpooer.github.io" title="zhpooer">zhpooer</a>
    </p>
  <p class="article-time">
    <time datetime="2014-08-09T01:01:04.000Z" itemprop="datePublished">8月 9 2014</time>
    更新日期:<time datetime="2014-08-10T01:04:55.000Z" itemprop="dateModified">8月 10 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nosql-"><span class="toc-number">1.</span> <span class="toc-text">NoSql 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mongodb-"><span class="toc-number">2.</span> <span class="toc-text">MongoDB 数据库</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">2.2.</span> <span class="toc-text">建表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">2.3.</span> <span class="toc-text">更新</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">3.</span> <span class="toc-text">索引</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">3.1.</span> <span class="toc-text">固定集合</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">4.</span> <span class="toc-text">数据库备份和恢复</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">5.</span> <span class="toc-text">导入和导出</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">6.</span> <span class="toc-text">安全和认证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">7.</span> <span class="toc-text">配置集群 副本集</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.1.</span> <span class="toc-text">主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.2.</span> <span class="toc-text">副本集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.3.</span> <span class="toc-text">分片</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#java-mongodb"><span class="toc-number">8.</span> <span class="toc-text">Java 操作 MongoDB</span></a></li></ol>
		</div>
		
		<h1 id="nosql-">NoSql 简介</h1>
<p>Not Only SQL, 一系列非关系型数据库的总称</p>
<p>关系型数据库中的表存储一些格式化数据结构,
每条记录的字段的组成都一样, 即使不是每条记录都需要所有字段</p>
<p>非关系型数据库以键值对存储, 结构不固定, 每一条记录可以有不一样的键,
每条记录可以根据需要增加一些自己的键值对.</p>
<p>常见的Nosql</p>
<ul>
<li>CouchDB</li>
<li>Redis</li>
<li>Neo4j</li>
<li>HBase</li>
<li>BigTable</li>
<li>Tair</li>
</ul>
<p>优势</p>
<ul>
<li>简单扩展</li>
<li>快速读写</li>
<li>低廉成本</li>
<li>灵活的数据模型 json</li>
</ul>
<p>不足</p>
<ul>
<li>不提供对SQL的支持</li>
<li>特性不够丰富</li>
<li>现有产品不够成熟</li>
<li>事务支持不够好</li>
</ul>
<h1 id="mongodb-">MongoDB 数据库</h1>
<p>C++语言编写, 高性能 易部署 易使用</p>
<ul>
<li>面向集合存储, json</li>
<li>模式自由</li>
<li>支持动态查询</li>
<li>支持完全索引</li>
<li>支持复制和故障恢复</li>
<li>使用高效的二进制数据存储, 包括大型对象</li>
<li>文件存储格式为 BSON</li>
</ul>
<p>关系型数据库和 mongodb 对应情况</p>
<table>
<thead>
<tr>
<th>关系数据库</th>
<th>mongodb</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据库</td>
<td>数据库</td>
</tr>
<tr>
<td>表</td>
<td>集合</td>
</tr>
<tr>
<td>行</td>
<td>文档</td>
</tr>
</tbody>
</table>
<p>文档(document) 是 Mongodb 的最基本对象, 都有一个 objectId, <code>{&quot;id&quot;: ObjectId()}</code></p>
<p>集合(collection)是文档的聚合</p>
<p>0 和 1 也可以表示 true 或 false</p>
<p>数字类型64位浮点数, 整数都会被转换成64位浮点数</p>
<h2 id="-">安装</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="attribute">mongod --dbpath</span>=<span class="string">/var/any
mongo</span>
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="preprocessor">## 创建或者切换</span>
use mydb1;
<span class="preprocessor">## 查看当前数据库</span>
db;
<span class="preprocessor">## 删除数据库</span>
db.dropDatabase();

<span class="preprocessor">## 查看所有数据库信息</span>
show dbs;
</pre></td></tr></table></figure>

<h2 id="-">建表</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td><td class="code"><pre><span class="preprocessor">## 查看集合</span>
show collections<span class="comment">;</span>
show tables<span class="comment">;</span>


<span class="preprocessor">## 创建集合</span>
db<span class="preprocessor">.createCollections</span>(<span class="string">"erdan"</span>)<span class="comment">;</span>
<span class="preprocessor">## 也可以这样创建集合, 隐式创建</span>
db<span class="preprocessor">.collectionName</span><span class="preprocessor">.insert</span>({})<span class="comment">;</span>

<span class="preprocessor">## 删除集合</span>
db<span class="preprocessor">.collectionName</span><span class="preprocessor">.drop</span>()<span class="comment">;</span>

<span class="preprocessor">## 插入文档</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.insert</span>({name:<span class="string">"xxx"</span>, age:<span class="number">18</span>, city:<span class="string">"shanghai"</span>})<span class="comment">;</span>

<span class="preprocessor">## 删除文档</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.remove</span>({name:<span class="string">"xxx"</span>, age:<span class="number">18</span>, city:<span class="string">"shanghai"</span>})<span class="comment">;</span>

<span class="preprocessor">## 查询</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.find</span>()<span class="comment">;</span>

for(var i=<span class="number">1</span><span class="comment">;i&lt;=10000;1++) {</span>
   db<span class="preprocessor">.drhuo</span><span class="preprocessor">.insert</span>({name: <span class="string">"erhuo"</span>+i, age: i, city: <span class="string">"tokyo"</span>})<span class="comment">;</span>
}

<span class="preprocessor">## 显示name字段</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.findOne</span>({}, name:true)<span class="comment">;</span>
<span class="preprocessor">## 除了不显示name, 其他都显示</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.findOne</span>({}, {name: <span class="number">0</span>})<span class="comment">;</span>

<span class="preprocessor">## 删除名字为 erhuo1</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.remove</span>({name: <span class="string">"erhuo1"</span>})<span class="comment">;</span>

var m = db<span class="preprocessor">.erhuo</span><span class="preprocessor">.find</span>()<span class="comment">;</span>
m<span class="preprocessor">.next</span>()<span class="comment">;</span>

<span class="preprocessor">## 条件查找</span>
<span class="preprocessor">## 大于</span>
db<span class="preprocessor">.collection</span><span class="preprocessor">.find</span>({field:{$gt:value}})<span class="comment">;</span>
<span class="preprocessor">## 小于</span>
db<span class="preprocessor">.collection</span><span class="preprocessor">.find</span>({field:{$lt:value}})<span class="comment">;</span>
<span class="preprocessor">## 大于等于</span>
db<span class="preprocessor">.collection</span><span class="preprocessor">.find</span>({field:{$gte:value}})<span class="comment">;</span>
<span class="preprocessor">## 小于等于</span>
db<span class="preprocessor">.collection</span><span class="preprocessor">.find</span>({field:{$lte:value}})<span class="comment">;</span>
<span class="preprocessor">## 不等于</span>
db<span class="preprocessor">.collection</span><span class="preprocessor">.find</span>({field:{$ne:value}})<span class="comment">;</span>

<span class="preprocessor">## 统计</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.count</span>()<span class="comment">;</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.find</span>()<span class="preprocessor">.count</span>()<span class="comment">;</span>
<span class="preprocessor">## 按age升序排序, -1 为降序</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.find</span>()<span class="preprocessor">.sort</span>({age:<span class="number">1</span>})<span class="comment">;</span>

<span class="preprocessor">## 分页</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.find</span>()<span class="preprocessor">.skip</span>(<span class="number">3</span>)<span class="preprocessor">.limit</span>(<span class="number">4</span>)<span class="comment">;</span>

<span class="preprocessor">## 不管分页, 列出所有数据的大小</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.find</span>()<span class="preprocessor">.skip</span>(<span class="number">3</span>)<span class="preprocessor">.limit</span>(<span class="number">4</span>)<span class="preprocessor">.count</span>(<span class="number">0</span>)<span class="comment">;</span>
<span class="preprocessor">## 列出分页数据</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.find</span>()<span class="preprocessor">.skip</span>(<span class="number">3</span>)<span class="preprocessor">.limit</span>(<span class="number">4</span>)<span class="preprocessor">.count</span>(<span class="number">1</span>)<span class="comment">;</span>

db<span class="preprocessor">.c</span>2<span class="preprocessor">.insert</span>({name:<span class="string">"user1"</span>, post:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]})<span class="comment">;</span>
<span class="preprocessor">## 查询包含关系</span>
<span class="preprocessor">## 全部满足</span>
db<span class="preprocessor">.c</span>2<span class="preprocessor">.find</span>({post:{$all:[<span class="number">1</span>, <span class="number">2</span>]}})
<span class="preprocessor">## 只要有一个满足</span>
db<span class="preprocessor">.c</span>2<span class="preprocessor">.find</span>({post:{$<span class="keyword">in</span>:[<span class="number">1</span>, <span class="number">2</span>]}})
<span class="preprocessor">## notin</span>
db<span class="preprocessor">.c</span>2<span class="preprocessor">.find</span>({post:{$nin:[<span class="number">1</span>, <span class="number">2</span>]}})

<span class="preprocessor">## 常用操作</span>
db<span class="preprocessor">.customer</span><span class="preprocessor">.find</span>({$<span class="keyword">or</span>:[{name: <span class="string">"a"</span>}, {age: <span class="number">11</span>}]})

<span class="preprocessor">## 1 表示存在, 0 表示不存在, 存在name字段的文档</span>
db<span class="preprocessor">.customer</span><span class="preprocessor">.find</span>({name: {$exist: <span class="number">1</span>}})<span class="comment">;</span>
</pre></td></tr></table></figure>

<h2 id="-">更新</h2>
<p><code>db.collection.update(criteria, objNew, upsert, multi)</code></p>
<ul>
<li><code>criteria</code>, 查询条件的对象</li>
<li><code>objNew</code>, 根系内容的对象</li>
<li><code>upsert</code>, 如果记录已经更新, 更新它, 否则新增一个记录</li>
<li><code>multi</code>, 如果符合多个记录是否全部更新</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>## 覆盖更新
<span class="tag">db</span><span class="class">.itcast</span><span class="class">.update</span>(<span class="rules">{<span class="rule"><span class="attribute">address</span>:<span class="value"><span class="string">"abc"</span></span></span></span>}, <span class="rules">{<span class="rule"><span class="attribute">address</span>:<span class="value"> <span class="string">"bj"</span></span></span></span>});

<span class="tag">db</span><span class="class">.itcast</span><span class="class">.update</span>(<span class="rules">{<span class="rule"><span class="attribute">name</span>:<span class="value"><span class="string">"user1"</span></span></span></span>}, <span class="rules">{<span class="rule">$<span class="attribute">set</span>:<span class="value">{address: <span class="string">"bj"</span></span></span></span>}}, 0, 1)

## <span class="tag">age</span> + 1
<span class="tag">db</span><span class="class">.itcast</span><span class="class">.update</span>(<span class="rules">{<span class="rule"><span class="attribute">name</span>:<span class="value"><span class="string">"user1"</span></span></span></span>}, <span class="rules">{<span class="rule">$<span class="attribute">inc</span>:<span class="value">{age: <span class="number">1</span></span></span></span>}}, 0, 1)

## 删除键
<span class="tag">db</span><span class="class">.itcast</span><span class="class">.update</span>(<span class="rules">{<span class="rule"><span class="attribute">name</span>:<span class="value"><span class="string">"user1"</span></span></span></span>}, <span class="rules">{<span class="rule">$<span class="attribute">unset</span>:<span class="value">{address: <span class="number">1</span></span></span></span>}}, 0, 1)
</pre></td></tr></table></figure>

<h1 id="-">索引</h1>
<p>用来加速查询速度的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="preprocessor">## 查询性能</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.find</span>({name: <span class="string">"erhuo12"</span>})<span class="preprocessor">.explain</span>()<span class="comment">;</span>

<span class="preprocessor">## 给 name 创建普通索引</span>
db<span class="preprocessor">.erhuo</span><span class="preprocessor">.ensureIndex</span>({name:<span class="number">1</span>})<span class="comment">;</span>

<span class="preprocessor">## 查看系统表相关参数</span>
db<span class="preprocessor">.user</span><span class="preprocessor">.state</span>()<span class="comment">;</span>

db<span class="preprocessor">.erhuo</span><span class="preprocessor">.find</span>({name: <span class="string">"erhuo12"</span>})<span class="preprocessor">.explain</span>()<span class="comment">;</span>

<span class="preprocessor">## 查看生成的索引</span>
db<span class="preprocessor">.system</span><span class="preprocessor">.indexes</span><span class="preprocessor">.find</span>()<span class="comment">;</span>

<span class="preprocessor">## 删除索引</span>
<span class="preprocessor">## 如果删除集合, 那么也会删除索引</span>
db<span class="preprocessor">.user</span><span class="preprocessor">.dropIndex</span>({name:<span class="number">1</span>})<span class="comment">;</span>

<span class="preprocessor">## 创建唯一索引, 相当于唯一约束</span>
db<span class="preprocessor">.user</span><span class="preprocessor">.ensureIndex</span>({name:<span class="number">1</span>}, {unique:<span class="number">1</span>})<span class="comment">;</span>
</pre></td></tr></table></figure>

<h2 id="-">固定集合</h2>
<p>事先创建而且大小固定的集合, 如果空间不足最早的文旦会被删除,
适用于任何想要自动淘汰过期的属性的场景, 如日志</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre>## <span class="keyword">size</span>指定文档大小 单位KB, <span class="keyword">max</span> 指文档数量
db.createCollection(<span class="string">"collectionName"</span>, {capped: true, <span class="keyword">size</span>:<span class="number">10000</span>, <span class="keyword">max</span>: <span class="number">100</span>});
</pre></td></tr></table></figure>

<h1 id="-">数据库备份和恢复</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="comment">## 备份数据</span>
mongodump -h dbhose <span class="operator">-d</span> dbname -o dbdirectory

<span class="comment">## 恢复数据</span>
mongorestore -h localhost <span class="operator">-d</span> test dbdirectory
</pre></td></tr></table></figure>

<h1 id="-">导入和导出</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>mongoexport <span class="attribute">-h</span> dbhost <span class="attribute">-d</span> dbname <span class="attribute">-c</span> collectioName <span class="attribute">-o</span> output

mongoimport <span class="attribute">-h</span> dbhost <span class="attribute">-d</span> dbname <span class="attribute">-c</span> collectioName output
</pre></td></tr></table></figure>

<h1 id="-">安全和认证</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="keyword">use</span> <span class="title">admin</span>;
<span class="comment">## 创建超级管理员</span>
db.addUser(<span class="string">"root"</span>, <span class="string">"root"</span>);

<span class="keyword">use</span> <span class="title">test</span>;
db.addUser(<span class="string">"zhangshan"</span>, <span class="string">"123"</span>);
<span class="comment">## 创建只读用户</span>
db.addUser(<span class="string">"lisi"</span>, <span class="string">"123"</span>, <span class="keyword">true</span>);

<span class="comment">## 运行服务, 并且开启安全检查</span>
mongod --dbpath --auth

<span class="comment">## 登陆, 验证用户</span>
db.auth(<span class="string">"zhangshan"</span>, <span class="string">"123"</span>);
</pre></td></tr></table></figure>

<h1 id="-">配置集群 副本集</h1>
<p>实时更新 复制 备份</p>
<h2 id="-">主从复制</h2>
<p>主从复制是MongoDB最常用的复制方式。这种方式非常灵活，可用于备份、故障恢复、读
扩展等。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="comment">##</span> <span class="comment">创建主节点</span>
<span class="comment">mongod</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">dbpath=/tmp/master</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">port</span> <span class="comment">10000</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">master</span>
<span class="comment">##</span> <span class="comment">创建从节点</span>
<span class="comment">mongod</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">dbpath=/tmp/slave</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">port</span> <span class="comment">10001</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">slave</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">source</span> <span class="comment">localhost:10000</span>
</pre></td></tr></table></figure>

<p>启动成功后就可以连接主节点进行操作了，而这些操作会同步到从节点.</p>
<h2 id="-">副本集</h2>
<p>主从集群和副本集最大的区别就是副本集没有固定的“主节点”； 
整个集群会选出一个“主节点”，当其挂掉后，又在剩下的从节点 
中选中其他节点为“主节点”，副本集总有一个活跃点(primary)
和一个或多个备份节点(secondary)。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="preprocessor">## 启动节点一, 默认为主节点</span>
<span class="title">mongod</span> <span class="comment">--dbpath E:\mogodb\dbs\node1 --logpath E:\mogodb\logs\node1\logs.txt --logappend</span>
<span class="comment">--port 10001 --replSet itcast/localhost:10002,localhost:10003 --master</span>

<span class="preprocessor">## 启动节点二</span>
<span class="title">mongod</span> <span class="comment">--dbpath E:\mogodb\dbs\node2 --logpath E:\mogodb\logs\node2\logs.txt --logappend</span>
<span class="comment">--port 10002 --replSet itcast/localhost:10001</span>

<span class="preprocessor">## 启动节点三</span>
<span class="title">mongod</span> <span class="comment">--dbpath E:\mogodb\dbs\node3 --logpath E:\mogodb\logs\node3\logs.txt --logappend</span>
<span class="comment">--port 10003 --replSet itcast/localhost:10001,localhost:10002</span>

<span class="preprocessor">## 连上 节点一</span>
<span class="title">mongo</span> localhost:<span class="number">10001</span>/admin

<span class="preprocessor">## 初始化副本集</span>
<span class="title">db</span>.runCommand({<span class="string">"replSetInitiate"</span>:{<span class="string">"_id"</span>:<span class="string">"itcast"</span>,<span class="string">"members"</span>:[
   {<span class="string">"_id"</span>:<span class="number">1</span>,<span class="string">"host"</span>:<span class="string">"localhost:10001"</span>,<span class="string">"priority"</span>:<span class="number">3</span>},
   {<span class="string">"_id"</span>:<span class="number">2</span>,<span class="string">"host"</span>:<span class="string">"localhost:10002"</span>,<span class="string">"priority"</span>:<span class="number">2</span>},
   {<span class="string">"_id"</span>:<span class="number">3</span>,<span class="string">"host"</span>:<span class="string">"localhost:10003"</span>,<span class="string">"priority"</span>:<span class="number">1</span>}]}});

<span class="preprocessor">## 查询是否主库</span>
<span class="title">db</span>.$cmd.findOne ( {ismaster: <span class="number">1</span> } );
</pre></td></tr></table></figure>

<h2 id="-">分片</h2>
<p>分片(sharding)是指将数据拆分，将其分散存在不同的机器上的过程。有时也用分区
(partitioning)来表示这个概念。将数据分散到不同的机器上，不需要功能强大的大型计算机
就可以储存更多的数据，处理更多的负载。 </p>
<p>分片之前要运行一个路由进程，该进程名为 mongos。这个路由器知道所有数据
的存放位置，所以应用可以连接它来正常发送请求。对应用来说，它仅知道连接了一个普通
的 mongod。路由器知道数据和片的对应关系，能够转发请求到正确的片上。如果请求有了
回应，路由器将其收集起来回送给应用。</p>
<p>config 指明数据存放规则</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="code"><pre><span class="preprocessor">## 启动 config 配置服务</span>
mongod --dbpath E:\mogodb\sharding\config_node --port <span class="number">2222</span>

<span class="preprocessor">## 启动分片服务, 连接config服务</span>
mongos --port <span class="number">3333</span> --configdb=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2222</span>

<span class="preprocessor">## 启动分片一 和 二</span>
mongod --dbpath E:\mogodb\sharding\mongod_node1 --port <span class="number">4444</span>
mongod --dbpath E:\mogodb\sharding\mongod_node2 --port <span class="number">5555</span>

<span class="preprocessor">## 连接分片服务器, 并添加分片一 和 分片二</span>
mongo localhost:<span class="number">3333</span>/admin
db.runCommand({<span class="string">"addshard"</span>:<span class="string">"localhost:4444"</span>,<span class="string">"allowLocal"</span>:<span class="literal">true</span>});
db.runCommand({<span class="string">"addshard"</span>:<span class="string">"localhost:5555"</span>,<span class="string">"allowLocal"</span>:<span class="literal">true</span>});

<span class="preprocessor">## 开启数据库 test 的分片服务</span>
db.runCommand({<span class="string">"enablesharding"</span>:<span class="string">"test"</span>});

<span class="preprocessor">## 指定分片的片键</span>
<span class="preprocessor">## 对test.person表进行分片, 根据 name 键, 进行分片</span>
db.runCommand({<span class="string">"shardcollection"</span>:<span class="string">"test.person"</span>,<span class="string">"key"</span>:{name:<span class="number">1</span>}});

<span class="preprocessor">## 查看分片情况</span>
db.printShardingStatus();
</pre></td></tr></table></figure>

<h1 id="java-mongodb">Java 操作 MongoDB</h1>
<p>导入 <code>mongo.jar</code></p>
<p>查找</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre>Mongo mongo = <span class="keyword">new</span> Mongo(<span class="string">"localost"</span>, <span class="number">27017</span>);
DB db = mongo.getDB(<span class="string">"test"</span>);

<span class="comment">// 获得集合</span>
DBCollection collection = db.getCollection(<span class="string">"customers"</span>);
<span class="comment">// 获得结果集</span>
DBCursor dbCursor = collection.find();
<span class="keyword">while</span>(dbCursor.hasNext()) {
  DBObject dbObject = dbCursor.next();
  <span class="built_in">Object</span> name = dbObject.<span class="keyword">get</span>(<span class="string">"name"</span>);
  <span class="built_in">Object</span> age = dbObject.<span class="keyword">get</span>(<span class="string">"age"</span>);
}
<span class="comment">// 关闭资源</span>
mongo.close();
</pre></td></tr></table></figure>

<p>增加</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>Mongo mongo = new Mongo(<span class="string">"localost"</span>, <span class="number">27017</span>)<span class="comment">;</span>
DB db = mongo<span class="preprocessor">.getDB</span>(<span class="string">"test"</span>)<span class="comment">;</span>

// 获得集合
DBCollection collection = db<span class="preprocessor">.getCollection</span>(<span class="string">"customers"</span>)<span class="comment">;</span>

DBObject db0 = new BasicDBObject()<span class="comment">;</span>
db0<span class="preprocessor">.put</span>(<span class="string">"name"</span>, <span class="string">"leo"</span>)<span class="comment">;</span>
db0<span class="preprocessor">.put</span>(<span class="string">"age"</span>, test)<span class="comment">;</span>
collection<span class="preprocessor">.insert</span>(db0)<span class="comment">;</span>

mongo<span class="preprocessor">.close</span>()<span class="comment">;</span>
</pre></td></tr></table></figure>

<p>更新</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre>Mongo mongo = <span class="built_in">new</span> Mongo(<span class="string">"localhost"</span>,<span class="number"> 5555</span>);

DB db = mongo.getDB(<span class="string">"test"</span>);

DBCollection personCollection = db.getCollection(<span class="string">"person"</span>);

DBObject o= <span class="built_in">new</span> BasicDBObject();
o.put(<span class="string">"name"</span>, <span class="string">"erdan"</span>);
o.put(<span class="string">"age"</span>,<span class="number"> 30</span>);

<span class="comment">//更改的时候 ,如果以”_id去更改”,那么同样的要以传递ObjectId,</span>
<span class="comment">// 不能直接将id值以字符串的形式传过去</span>
DBObject q = <span class="built_in">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="built_in">new</span> ObjectId(<span class="string">"525f495bf422c198b9a69bbc"</span>));

<span class="comment">// update方法重载了很多次,这里以这个为例.</span>
WriteResult result = personCollection.update(q , o);

mongo.<span class="built_in">close</span>();
</pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/传智播客/">传智播客</a><a href="/tags/NoSql/">NoSql</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://zhpooer.github.io/2014/08/09/传智播客day64-nosql/" data-title="传智播客day64-NoSql | Poe&#39;s World" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/08/09/play-for-scala-define-http-interface/" title="Play for Scala-Define Http interface">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Play for Scala-Define Http interface</span>
</a>
</div>


<div class="next">
<a href="/2014/08/08/play-for-scala-deconstructing-play/"  title="Play for Scala-Deconstructing Play">
 <strong>NEXT:</strong><br/> 
 <span>Play for Scala-Deconstructing Play
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nosql-"><span class="toc-number">1.</span> <span class="toc-text">NoSql 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mongodb-"><span class="toc-number">2.</span> <span class="toc-text">MongoDB 数据库</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">2.2.</span> <span class="toc-text">建表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">2.3.</span> <span class="toc-text">更新</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">3.</span> <span class="toc-text">索引</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">3.1.</span> <span class="toc-text">固定集合</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">4.</span> <span class="toc-text">数据库备份和恢复</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">5.</span> <span class="toc-text">导入和导出</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">6.</span> <span class="toc-text">安全和认证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">7.</span> <span class="toc-text">配置集群 副本集</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.1.</span> <span class="toc-text">主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.2.</span> <span class="toc-text">副本集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-"><span class="toc-number">7.3.</span> <span class="toc-text">分片</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#java-mongodb"><span class="toc-number">8.</span> <span class="toc-text">Java 操作 MongoDB</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/AJAX/" title="AJAX">AJAX<sup>1</sup></a></li>
		
			<li><a href="/tags/Akka/" title="Akka">Akka<sup>1</sup></a></li>
		
			<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
		
			<li><a href="/tags/DOM/" title="DOM">DOM<sup>2</sup></a></li>
		
			<li><a href="/tags/EL表达式/" title="EL表达式">EL表达式<sup>1</sup></a></li>
		
			<li><a href="/tags/HBase/" title="HBase">HBase<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>2</sup></a></li>
		
			<li><a href="/tags/HttpSession/" title="HttpSession">HttpSession<sup>1</sup></a></li>
		
			<li><a href="/tags/IO/" title="IO">IO<sup>1</sup></a></li>
		
			<li><a href="/tags/Illustrator/" title="Illustrator">Illustrator<sup>3</sup></a></li>
		
			<li><a href="/tags/JSP/" title="JSP">JSP<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaBean/" title="JavaBean">JavaBean<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>1</sup></a></li>
		
			<li><a href="/tags/Mybatis/" title="Mybatis">Mybatis<sup>1</sup></a></li>
		
			<li><a href="/tags/NoSql/" title="NoSql">NoSql<sup>1</sup></a></li>
		
			<li><a href="/tags/SASS/" title="SASS">SASS<sup>1</sup></a></li>
		
			<li><a href="/tags/SAX/" title="SAX">SAX<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletRequest/" title="ServletRequest">ServletRequest<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletResponse/" title="ServletResponse">ServletResponse<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://zhpooer.github.io" target="_blank" title="zhpooer">zhpooer</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"zhpoooer"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
