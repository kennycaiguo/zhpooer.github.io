
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Akka in Action-Testing Actors &amp; Fault tolerance | Poe&#39;s World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zhpooer">
    
    <meta name="description" content="difficult in testing Actors

Timing - Sending messages is asynchronous, so it is difficult to know when
to assert expected values in the unit test.
As">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="Poe&#39;s World" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Poe&#39;s World" title="Poe&#39;s World"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Poe&#39;s World">Poe&#39;s World</a></h1>
				<h2 class="blog-motto">竹杖芒鞋轻胜马，一蓑烟雨任平生</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/english-monthly">英语角</a></li>
					
						<li><a href="/about">关于</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:zhpooer.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/08/03/akka-in-action-testing-actors/" title="Akka in Action-Testing Actors &amp; Fault tolerance" itemprop="url">Akka in Action-Testing Actors &amp; Fault tolerance</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://zhpooer.github.io" title="zhpooer">zhpooer</a>
    </p>
  <p class="article-time">
    <time datetime="2014-08-03T07:20:54.000Z" itemprop="datePublished">8月 3 2014</time>
    更新日期:<time datetime="2014-08-04T01:57:46.000Z" itemprop="dateModified">8月 4 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#difficult-in-testing-actors"><span class="toc-number">1.</span> <span class="toc-text">difficult in testing Actors</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#akka-testkit"><span class="toc-number">2.</span> <span class="toc-text">akka-testkit</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#preparing-to-test"><span class="toc-number">3.</span> <span class="toc-text">Preparing to Test</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#one-way-messages"><span class="toc-number">4.</span> <span class="toc-text">One-way messages</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#silentactor-examples"><span class="toc-number">4.1.</span> <span class="toc-text">SilentActor Examples</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sendingactor-example"><span class="toc-number">4.2.</span> <span class="toc-text">SendingActor Example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sideeffectingactor-example"><span class="toc-number">4.3.</span> <span class="toc-text">SideEffectingActor Example</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#two-way-messages"><span class="toc-number">5.</span> <span class="toc-text">Two-way messages</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#what-is-fault-tolerance"><span class="toc-number">6.</span> <span class="toc-text">What is fault tolerance</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#plain-old-objects-and-exceptions"><span class="toc-number">6.1.</span> <span class="toc-text">Plain old objects and exceptions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#let-it-crash"><span class="toc-number">6.2.</span> <span class="toc-text">Let it crash</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#actor-life-cycle"><span class="toc-number">7.</span> <span class="toc-text">Actor life-cycle</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#start-event"><span class="toc-number">7.1.</span> <span class="toc-text">Start event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stop-event"><span class="toc-number">7.2.</span> <span class="toc-text">Stop event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#restart-event"><span class="toc-number">7.3.</span> <span class="toc-text">Restart event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#putting-the-life-cycle-pieces-together"><span class="toc-number">7.4.</span> <span class="toc-text">Putting the Life cycle Pieces Together</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#monitoring-the-lifecycle"><span class="toc-number">8.</span> <span class="toc-text">Monitoring the lifecycle</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#predefined-strategies"><span class="toc-number">8.1.</span> <span class="toc-text">Predefined strategies</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#custom-strategies"><span class="toc-number">8.2.</span> <span class="toc-text">Custom Strategies</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#futures"><span class="toc-number">9.</span> <span class="toc-text">Futures</span></a></li></ol>
		</div>
		
		<h1 id="difficult-in-testing-actors">difficult in testing Actors</h1>
<ul>
<li>Timing - Sending messages is asynchronous, so it is difficult to know when
to assert expected values in the unit test.</li>
<li>Asynchronicity - Actors are meant to be run in parallel on several threads.</li>
<li>Statelessness - An actor hides its internal state and does not allow access to
this state.</li>
<li>Collaboration/Integraton - If you want to do an integration test of a couple
of actors, you would need to eavesdrop in between the actors to assert that
the messages have the expected values.</li>
</ul>
<h1 id="akka-testkit">akka-testkit</h1>
<p>Akka provides the akka-testkit module.The testkit module makes a
couple of different types of tests possible:</p>
<ul>
<li>Single threaded unit testing </li>
<li>Multi-threaded unit testing,  The testkit module provides the TestKit
and TestProbe classes, which make it possible to receive replies from
actors, inspect messages and set timing bounds for particular messages to
arrive.</li>
<li>Multiple JVM testing, comes in handy when you want to test remote actor systems.</li>
</ul>
<p>The TestKit has the TestActorRef extending the LocalActorRef class
and sets the dispatcher to a CallingThreadDispatcher that is built for
testing only.</p>
<h1 id="preparing-to-test">Preparing to Test</h1>
<p>The TestKit exposes a system value, which can be accessed
in the test to create actors and everything else you would like to do with the system.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="keyword">import</span> org.scalatest.{ Suite, BeforeAndAfterAll }
<span class="keyword">import</span> akka.testkit.TestKit

<span class="comment">// Stop the system after all tests are done</span>
<span class="class"><span class="keyword">trait</span> <span class="title">StopSystemAfterAll</span> <span class="keyword">extends</span> <span class="title">BeforeAndAfterAll</span> {</span>
  <span class="keyword">this</span>: TestKit <span class="keyword">with</span> Suite =&gt;
  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="keyword">def</span> afterAll() {
    <span class="keyword">super</span>.afterAll()
    system.shutdown()
  }
}
</pre></td></tr></table></figure>

<h1 id="one-way-messages">One-way messages</h1>
<p>There are a three variations that we will look at:</p>
<ul>
<li>SilentActor - An actor&#39;s behavior is not directly observable from the
outside, it might be an intermediate step that the actor takes to create some
internal state.</li>
<li>SendingActor - An actor sends a message to another actor (or possibly
many actors) after it is done processing the received message.</li>
<li>SideEffectingActor - An actor receives a message and interacts with a
normal object in some kind of way.</li>
</ul>
<h2 id="silentactor-examples">SilentActor Examples</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="code"><pre><span class="class"><span class="keyword">object</span> <span class="title">SilentActorProtocol</span> {</span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">SilentMessage</span><span class="params">(data: String)</span></span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">GetState</span><span class="params">(receiver: ActorRef)</span></span>
}
<span class="class"><span class="keyword">class</span> <span class="title">SilentActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">import</span> SilentActorProtocol._
  <span class="keyword">var</span> internalState = Vector[String]()
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> SilentMessage(data) =&gt;
      internalState = internalState :+ data
    <span class="keyword">case</span> GetState(receiver) =&gt; receiver ! internalState
  }
  <span class="keyword">def</span> state = internalState
}

<span class="class"><span class="keyword">class</span> <span class="title">SilentActor01Test</span> <span class="keyword">extends</span> <span class="title">TestKit</span><span class="params">(ActorSystem(<span class="string">"testsystem"</span>)</span>)</span>
    <span class="keyword">with</span> WordSpec         <span class="comment">// WordSpec provides an easy to read DSL for testing in the BDD style</span>
    <span class="keyword">with</span> MustMatchers     <span class="comment">// MustMatchers provides easy to read assertions</span>
    <span class="keyword">with</span> StopSystemAfterAll {
  <span class="comment">// MustMatchers provides easy to read assertions</span>
  <span class="string">"A Silent Actor"</span> must {
    <span class="string">"change state when it receives a message, single threaded"</span> in {
      <span class="keyword">import</span> SilentActorProtocol._
      <span class="keyword">val</span> silentActor = TestActorRef[SilentActor]
      silentActor ! SilentMessage(<span class="string">"whisper"</span>)
      <span class="comment">// Get the underlying actor and assert the state</span>
      silentActor.underlyingActor.state must (contain(<span class="string">"whisper"</span>))
    }
    
    <span class="string">"change state when it receives a message, multi-threaded"</span> in {
      <span class="keyword">import</span> SilentActorProtocol._
      <span class="keyword">val</span> silentActor = system.actorOf(Props[SilentActor], <span class="string">"s3"</span>)
      silentActor ! SilentMessage(<span class="string">"whisper1"</span>)
      silentActor ! SilentMessage(<span class="string">"whisper2"</span>)
      silentActor ! GetState(testActor)
      <span class="comment">// Used to check what message(s) have been sent to the testActor</span>
      expectMsg(Vector(<span class="string">"whisper1"</span>, <span class="string">"whisper2"</span>))
      
      <span class="comment">//Write the test, first fail</span>
      fail(<span class="string">"not implemented yet"</span>)
    }
  }
}
</pre></td></tr></table></figure>

<h2 id="sendingactor-example">SendingActor Example</h2>
<p>Returning to our ticketing example from Chapter 1, we need to test the fact that
when we buy a Ticket to an Event , the count of available tickets is properly
decremented. </p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="string">"A Sending Actor"</span> must {
  <span class="string">"send a message to an actor when it has finished"</span> in {
    <span class="keyword">import</span> Kiosk01Protocol._
    <span class="keyword">val</span> props = Props(<span class="keyword">new</span> Kiosk01(testActor))
    <span class="keyword">val</span> sendingActor = system.actorOf(props, <span class="string">"kiosk1"</span>)
    <span class="keyword">val</span> tickets = Vector(Ticket(<span class="number">1</span>), Ticket(<span class="number">2</span>), Ticket(<span class="number">3</span>))
    <span class="keyword">val</span> game = Game(<span class="string">"Lakers vs Bulls"</span>, tickets)
    sendingActor ! game
    <span class="comment">// the testActor should receive one ticket less</span>
    <span class="comment">// expect Message Partial function</span>
    expectMsgPF() {
      <span class="keyword">case</span> Game(_, tickets) =&gt;
        tickets.size must be(game.tickets.size - <span class="number">1</span>)
    }
  }
}

<span class="class"><span class="keyword">object</span> <span class="title">Kiosk01Protocol</span> {</span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">Ticket</span><span class="params">(seat: Int)</span></span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">Game</span><span class="params">(name: String, tickets: Seq[Ticket])</span></span>
}

<span class="class"><span class="keyword">class</span> <span class="title">Kiosk01</span><span class="params">(nextKiosk: ActorRef)</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">import</span> Kiosk01Protocol._
  <span class="keyword">def</span> receive = {
  <span class="keyword">case</span> game @ Game(_, tickets) =&gt;
    nextKiosk ! game.copy(tickets = tickets.tail)
  }
}
</pre></td></tr></table></figure>

<p>Let&#39;s write a test for the FilteringActor. 
The FilteringActor that we are going to build should filter out
duplicate events.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="code"><pre><span class="string">"filter out particular messages"</span> in {
  <span class="keyword">import</span> FilteringActorProtocol._
  <span class="keyword">val</span> props = Props(<span class="keyword">new</span> FilteringActor(testActor, <span class="number">5</span>))
  <span class="keyword">val</span> filter = system.actorOf(props, <span class="string">"filter-1"</span>)
  
  filter ! Event(<span class="number">1</span>)
  filter ! Event(<span class="number">2</span>)
  filter ! Event(<span class="number">1</span>)
  filter ! Event(<span class="number">3</span>)
  filter ! Event(<span class="number">1</span>)
  filter ! Event(<span class="number">4</span>)
  filter ! Event(<span class="number">5</span>)
  filter ! Event(<span class="number">5</span>)
  <span class="comment">//  Event(6) does not match the pattern in the case statement</span>
  filter ! Event(<span class="number">6</span>)
  
  <span class="comment">// The receiveWhile method returns the collected items as they are returned in</span>
  <span class="comment">// the partial function as a list, which is not allowed to have any duplicates. </span>
  <span class="keyword">val</span> eventIds = receiveWhile() {
    <span class="keyword">case</span> Event(id) <span class="keyword">if</span> id &lt;= <span class="number">5</span> =&gt; id
  }
  
  eventIds must be(List(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))
  <span class="comment">// Assert that the duplicates are not in the result</span>
  expectMsg(Event(<span class="number">6</span>))
}



<span class="class"><span class="keyword">object</span> <span class="title">FilteringActorProtocol</span> {</span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">Event</span><span class="params">(id: Long)</span></span>
}

<span class="comment">// The oldest message that was received is discarded when a max</span>
<span class="comment">// bufferSize is reached to prevent the lastMessages list from growing too</span>
<span class="comment">// large and possibly causing us to run out of space.</span>

<span class="class"><span class="keyword">class</span> <span class="title">FilteringActor</span><span class="params">(nextActor: ActorRef,
      bufferSize: Int)</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
    <span class="keyword">import</span> FilteringActorProtocol._
    <span class="keyword">var</span> lastMessages = Vector[Event]()
    <span class="keyword">def</span> receive = {
      <span class="keyword">case</span> msg: Event =&gt;
        <span class="keyword">if</span> (!lastMessages.contains(msg)) {
          lastMessages = lastMessages :+ msg
          nextActor ! msg
          <span class="keyword">if</span> (lastMessages.size &gt; bufferSize) {
            <span class="comment">// discard the oldest</span>
            lastMessages = lastMessages.tail
          }
        }
    }
}

<span class="string">"filter out particular messages using expectNoMsg"</span> in {
  <span class="keyword">import</span> FilteringActorProtocol._
  <span class="keyword">val</span> props = Props(<span class="keyword">new</span> FilteringActor(testActor, <span class="number">5</span>))
  <span class="keyword">val</span> filter = system.actorOf(props, <span class="string">"filter-2"</span>)
  filter ! Event(<span class="number">1</span>)
  filter ! Event(<span class="number">2</span>)
  expectMsg(Event(<span class="number">1</span>))
  expectMsg(Event(<span class="number">2</span>))
  filter ! Event(<span class="number">1</span>)
  expectNoMsg
  filter ! Event(<span class="number">3</span>)
  expectMsg(Event(<span class="number">3</span>))
  filter ! Event(<span class="number">1</span>)
  expectNoMsg
  filter ! Event(<span class="number">4</span>)
  filter ! Event(<span class="number">5</span>)
  filter ! Event(<span class="number">5</span>)
  expectMsg(Event(<span class="number">4</span>))
  expectMsg(Event(<span class="number">5</span>))
  expectNoMsg()
}
</pre></td></tr></table></figure>

<p>The TestProbe class is very much like the TestKit, only you
can use this class without having to extend from it.
Simply create a TestProbe with <code>TestProbe()</code> and start using it.</p>
<h2 id="sideeffectingactor-example">SideEffectingActor Example</h2>
<p>It does just one thing: its Greeter receives
a message and outputs it to the console.</p>
<p>The SideEffectingActor allows us to test scenarios such as these:
where the effect of the action is not directly accessible.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="keyword">import</span> Greeter01Test._
<span class="comment">// Create a system with a configuration that attaches a test event listener</span>
<span class="class"><span class="keyword">class</span> <span class="title">Greeter01Test</span> <span class="keyword">extends</span> <span class="title">TestKit</span><span class="params">(testSystem)</span></span>
    <span class="keyword">with</span> WordSpec
    <span class="keyword">with</span> MustMatchers
    <span class="keyword">with</span> StopSystemAfterAll {
  <span class="string">"The Greeter"</span> must {
    <span class="string">"say Hello World! when a Greeting("</span>World<span class="string">") is sent to it"</span> in {
      <span class="keyword">val</span> dispatcherId = CallingThreadDispatcher.Id
      <span class="comment">// Single threaded environment</span>
      <span class="keyword">val</span> props = Props[Greeter].withDispatcher(dispatcherId)
      <span class="keyword">val</span> greeter = system.actorOf(props)
      <span class="comment">// Intercept the log messages that were logged</span>
      EventFilter.info(message = <span class="string">"Hello World!"</span>, occurrences = <span class="number">1</span>).intercept {
        <span class="comment">// The filter is applied when the intercept code block is executed,</span>
        <span class="comment">// which is when we send the message.</span>
        greeter ! Greeting(<span class="string">"World"</span>)
      }
    }
  }
}

<span class="class"><span class="keyword">object</span> <span class="title">Greeter01Test</span> {</span>
  <span class="keyword">val</span> testSystem = {
    <span class="comment">// parse a configuration file from a String, in this case we only override the event handlers list.</span>
    <span class="keyword">val</span> config = ConfigFactory.parseString(<span class="string">"""akka.event-handlers = ["akka.testkit.TestEventListener"]"""</span>)
    ActorSystem(<span class="string">"testsystem"</span>, config)
  }
}

<span class="comment">// 注册一个监听器</span>
<span class="class"><span class="keyword">class</span> <span class="title">Greeter02</span><span class="params">(listener: Option[ActorRef] = None)</span></span>
    <span class="keyword">extends</span> Actor <span class="keyword">with</span> ActorLogging {
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> Greeting(who) =&gt;
      <span class="keyword">val</span> message = <span class="string">"Hello "</span> + who + <span class="string">"!"</span>
      log.info(message)
      listener.foreach(_ ! message)
  }
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">Greeter02Test</span> <span class="keyword">extends</span> <span class="title">TestKit</span><span class="params">(ActorSystem(<span class="string">"testsystem"</span>)</span>)</span>
    <span class="keyword">with</span> WordSpec
    <span class="keyword">with</span> MustMatchers
    <span class="keyword">with</span> StopSystemAfterAll {
    
  <span class="string">"The Greeter"</span> must {
    <span class="string">"say Hello World! when a Greeting("</span>World<span class="string">") is sent to it"</span> in {
      <span class="keyword">val</span> props = Props(<span class="keyword">new</span> Greeter02(Some(testActor)))
      <span class="keyword">val</span> greeter = system.actorOf(props, <span class="string">"greeter02-1"</span>)
      greeter ! Greeting(<span class="string">"World"</span>)
      expectMsg(<span class="string">"Hello World!"</span>)
    }
  <span class="string">"say something else and see what happens"</span> in {
      <span class="keyword">val</span> props = Props(<span class="keyword">new</span> Greeter02(Some(testActor)))
      <span class="keyword">val</span> greeter = system.actorOf(props, <span class="string">"greeter02-2"</span>)
      <span class="comment">// 获取没有处理的 信息</span>
      system.eventStream.subscribe(testActor, classOf[UnhandledMessage])
      greeter ! <span class="string">"World"</span>
      expectMsg(UnhandledMessage(<span class="string">"World"</span>, system.deadLetters, greeter))
    }
  }
}
</pre></td></tr></table></figure>

<h1 id="two-way-messages">Two-way messages</h1>
<p>Two-way messages are quite easy to test in a black box fashion, a request
should result in a response, which you can simply assert. In the following test we
will test an EchoActor , an actor that echoes any request back in a response.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="string">"Reply with the same message it receives without ask"</span> in {
  val <span class="keyword">echo</span> = system.actorOf(Props[EchoActor], <span class="string">"echo2"</span>)
  <span class="comment">// Call tell with the testActor as the sender</span>
  <span class="keyword">echo</span>.tell(<span class="string">"some message"</span>, testActor)
  expectMsg(<span class="string">"some message"</span>)
}

<span class="class"><span class="keyword">class</span> <span class="title">EchoActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  def receive = {
    <span class="keyword">case</span> msg =&gt;
      sender ! msg
  }
}
</pre></td></tr></table></figure>

<h1 id="what-is-fault-tolerance">What is fault tolerance</h1>
<p>A fault should be contained to a part of the system and not escalate to a total
crash.</p>
<p>Isolating a faulty component means that some structure needs to exist to
isolate it from; the system will need a defined structure in which active parts
can be isolated.</p>
<p>A backup component should be able to take over when a component fails.</p>
<p>If a faulty component can be isolated we can also replace it in the structure.
The other parts of the system should be able to communicate with the
replaced component just as they did before with the failed component.</p>
<p>If a component gets into an incorrect state, we need to have the ability to get
it back to a defined initial state. </p>
<p>A faulty component needs to be isolated and if it cannot recover it should be
terminated and removed from the system or re-initialized with a correct
starting state.</p>
<p>When a component fails we would like all calls to the component to be
suspended until the component is fixed or replaced so that when it is, the new
component can continue the work without dropping a beat.</p>
<p>It would be great if the fault recovery code could be separated from the
normal processing code. </p>
<h2 id="plain-old-objects-and-exceptions">Plain old objects and exceptions</h2>
<ul>
<li>Recreating objects and their dependencies and replacing these in the application structure
is not available as a first-class feature.</li>
<li>Objects communicate with each other directly so it is hard to isolate them.</li>
<li>The fault recovery code and the functional code are tangled up with each other.</li>
</ul>
<h2 id="let-it-crash">Let it crash</h2>
<p>Instead of using one flow to handle both normal code and recovery code Akka
provides two separate flows; one for normal logic and one for fault recovery logic.</p>
<p>The normal flow consists of actors that handle normal messages, the recovery flow
consists of actors that monitor the actors in the normal flow. Actors that monitor
other actors are called supervisors.</p>
<p>The actor code only contains normal processing logic and no error handling or fault
recovery logic, so its effectively not part of the recovery process, which keeps
things much clearer. The mailbox for a crashed actor is suspended until the
supervisor in the recovery flow has decided what to do with the exception.</p>
<p>Akka has chosen to enforce parental
supervision , meaning that any actor that creates actors automatically becomes the
supervisor of those actors.</p>
<p>The supervisor has 4 options when deciding what to do with the actor:</p>
<ul>
<li>Restart; the actor must be recreated from its Props. after it is restarted (or rebooted if you
will) the actor will continue to process messages. Since the rest of the application uses an
ActorRef to communicate with the actor the new actor instance will automatically get the
next messages.</li>
<li>Resume; the same actor instance should continue to process messages, the crash is
ignored.</li>
<li>Stop; the actor must be terminated. It will no longer take part in processing messages.</li>
<li>Escalate; the supervisor does not know what to do with it and escalates the problem to its
parent, which is also a supervisor.
<img src="/img/akka_recover.png" alt="Normal and recovery flow in the logs processing application"></li>
</ul>
<p>Akka chooses not to provide the failing message to the mailbox again after
a restart, but there is a way to do this yourself if you are absolutely sure that the
message did not cause the error, which we will discuss later.</p>
<h1 id="actor-life-cycle">Actor life-cycle</h1>
<p>During the life cycle of an actor there are three types of events:</p>
<ol>
<li>The actor is created and started, for simplicity we
will refer to this as the Start event.</li>
<li>The actor is restarted on the Restart event.</li>
<li>The actor is stopped by the Stop event.</li>
</ol>
<h2 id="start-event">Start event</h2>
<p>An actor is created and automatically started with the actorOf method. Top level
actors are created with the actorOf method on the ActorSystem . A parent actor
creates a child actor using the actorOf on its ActorContext .</p>
<p>The preStart hook is called just before the actor is started. To use this trigger we
have to override the preStart method.</p>
<h2 id="stop-event">Stop event</h2>
<p>An actor can be stopped using the stop method on the
ActorSystem and ActorContext objects, or by sending a PoisonPill
message to an actor.</p>
<p>The postStop hook is called just before the actor is terminated.</p>
<p>A stopped actor is disconnected from its ActorRef. After the actor is
stopped, the ActorRef is redirected to the deadLetters ActorRef of the actor
system, which is a special ActorRef that receives all messages that are sent to dead
actors.</p>
<h2 id="restart-event">Restart event</h2>
<p>When a restart occurs the preRestart method of the crashed actor instance
is called.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="keyword">override</span> <span class="keyword">def</span> preRestart(reason: Throwable, message: Option[Any]) {
  println(<span class="string">"preRestart"</span>)
  <span class="keyword">super</span>.preRestart(reason, message)
}
</pre></td></tr></table></figure>

<p>The default implementation of the
preRestart method stops all the child actors of the actor and then calls the
postStop hook. If you forget to call super.preRestart this default
behavior will not occur.</p>
<p>Remember that actors are (re)created from a Props
object. The Props object eventually calls the constructor of the actor.</p>
<p>A stopped actor is disconnected from its
ActorRef and redirected to the deadLetters ActorRef as described by the stop
event.</p>
<p>The preRestart method takes two arguments: the reason for the restart and
optionally the message that was being processed when the actor crashed. </p>
<p>The super.postRestart can be omitted if you are certain that you
don&#39;t want the preStart to be called when restarting, in most cases though this
is not going to be the case.</p>
<h2 id="putting-the-life-cycle-pieces-together">Putting the Life cycle Pieces Together</h2>
<p><img src="/img/akka_lifecycle.png" alt="akka_lifecycle"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">LifeCycleHooks</span> <span class="keyword">extends</span> <span class="title">Actor</span> <span class="keyword">with</span> <span class="title">ActorLogging</span>{</span>
  System.out.println(<span class="string">"Constructor"</span>)
  <span class="keyword">override</span> <span class="keyword">def</span> preStart() {println(<span class="string">"preStart"</span>)}
  <span class="keyword">override</span> <span class="keyword">def</span> postStop() {println(<span class="string">"postStop"</span>)}
  <span class="keyword">override</span> <span class="keyword">def</span> preRestart(reason: Throwable, message: Option[Any]) {
    println(<span class="string">"preRestart"</span>)
    <span class="keyword">super</span>.preRestart (reason, message)
  }
  <span class="keyword">override</span> <span class="keyword">def</span> postRestart(reason: Throwable) {
    println(<span class="string">"postRestart"</span>)
    <span class="keyword">super</span>.postRestart(reason)
  }
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> <span class="string">"restart"</span> =&gt; <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"force restart"</span>)
    <span class="keyword">case</span> msg: AnyRef =&gt; println(<span class="string">"Receive"</span>)
  }
}
</pre></td></tr></table></figure>

<h1 id="monitoring-the-lifecycle">Monitoring the lifecycle</h1>
<p>The supervision hierarchy is fixed for the lifetime of a child. Once the child is
created by the parent it will fall under the supervision of that parent as long as it
lives, there is no such thing as adoption in Akka.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="class"><span class="keyword">object</span> <span class="title">LogProcessingApp</span> <span class="keyword">extends</span> <span class="title">App</span> {</span>
  <span class="keyword">val</span> sources = Vector(<span class="string">"file:///source1/"</span>, <span class="string">"file:///source2/"</span>)
  <span class="keyword">val</span> system = ActorSystem(<span class="string">"logprocessing"</span>)
  <span class="comment">// create the props and dependencies</span>
  <span class="keyword">val</span> con = <span class="keyword">new</span> DbCon(<span class="string">"http://mydatabase"</span>)
  <span class="keyword">val</span> writerProps = Props(<span class="keyword">new</span> DbWriter(con))
  <span class="keyword">val</span> dbSuperProps = Props(<span class="keyword">new</span> DbSupervisor(writerProps))
  <span class="keyword">val</span> logProcSuperProps = Props(<span class="keyword">new</span> LogProcSupervisor(dbSuperProps))
  <span class="keyword">val</span> topLevelProps = Props(<span class="keyword">new</span> FileWatchingSupervisor(
    sources,logProcSuperProps))
  system.actorOf(topLevelProps)
}
</pre></td></tr></table></figure>

<p>Props objects are passed as recipes to the actors so that
they can create their children without knowing the details of
the dependencies of the child actors.</p>
<h2 id="predefined-strategies">Predefined strategies</h2>
<p> There are two predefined strategies available in the
SupervisorStrategy object; the defaultStrategy and the
stoppingStrategy .</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="keyword">final</span> val defaultStrategy: SupervisorStrategy = {
  def defaultDecider: Decider = { <span class="comment">//</span>
    <span class="keyword">case</span> _: ActorInitializationException =&gt; Stop <span class="comment">//</span>
    <span class="keyword">case</span> _: ActorKilledException =&gt; Stop
    <span class="keyword">case</span> _: <span class="keyword">Exception</span> =&gt; Restart
  }
  OneForOneStrategy()(defaultDecider) <span class="comment">//</span>
}
</pre></td></tr></table></figure>

<p>In some cases you might want to only stop the child actor that failed.
In other cases you might want to stop all child actors if one of them fails, maybe because they all
depend on a particular resource.</p>
<p> The OneForOneStrategy determines that child actors will not share the
same fate, only the crashed child will be decided upon by the Decider. The other
option is to use an AllForOneStrategy which uses the same decision for all
child actors even if only one crashed.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre>final val stoppingStrategy: SupervisorStrategy = {
  <span class="function"><span class="keyword">def</span> <span class="title">stoppingDecider</span>:</span> Decider = {
    case _: Exception =&gt; Stop //
  }
  OneForOneStrategy()(stoppingDecider)
}
</pre></td></tr></table></figure>

<h2 id="custom-strategies">Custom Strategies</h2>
<p>First we&#39;ll look at the exceptions that can occur in the log processing
application.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre></td><td class="code"><pre>@<span class="type">SerialVersionUID</span>(<span class="number">1</span>L)
// <span class="type">An</span> unrecoverable <span class="type">Error</span> that occurs when the disk for the source has crashed
<span class="class"><span class="keyword">class</span> <span class="type">DiskError</span><span class="container">(<span class="title">msg</span>: <span class="type">String</span>)</span> extends <span class="type">Error</span><span class="container">(<span class="title">msg</span>)</span> with <span class="type">Serializable</span>

@<span class="type">SerialVersionUID</span><span class="container">(1L)</span>
// <span class="type">An</span> <span class="type">Exception</span> that occurs when the log file is corrupt and cannot be processed.
<span class="keyword">class</span> <span class="type">CorruptedFileException</span><span class="container">(<span class="title">msg</span>: <span class="type">String</span>, <span class="title">val</span> <span class="title">file</span>: <span class="type">File</span>)</span>
  extends <span class="type">Exception</span><span class="container">(<span class="title">msg</span>)</span> with <span class="type">Serializable</span>
  
@<span class="type">SerialVersionUID</span><span class="container">(1L)</span>
// <span class="type">An</span> <span class="type">Exception</span> that occurs when the database connection is broken.
<span class="keyword">class</span> <span class="type">DbBrokenConnectionException</span><span class="container">(<span class="title">msg</span>: <span class="type">Striing</span>)</span>
  extends <span class="type">Exception</span><span class="container">(<span class="title">msg</span>)</span> with <span class="type">Serializable</span>


object <span class="type">LogProcessingProtocol</span> {
  // represents a new log file
  case <span class="keyword">class</span> <span class="type">LogFile</span><span class="container">(<span class="title">file</span>: <span class="type">File</span>)</span>
  // <span class="type">A</span> line in the log file parsed by the <span class="type">LogProcessor</span> <span class="type">Actor</span>
  case <span class="keyword">class</span> <span class="type">Line</span><span class="container">(<span class="title">time</span>: <span class="type">Long</span>, <span class="title">message</span>: <span class="type">String</span>, <span class="title">messageType</span>: <span class="type">String</span>)</span>
}

<span class="keyword">class</span> <span class="type">DbWriter</span><span class="container">(<span class="title">connection</span>: <span class="type">DbCon</span>)</span> extends <span class="type">Actor</span> {
  import <span class="type">LogProcessingProtocol</span>._
  def receive = {
    case <span class="type">Line</span><span class="container">(<span class="title">time</span>, <span class="title">message</span>, <span class="title">messageType</span>)</span> =&gt;
      connection.write<span class="container">(<span class="type">Map</span>('<span class="title">time</span> -&gt; <span class="title">time</span>,
        '<span class="title">message</span> -&gt; <span class="title">message</span>,
        '<span class="title">messageType</span> -&gt; <span class="title">messageType</span>)</span>)
  }
}

/// <span class="type">Send</span> the parsed lines to the dbSupervisor which in turn will forward the message
// to the dbWriter.
<span class="keyword">class</span> <span class="type">DbSupervisor</span><span class="container">(<span class="title">writerProps</span>: <span class="type">Props</span>)</span> extends <span class="type">Actor</span> {
  override def supervisorStrategy = <span class="type">OneForOneStrategy</span><span class="container">()</span> {
    case _: <span class="type">DbBrokenConnectionException</span> =&gt; <span class="type">Restart</span>
  }
  val writer = context.actorOf<span class="container">(<span class="title">writerProps</span>)</span>
  def receive = {
    case m =&gt; writer forward <span class="container">(<span class="title">m</span>)</span>
  }
}

<span class="keyword">class</span> <span class="type">LogProcessor</span><span class="container">(<span class="title">dbSupervisor</span>: <span class="type">ActorRef</span>)</span> extends <span class="type">Actor</span> with <span class="type">LogParsing</span> {
  import <span class="type">LogProcessingProtocol</span>._
  def receive = {
    case <span class="type">LogFile</span><span class="container">(<span class="title">file</span>)</span> =&gt;
      val lines = parse<span class="container">(<span class="title">file</span>)</span>
      lines.foreach<span class="container">(<span class="title">dbSupervisor</span> ! <span class="title">_</span>)</span>
  }
}


<span class="keyword">class</span> <span class="type">LogProcSupervisor</span><span class="container">(<span class="title">dbSupervisorProps</span>: <span class="type">Props</span>)</span>
    extends <span class="type">Actor</span> {
  override def supervisorStrategy = <span class="type">OneForOneStrategy</span><span class="container">()</span> {
    case _: <span class="type">CorruptedFileException</span> =&gt; <span class="type">Resume</span>
  }
  val dbSupervisor = context.actorOf<span class="container">(<span class="title">dbSupervisorProps</span>)</span>
  val logProcProps = <span class="type">Props</span><span class="container">(<span class="title">new</span> <span class="type">LogProcessor(dbSupervisor)</span>)</span>
  val logProcessor = context.actorOf<span class="container">(<span class="title">logProcProps</span>)</span>
  def receive = {
    case m =&gt; logProcessor forward <span class="container">(<span class="title">m</span>)</span>
  }
}

<span class="keyword">class</span> <span class="type">FileWatcher</span><span class="container">(<span class="title">sourceUri</span>: <span class="type">String</span>, <span class="title">logProcSupervisor</span>: <span class="type">ActorRef</span>)</span>
    extends <span class="type">Actor</span> with <span class="type">FileWatchingAbilities</span> {
  // <span class="type">Registers</span> on a source uri in the file watching <span class="type">API</span>.
  register<span class="container">(<span class="title">sourceUri</span>)</span>
  import <span class="type">FileWatcherProtocol</span>._
  import <span class="type">LogProcessingProtocol</span>._
  def receive = {
    case <span class="type">NewFile</span><span class="container">(<span class="title">file</span>, <span class="title">_</span>)</span> =&gt;
      logProcSupervisor ! <span class="type">LogFile</span><span class="container">(<span class="title">file</span>)</span>
    case <span class="type">SourceAbandoned</span><span class="container">(<span class="title">uri</span>)</span> if uri == sourceUri =&gt;
      self ! <span class="type">PoisonPill</span>
  }
}

<span class="keyword">class</span> <span class="type">FileWatchingSupervisor</span><span class="container">(<span class="title">sources</span>: <span class="type">Vector</span>[<span class="type">String</span>], <span class="title">logProcSuperProps</span>: <span class="type">Props</span>)</span>
    extends <span class="type">Actor</span> {
  var fileWatchers: <span class="type">Vector</span>[<span class="type">ActorRef</span>] = sources.map { source =&gt;
    val logProcSupervisor = context.actorOf<span class="container">(<span class="title">logProcSuperProps</span>)</span>
    //  <span class="type">Watch</span> the file watchers for termination.
    val fileWatcher = context.actorOf<span class="container">(<span class="type">Props</span>(
          <span class="title">new</span> <span class="type">FileWatcher</span>(<span class="title">source</span>, <span class="title">logProcSupervisor</span>)</span>))
    context.watch<span class="container">(<span class="title">fileWatcher</span>)</span>
    fileWatcher
  }
  override def supervisorStrategy = <span class="type">AllForOneStrategy</span><span class="container">()</span> {
    case _: <span class="type">DiskError</span> =&gt; <span class="type">Stop</span>
  }
  def receive = {
    case <span class="type">Terminated</span><span class="container">(<span class="title">fileWatcher</span>)</span> =&gt;
      fileWatchers = fileWatchers.filterNot<span class="container">(<span class="title">w</span> =&gt; <span class="title">w</span> == <span class="title">fileWatcher</span>)</span>
      if <span class="container">(<span class="title">fileWatchers</span>.<span class="title">isEmpty</span>)</span> self ! <span class="type">PoisonPill</span>
  }
}


<span class="keyword">class</span> <span class="type">DbImpatientSupervisor</span><span class="container">(<span class="title">writerProps</span>: <span class="type">Props</span>)</span> extends <span class="type">Actor</span> {
  // <span class="type">Escalate</span> the issue if the problem has not been resolved within 60 seconds or it has
  // failed to be solved within 5 restarts.
  override def supervisorStrategy = <span class="type">OneForOneStrategy</span><span class="container">(
      <span class="title">maxNrOfRetries</span> = 5,
      <span class="title">withinTimeRange</span> = 60 <span class="title">seconds</span>)</span> {
    case _: <span class="type">DbBrokenConnectionException</span> =&gt; <span class="type">Restart</span>
  }
  val writer = context.actorOf<span class="container">(<span class="title">writerProps</span>)</span>
  
  def receive = {
    case m =&gt; writer forward <span class="container">(<span class="title">m</span>)</span>
  }
}</span>
</pre></td></tr></table></figure>

<h1 id="futures">Futures</h1>
<p>TODO</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/scala/">scala</a><a href="/tags/akka/">akka</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://zhpooer.github.io/2014/08/03/akka-in-action-testing-actors/" data-title="Akka in Action-Testing Actors &amp; Fault tolerance | Poe&#39;s World" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/08/04/akka-in-action-distribute-akka-app/" title="Akka in Action-Distribute Akka App">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Akka in Action-Distribute Akka App</span>
</a>
</div>


<div class="next">
<a href="/2014/08/03/akka-in-action-introducing/"  title="Akka in Action-Introduce">
 <strong>NEXT:</strong><br/> 
 <span>Akka in Action-Introduce
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#difficult-in-testing-actors"><span class="toc-number">1.</span> <span class="toc-text">difficult in testing Actors</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#akka-testkit"><span class="toc-number">2.</span> <span class="toc-text">akka-testkit</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#preparing-to-test"><span class="toc-number">3.</span> <span class="toc-text">Preparing to Test</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#one-way-messages"><span class="toc-number">4.</span> <span class="toc-text">One-way messages</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#silentactor-examples"><span class="toc-number">4.1.</span> <span class="toc-text">SilentActor Examples</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sendingactor-example"><span class="toc-number">4.2.</span> <span class="toc-text">SendingActor Example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sideeffectingactor-example"><span class="toc-number">4.3.</span> <span class="toc-text">SideEffectingActor Example</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#two-way-messages"><span class="toc-number">5.</span> <span class="toc-text">Two-way messages</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#what-is-fault-tolerance"><span class="toc-number">6.</span> <span class="toc-text">What is fault tolerance</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#plain-old-objects-and-exceptions"><span class="toc-number">6.1.</span> <span class="toc-text">Plain old objects and exceptions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#let-it-crash"><span class="toc-number">6.2.</span> <span class="toc-text">Let it crash</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#actor-life-cycle"><span class="toc-number">7.</span> <span class="toc-text">Actor life-cycle</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#start-event"><span class="toc-number">7.1.</span> <span class="toc-text">Start event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stop-event"><span class="toc-number">7.2.</span> <span class="toc-text">Stop event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#restart-event"><span class="toc-number">7.3.</span> <span class="toc-text">Restart event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#putting-the-life-cycle-pieces-together"><span class="toc-number">7.4.</span> <span class="toc-text">Putting the Life cycle Pieces Together</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#monitoring-the-lifecycle"><span class="toc-number">8.</span> <span class="toc-text">Monitoring the lifecycle</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#predefined-strategies"><span class="toc-number">8.1.</span> <span class="toc-text">Predefined strategies</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#custom-strategies"><span class="toc-number">8.2.</span> <span class="toc-text">Custom Strategies</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#futures"><span class="toc-number">9.</span> <span class="toc-text">Futures</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/AJAX/" title="AJAX">AJAX<sup>1</sup></a></li>
		
			<li><a href="/tags/Akka/" title="Akka">Akka<sup>1</sup></a></li>
		
			<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
		
			<li><a href="/tags/DOM/" title="DOM">DOM<sup>2</sup></a></li>
		
			<li><a href="/tags/EL表达式/" title="EL表达式">EL表达式<sup>1</sup></a></li>
		
			<li><a href="/tags/HBase/" title="HBase">HBase<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>2</sup></a></li>
		
			<li><a href="/tags/HttpSession/" title="HttpSession">HttpSession<sup>1</sup></a></li>
		
			<li><a href="/tags/IO/" title="IO">IO<sup>1</sup></a></li>
		
			<li><a href="/tags/Illustrator/" title="Illustrator">Illustrator<sup>3</sup></a></li>
		
			<li><a href="/tags/JSP/" title="JSP">JSP<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaBean/" title="JavaBean">JavaBean<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>1</sup></a></li>
		
			<li><a href="/tags/Mybatis/" title="Mybatis">Mybatis<sup>1</sup></a></li>
		
			<li><a href="/tags/NoSql/" title="NoSql">NoSql<sup>1</sup></a></li>
		
			<li><a href="/tags/SASS/" title="SASS">SASS<sup>1</sup></a></li>
		
			<li><a href="/tags/SAX/" title="SAX">SAX<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletRequest/" title="ServletRequest">ServletRequest<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletResponse/" title="ServletResponse">ServletResponse<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://zhpooer.github.io" target="_blank" title="zhpooer">zhpooer</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"zhpoooer"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
