
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Akka in Action-System Structure &amp; Routing Messages | Poe&#39;s World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zhpooer">
    
    <meta name="description" content="One of the immediate implications of Actor based programming is how do we
model code that requires collaborators to work together if each unit of work">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="Poe&#39;s World" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Poe&#39;s World" title="Poe&#39;s World"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Poe&#39;s World">Poe&#39;s World</a></h1>
				<h2 class="blog-motto">竹杖芒鞋轻胜马，一蓑烟雨任平生</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/english-monthly">英语角</a></li>
					
						<li><a href="/about">关于</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:zhpooer.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/08/04/akka-in-action-system-structure/" title="Akka in Action-System Structure &amp; Routing Messages" itemprop="url">Akka in Action-System Structure &amp; Routing Messages</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://zhpooer.github.io" title="zhpooer">zhpooer</a>
    </p>
  <p class="article-time">
    <time datetime="2014-08-04T10:47:29.000Z" itemprop="datePublished">8月 4 2014</time>
    更新日期:<time datetime="2014-08-05T03:10:01.000Z" itemprop="dateModified">8月 5 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#pipes-and-filters"><span class="toc-number">1.</span> <span class="toc-text">Pipes and Filters</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#scatter-gather-pattern"><span class="toc-number">2.</span> <span class="toc-text">Scatter-Gather Pattern</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#competing-tasks"><span class="toc-number">2.1.</span> <span class="toc-text">Competing Tasks</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#routing-messages"><span class="toc-number">3.</span> <span class="toc-text">Routing Messages</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#roundrobinrouter"><span class="toc-number">3.1.</span> <span class="toc-text">RoundRobinRouter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smallestmailboxrouter"><span class="toc-number">3.2.</span> <span class="toc-text">SmallestMailboxRouter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configuring-a-router"><span class="toc-number">3.3.</span> <span class="toc-text">Configuring a Router</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#routers-and-children"><span class="toc-number">3.4.</span> <span class="toc-text">Routers and Children</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#letting-the-router-create-the-routees"><span class="toc-number">3.5.</span> <span class="toc-text">Letting the Router Create the Routees</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#passing-the-router-pre-created-actors"><span class="toc-number">3.6.</span> <span class="toc-text">Passing the Router Pre-Created Actors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-router-and-its-children-s-life-cycles"><span class="toc-number">3.7.</span> <span class="toc-text">The Router and Its Children’s Life Cycles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#routers-on-a-plane"><span class="toc-number">3.8.</span> <span class="toc-text">Routers on a Plane</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#the-passenger-router"><span class="toc-number">3.8.1.</span> <span class="toc-text">The Passenger Router</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#using-the-passenger-router"><span class="toc-number">3.8.2.</span> <span class="toc-text">Using the Passenger Router</span></a></li></ol>
		</div>
		
		<p>One of the immediate implications of Actor based programming is how do we
model code that requires collaborators to work together if each unit of work is done
in parallel?</p>
<p>Akka allows us to use these design approaches while still making use of its
inherent concurrency.</p>
<ul>
<li>integration tools and platforms</li>
<li>messaging systems</li>
<li>WSO2, and SOA and Web-service based solutions</li>
</ul>
<h1 id="pipes-and-filters">Pipes and Filters</h1>
<p>The concept of piping refers to the ability for one process or thread to pump its
results to another processor for additional processing.</p>
<p>In many systems a single event will trigger a sequence of tasks.</p>
<p>It receives the photo and before the event is sent to central
processing, a number of checks are done. When no license plate is found in the
photo, the system is unable to process the message any further and therefore, it will
be discarded.  In this example we also discard the message when the speed is below
the maximum speed. Which means that only messages that contain the license
plate of a speeding vehicle end up getting to the central processor.</p>
<p>Each Filter consists of three parts, the inbound pipe where the message is
received, the processor of the message, and finally the outbound pipe where the
result of the processing is published.</p>
<p>An important restriction is that each filter must accept and
send the same messages, because the outbound pipe of a filter can be the inbound
pipe of any other filter in the pattern. </p>
<p>A Pipe with Two Filters Example</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">Photo</span><span class="params">(license: String, speed: Int)</span></span>

<span class="class"><span class="keyword">class</span> <span class="title">SpeedFilter</span><span class="params">(minSpeed: Int, pipe: ActorRef)</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>

  <span class="comment">// Filter all Photos which have a speed lower than the minimal speed</span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> msg: Photo =&gt;
      <span class="keyword">if</span> (msg.speed &gt; minSpeed) pipe ! msg
  }
}

<span class="comment">// Filter all Photos which have an empty license</span>
<span class="class"><span class="keyword">class</span> <span class="title">LicenseFilter</span><span class="params">(pipe: ActorRef)</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> msg: Photo =&gt;
      <span class="keyword">if</span> (!msg.license.isEmpty) pipe ! msg
  }
}


<span class="comment">// Pipe and filter test</span>

<span class="keyword">val</span> endProbe = TestProbe()
<span class="keyword">val</span> speedFilterRef = system.actorOf( Props(<span class="keyword">new</span> SpeedFilter(<span class="number">50</span>, endProbe.ref)))

<span class="keyword">val</span> licenseFilterRef = system.actorOf(Props(<span class="keyword">new</span> LicenseFilter(speedFilterRef)))
<span class="keyword">val</span> msg = <span class="keyword">new</span> Photo(<span class="string">"123xyz"</span>, <span class="number">60</span>)

licenseFilterRef ! msg
endProbe.expectMsg(msg)
licenseFilterRef ! <span class="keyword">new</span> Photo(<span class="string">""</span>, <span class="number">60</span>)

endProbe.expectNoMsg(<span class="number">1</span> second)
licenseFilterRef ! <span class="keyword">new</span> Photo(<span class="string">"123xyz"</span>, <span class="number">49</span>)
endProbe.expectNoMsg(<span class="number">1</span> second)
</pre></td></tr></table></figure>

<h1 id="scatter-gather-pattern">Scatter-Gather Pattern</h1>
<p>The first case is when the
tasks are functionally the same, but only one is passed through to the gather
component as the chosen result. The second scenario is when work is divided for
parallel processing and each processor submits its results which are then combined
into a result set by the aggregator. </p>
<h2 id="competing-tasks">Competing Tasks</h2>
<p>A client buys a product, let&#39;s say a book at a
web shop, but the shop doesn&#39;t have the requested book in stock, so it has to buy
the book from a supplier. But the shop is doing business with three different
suppliers and wants to pay the lowest price.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="code"><pre><span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">PhotoMessage</span><span class="params">(id: String,
    photo: String,
    creationTime: Option[Date] = None,
    speed: Option[Int] = None)</span></span>
    
<span class="comment">// task  handler</span>
<span class="class"><span class="keyword">class</span> <span class="title">GetSpeed</span><span class="params">(pipe:ActorRef)</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> msg:PhotoMessage =&gt; {
      pipe ! msp.copy(speed = ImageProcessing.getSpeed(msg.photo))
    }
  }
}
<span class="class"><span class="keyword">class</span> <span class="title">GetTime</span><span class="params">(pipe: ActorRef)</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> msg: PhotoMessage =&gt; {
      pipe ! msg.copy(creationTime = ImageProcessing.getTime(msg.photo))
    }
  }
}

<span class="comment">// distribute received message to all processing tasks</span>
<span class="class"><span class="keyword">class</span> <span class="title">RecipientList</span><span class="params">(recipientList:Seq[ActorRef])</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> msg: AnyRef =&gt; recipientList.foreach( _ ! msg)
  }
}

<span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">TimeoutMessage</span><span class="params">(msg:PhotoMessage)</span></span>

<span class="comment">// 聚合, 等待两个actor消息, 当一个消息回来时, 接着等待另一个, 加上了定时功能</span>
<span class="class"><span class="keyword">class</span> <span class="title">Aggregator</span><span class="params">(timeout:Duration, pipe:ActorRef)</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">val</span> messages = <span class="keyword">new</span> ListBuffer[PhotoMessage]
  implicit <span class="keyword">val</span> ec = context.system.dispatcher
  <span class="comment">// Send all the received messages to our own mailbox</span>

  <span class="keyword">override</span> <span class="keyword">def</span> preRestart(reason: Throwable, message: Option[Any]) {
    <span class="keyword">super</span>.preRestart(reason, message)
    messages.foreach(self ! _)
    messages.clear()
  }
  
  <span class="comment">// The first thing when receiving a message,</span>
  <span class="comment">// is to check if it is the first message or the second. </span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> rcvMsg: PhotoMessage =&gt; {
      messages.find(_.id == rcvMsg.id) <span class="keyword">match</span> {
        <span class="keyword">case</span> Some(alreadyRcvMsg) =&gt; {
        
          <span class="keyword">val</span> newCombinedMsg = <span class="keyword">new</span> PhotoMessage(
            rcvMsg.id,
            rcvMsg.photo,
            rcvMsg.creationTime.orElse(alreadyRcvMsg.creationTime),
            rcvMsg.speed.orElse(alreadyRcvMsg.speed) )
            
          pipe ! newCombinedMsg
          <span class="comment">//cleanup message</span>
          messages -= alreadyRcvMsg
        }
        <span class="keyword">case</span> None =&gt;{
          messages += rcvMsg
          <span class="comment">// 如果在规定的时间内没有收到信息</span>
          context.system.scheduler.scheduleOnce(
            timeout,
            self,
            <span class="keyword">new</span> TimeoutMessage(rcvMsg))
        }
    }
    <span class="keyword">case</span> TimeoutMessage(rcvMsg) =&gt; {
      messages.find(_.id == rcvMsg.id) <span class="keyword">match</span> {
        <span class="keyword">case</span> Some(alreadyRcvMsg) =&gt; {
          pipe ! alreadyRcvMsg
          messages -= alreadyRcvMsg
        }
        <span class="keyword">case</span> None =&gt; <span class="comment">//message is already processed</span>
    }
    <span class="keyword">case</span> ex: Exception =&gt; <span class="keyword">throw</span> ex
  }
}
</pre></td></tr></table></figure>

<p>Test Aggregator missing a message</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="keyword">val</span> endProbe = TestProbe()
<span class="keyword">val</span> actorRef = system.actorOf(Props(<span class="keyword">new</span> Aggregator(<span class="number">1</span> second, endProbe.<span class="keyword">ref</span>)))
<span class="keyword">val</span> photoStr = ImageProcessing.createPhotoString(<span class="keyword">new</span> Date(), <span class="number">60</span>)
<span class="keyword">val</span> msg1 = PhotoMessage(<span class="string">"id1"</span>, photoStr, Some(<span class="keyword">new</span> Date()), None)
actorRef ! msg1
actorRef ! <span class="keyword">new</span> IllegalStateException(<span class="string">"restart"</span>)
<span class="keyword">val</span> msg2 = PhotoMessage(<span class="string">"id1"</span>,photoStr, None, Some(<span class="number">60</span>))
actorRef ! msg2

<span class="keyword">val</span> combinedMsg = PhotoMessage(<span class="string">"id1"</span>, photoStr, msg1.creationTime, msg2.speed)
endProbe.expectMsg(combinedMsg)
</pre></td></tr></table></figure>

<h1 id="routing-messages">Routing Messages</h1>
<p>Akka’s routing feature lets you alter a message’s path from
sender to receiver.</p>
<p>Akka provides a set of standard routers that implement routing patterns that
frequently show up in those everyday problems.</p>
<h2 id="roundrobinrouter">RoundRobinRouter</h2>
<p>The RoundRobinRouter sends messages to the Actors for which it fronts in
a round-robin fashion.</p>
<h2 id="smallestmailboxrouter">SmallestMailboxRouter</h2>
<p>When a message comes into the Router, it decides to route the message to
the composed Actor whose Mailbox is the smallest.</p>
<p>The SmallestMailboxRouter is a pretty good choice when it comes to
balancing load among your composed Actors. </p>
<h2 id="configuring-a-router">Configuring a Router</h2>
<p>The configurations are specified in the akka.actor.deployment block. Be-
low is a simple configuration of a RoundRobinRouter, which would appear
in your application.conf file:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>akka {
  actor {
    deployment {
      /DatabaseConnectionRouter {
        router <span class="subst">=</span> <span class="string">"round-robin"</span>
        nr<span class="attribute">-of</span><span class="attribute">-instances</span> <span class="subst">=</span> <span class="number">20</span>
      }
    }
  }
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="keyword">import</span> akka.routing.FromConfig
<span class="class"><span class="keyword">class</span> <span class="title">DBConnection</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span> ...
}
<span class="keyword">val</span> dbRouter = system.actorOf(Props[DBConnection].withRouter(FromConfig(),
                              <span class="string">"DatabaseConnectionRouter"</span>), <span class="string">"DBRouter"</span>)
</pre></td></tr></table></figure>

<p>The dbRouter will be an instance of a RoundRobinRouter that will rep-
resent the database connection, and it will also be the parent of 20 instances
of the DBConnection Actor.</p>
<h2 id="routers-and-children">Routers and Children</h2>
<p>Routers route to routees. You can create those routees dynamically by the
Router, or you can assign them to it from an already created set. </p>
<p>These two different methods of assigning routees have an impact
on the relationship and supervision of those routees.</p>
<h2 id="letting-the-router-create-the-routees">Letting the Router Create the Routees</h2>
<p>Advantages</p>
<ul>
<li>The Router handles the Supervision.</li>
<li>It works well with configuration.</li>
</ul>
<p>Disadvantages</p>
<ul>
<li>You’ll have a difficult time constructing anything but a single type of
Actor.</li>
<li>You can’t name them the way you might like.</li>
</ul>
<h2 id="passing-the-router-pre-created-actors">Passing the Router Pre-Created Actors</h2>
<ul>
<li>You have to have parents for them.</li>
<li>It’s not as flexible from a configuration perspective. </li>
</ul>
<h2 id="the-router-and-its-children-s-life-cycles">The Router and Its Children’s Life Cycles</h2>
<p>When the Router creates the routees, they are its children, which means that
the Router must manage their life cycles. The Router will assign a
supervisorStrategy that always escalates the decision to its parent.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre>val dbRouter = system<span class="preprocessor">.actorOf</span>(Props<span class="preprocessor">.empty</span><span class="preprocessor">.withRouter</span>(RoundRobinRouter(
    nrOfInstances = <span class="number">5</span>,
    supervisorStrategy = OneForOneStrategy {
    // define your Decider here
    }), <span class="string">"DBRouter"</span>)

// you can assign that easily enough:
val dbRouter = system<span class="preprocessor">.actorOf</span>(Props<span class="preprocessor">.empty</span><span class="preprocessor">.withRouter</span>(RoundRobinRouter(
    nrOfInstances = <span class="number">5</span>,
    supervisorStrategy = SupervisorStrategy<span class="preprocessor">.defaultStrategy</span>
    ), <span class="string">"DBRouter"</span>)
</pre></td></tr></table></figure>

<h2 id="routers-on-a-plane">Routers on a Plane</h2>
<p>A BroadcastRouter would make the perfect component for allowing the passengers
to receive important information, such as “Fasten Seat Belts,”.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre>zzz<span class="preprocessor">.akka</span><span class="preprocessor">.avionics</span> {
  passengers = [
    [ <span class="string">"Kelly Franqui"</span>, <span class="string">"01"</span>, <span class="string">"A"</span> ],
    [ <span class="string">"Tyrone Dotts"</span>, <span class="string">"02"</span>, <span class="string">"B"</span> ],
    [ <span class="string">"Malinda Class"</span>, <span class="string">"03"</span>, <span class="string">"C"</span> ],
    [ <span class="string">"Kenya Jolicoeur"</span>, <span class="string">"04"</span>, <span class="string">"A"</span> ],
    [ <span class="string">"Christian Piche"</span>, <span class="string">"10"</span>, <span class="string">"B"</span> ],
    [ <span class="string">"Neva Delapena"</span>, <span class="string">"11"</span>, <span class="string">"C"</span> ],
    [ <span class="string">"Alana Berrier"</span>, <span class="string">"12"</span>, <span class="string">"A"</span> ],
    [ <span class="string">"Malinda Heister"</span>, <span class="string">"13"</span>, <span class="string">"B"</span> ],
    [ <span class="string">"Carlene Heiney"</span>, <span class="string">"14"</span>, <span class="string">"C"</span> ],
    [ <span class="string">"Erik Dannenberg"</span>, <span class="string">"15"</span>, <span class="string">"A"</span> ],
    [ <span class="string">"Jamie Karlin"</span>, <span class="string">"20"</span>, <span class="string">"B"</span> ],
    [ <span class="string">"Julianne Schroth"</span>, <span class="string">"21"</span>, <span class="string">"C"</span> ],
    [ <span class="string">"Elinor Boris"</span>, <span class="string">"22"</span>, <span class="string">"A"</span> ],
    [ <span class="string">"Louisa Mikels"</span>, <span class="string">"30"</span>, <span class="string">"B"</span> ],
    [ <span class="string">"Jessie Pillar"</span>, <span class="string">"31"</span>, <span class="string">"C"</span> ],
    [ <span class="string">"Darcy Goudreau"</span>, <span class="string">"32"</span>, <span class="string">"A"</span> ],
    [ <span class="string">"Harriett Isenhour"</span>, <span class="string">"33"</span>, <span class="string">"B"</span> ],
    [ <span class="string">"Odessa Maury"</span>, <span class="string">"34"</span>, <span class="string">"C"</span> ],
    [ <span class="string">"Malinda Hiett"</span>, <span class="string">"40"</span>, <span class="string">"A"</span> ],
    [ <span class="string">"Darcy Syed"</span>, <span class="string">"41"</span>, <span class="string">"B"</span> ],
    [ <span class="string">"Julio Dismukes"</span>, <span class="string">"42"</span>, <span class="string">"C"</span> ],
    [ <span class="string">"Jessie Altschuler"</span>, <span class="string">"43"</span>, <span class="string">"A"</span> ],
    [ <span class="string">"Tyrone Ericsson"</span>, <span class="string">"44"</span>, <span class="string">"B"</span> ],
    [ <span class="string">"Mallory Dedrick"</span>, <span class="string">"50"</span>, <span class="string">"C"</span> ],
    [ <span class="string">"Javier Broder"</span>, <span class="string">"51"</span>, <span class="string">"A"</span> ],
    [ <span class="string">"Alejandra Fritzler"</span>, <span class="string">"52"</span>, <span class="string">"B"</span> ],
    [ <span class="string">"Rae Mcaleer"</span>, <span class="string">"53"</span>, <span class="string">"C"</span> ]
  ]
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="class"><span class="keyword">object</span> <span class="title">Passenger</span> {</span>
  <span class="comment">// These are notifications that tell the Passenger</span>
  <span class="comment">// to fasten or unfasten their seat belts</span>
  <span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">FastenSeatbelts</span></span>
  <span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">UnfastenSeatbelts</span></span>
  <span class="comment">// Regular expression to extract Name-Row-Seat tuple</span>
  <span class="keyword">val</span> SeatAssignment = <span class="string">"""([\w\s_]+)-(\d+)-([A-Z])"""</span>.r
}

<span class="comment">// The DrinkRequestProbability trait defines some</span>
<span class="comment">// thresholds that we can modify in tests to</span>
<span class="comment">// speed things up.</span>
<span class="class"><span class="keyword">trait</span> <span class="title">DrinkRequestProbability</span> {</span>
  <span class="comment">// Limits the decision on whether the passenger</span>
  <span class="comment">// actually asks for a drink</span>
  <span class="keyword">val</span> askThreshold = <span class="number">0.9</span>f
  
  <span class="comment">// The minimum time between drink requests</span>
  <span class="keyword">val</span> requestMin = <span class="number">20.</span>minutes
  
  <span class="comment">// Some portion of this (0 to 100</span>
  <span class="comment">// to requestMin</span>
  <span class="keyword">val</span> requestUpper = <span class="number">30.</span>minutes
  <span class="comment">// Gives us a 'random' time within the previous</span>
  <span class="comment">// two bounds</span>
  <span class="keyword">def</span> randomishTime(): Duration = {
    requestMin + scala.util.Random.nextInt(requestUpper.toMillis.toInt).millis
  }
}

<span class="comment">// The idea behind the PassengerProvider is old news at this point.</span>
<span class="comment">// We can use it in other classes to give us the ability to slide</span>
<span class="comment">// in different Actor types to ease testing.</span>
<span class="class"><span class="keyword">trait</span> <span class="title">PassengerProvider</span> {</span>
  <span class="keyword">def</span> newPassenger(callButton: ActorRef): Actor =
    <span class="keyword">new</span> Passenger(callButton) <span class="keyword">with</span> DrinkRequestProbability
}
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">Passenger</span><span class="params">(callButton: ActorRef)</span> <span class="keyword">extends</span> <span class="title">Actor</span> <span class="keyword">with</span> <span class="title">ActorLogging</span> {</span>
  <span class="keyword">this</span>: DrinkRequestProbability =&gt;
  <span class="keyword">import</span> Passenger._
  <span class="keyword">import</span> FlightAttendant.{GetDrink, Drink}
  <span class="keyword">import</span> scala.collection.JavaConverters._
  
  <span class="comment">// We'll be adding some randomness to our Passenger,</span>
  <span class="comment">// and this shortcut will make things a little more</span>
  <span class="comment">// readable.</span>
  <span class="keyword">val</span> r = scala.util.Random
  
  <span class="comment">// It's about time that someone actually asked for a</span>
  <span class="comment">// drink since our Flight Attendants have been coded</span>
  <span class="comment">// to serve them up</span>
  <span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">CallForDrink</span></span>
  
  <span class="comment">// The name of the Passenger can't have spaces in it,</span>
  <span class="comment">// since that's not a valid character in the URI</span>
  <span class="comment">// spec. We know the name will have underscores in</span>
  <span class="comment">// place of spaces, and we'll convert those back</span>
  <span class="comment">// here.</span>
  <span class="keyword">val</span> SeatAssignment(myname, _, _) =
    self.path.name.replaceAllLiterally(<span class="string">"_"</span>, <span class="string">" "</span>)
    
  <span class="comment">// We'll be pulling some drink names from the</span>
  <span class="comment">// configuration file as well</span>
  <span class="keyword">val</span> drinks = context.system.settings.config.getStringList(<span class="string">"zzz.akka.avionics.drinks"</span>).asScala.toIndexedSeq
  
  <span class="comment">// A shortcut for the scheduler to make things look</span>
  <span class="comment">// nicer later</span>
  <span class="keyword">val</span> scheduler = context.system.scheduler
  
  <span class="comment">// We've just sat down, so it's time to get a drink</span>
  <span class="keyword">override</span> <span class="keyword">def</span> preStart() {
    self ! CallForDrink
  }

  <span class="comment">// This method will decide whether or not we actually</span>
  <span class="comment">// want to get a drink using some randomness to</span>
  <span class="comment">// decide</span>
  <span class="keyword">def</span> maybeSendDrinkRequest(): Unit = {
    <span class="keyword">if</span> (r.nextFloat() &gt; askThreshold) {
      <span class="keyword">val</span> drinkname = drinks(r.nextInt(drinks.length))
      callButton ! GetDrink(drinkname)
    }
    scheduler.scheduleOnce(randomishTime(), self, CallForDrink)
  }

  <span class="comment">// Standard message handler</span>
  <span class="keyword">def</span> receive = {
    <span class="keyword">case</span> CallForDrink =&gt;
      maybeSendDrinkRequest()
    <span class="keyword">case</span> Drink(drinkname) =&gt;
      log.info(<span class="string">"{} received a {} - Yum"</span>, myname, drinkname)
    <span class="keyword">case</span> FastenSeatbelts =&gt;
      log.info(<span class="string">"{} fastening seatbelt"</span>, myname)
    <span class="keyword">case</span> UnfastenSeatbelts =&gt;
      log.info(<span class="string">"{} UNfastening seatbelt"</span>, myname)
  }
}
</pre></td></tr></table></figure>

<p>Testing and the Event Stream</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="class"><span class="keyword">trait</span> <span class="title">TestDrinkRequestProbability</span> <span class="keyword">extends</span> <span class="title">DrinkRequestProbability</span> {</span>
  <span class="keyword">override</span> <span class="keyword">val</span> askThreshold = <span class="number">0</span>f
  <span class="keyword">override</span> <span class="keyword">val</span> requestMin = <span class="number">0.</span>milliseconds
  <span class="keyword">override</span> <span class="keyword">val</span> requestUpper = <span class="number">2.</span>milliseconds
}

<span class="class"><span class="keyword">class</span> <span class="title">PassengersSpec</span> <span class="keyword">extends</span> <span class="title">TestKit</span><span class="params">(ActorSystem()</span>) <span class="keyword">with</span> <span class="title">ImplicitSender</span> {</span>
  <span class="keyword">import</span> akka.event.Logging.Info
  <span class="keyword">import</span> akka.testkit.TestProbe
  <span class="keyword">var</span> seatNumber = <span class="number">9</span>
  
  <span class="keyword">def</span> newPassenger(): ActorRef = {
    seatNumber += <span class="number">1</span>
    system.actorOf(Props(<span class="keyword">new</span> Passenger(testActor) <span class="keyword">with</span> TestDrinkRequestProbability), s<span class="string">"Pat_Metheny-$seatNumber-B"</span>)
  }
  
  <span class="string">"Passengers"</span> should {
    <span class="string">"fasten seatbelts when asked"</span> in {
      <span class="keyword">val</span> a = newPassenger()
      <span class="keyword">val</span> p = TestProbe()
      <span class="comment">// This says that we want the TestProbe’s ActorRef (p.ref) to be the handle</span>
      <span class="comment">// to the subscribed Actor, and that we want it to receive events that match the</span>
      <span class="comment">// class akka.event.Logger.Info. </span>
      system.eventStream.subscribe(p.ref, classOf[Info])
      
      a ! FastenSeatbelts
      p.expectMsgPF() {
        <span class="keyword">case</span> Info(_, _, m) =&gt;
          m.toString must include (<span class="string">"fastening seatbelt"</span>)
      }
    }
  }
}
</pre></td></tr></table></figure>

<h3 id="the-passenger-router">The Passenger Router</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="code"><pre><span class="class"><span class="keyword">object</span> <span class="title">PassengerSupervisor</span> {</span>
  <span class="comment">// Allows someone to request the BroadcastRouter</span>
  <span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">GetPassengerBroadcaster</span></span>
  <span class="comment">// Returns the BroadcastRouter to the requestor</span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">PassengerBroadcaster</span><span class="params">(broadcaster: ActorRef)</span></span>
  <span class="comment">// Factory method for easy construction</span>
  <span class="keyword">def</span> apply(callButton: ActorRef) = <span class="keyword">new</span> PassengerSupervisor(callButton)
        <span class="keyword">with</span> PassengerProvider
}

<span class="class"><span class="keyword">class</span> <span class="title">PassengerSupervisor</span><span class="params">(callButton: ActorRef)</span> <span class="keyword">extends</span> <span class="title">Actor</span> {</span>
  <span class="keyword">this</span>: PassengerProvider =&gt;
  <span class="keyword">import</span> PassengerSupervisor._
  <span class="comment">// We'll resume our immediate children instead of restarting them</span>
  <span class="comment">// on an Exception</span>
  <span class="keyword">override</span> <span class="keyword">val</span> supervisorStrategy = OneForOneStrategy() {
    <span class="keyword">case</span> _: ActorKilledException =&gt; Escalate
    <span class="keyword">case</span> _: ActorInitializationException =&gt; Escalate
    <span class="keyword">case</span> _ =&gt; Resume
  }
  
  <span class="comment">// Internal messages we use to communicate between this Actor</span>
  <span class="comment">// and its subordinate IsolatedStopSupervisor</span>
  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">GetChildren</span><span class="params">(forSomeone: ActorRef)</span></span>

  <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">Children</span><span class="params">(children: Iterable[ActorRef], childrenFor: ActorRef)</span></span>
  
  <span class="comment">// We use preStart() to create our IsolatedStopSupervisor</span>
  <span class="keyword">override</span> <span class="keyword">def</span> preStart() {
    context.actorOf(Props(<span class="keyword">new</span> Actor {
      <span class="keyword">val</span> config = context.system.settings.config
      
      <span class="keyword">override</span> <span class="keyword">val</span> supervisorStrategy = OneForOneStrategy() {
        <span class="keyword">case</span> _: ActorKilledException =&gt; Escalate
        <span class="keyword">case</span> _: ActorInitializationException =&gt; Escalate
        <span class="keyword">case</span> _ =&gt; Stop
      }
      <span class="keyword">override</span> <span class="keyword">def</span> preStart() {
        <span class="keyword">import</span> scala.collection.JavaConverters._
        <span class="keyword">import</span> com.typesafe.config.ConfigList
        <span class="comment">// Get our passenger names from the configuration</span>
        <span class="keyword">val</span> passengers = config.getList(<span class="string">"zzz.akka.avionics.passengers"</span>)
        
        <span class="comment">// Iterate through them to create the passenger children</span>
        passengers.asScala.foreach { nameWithSeat =&gt;
          <span class="keyword">val</span> id = nameWithSeat.asInstanceOf[ConfigList].unwrapped().asScala.mkString(<span class="string">"-"</span>).replaceAllLiterally(<span class="string">" "</span>, <span class="string">"_"</span>)
          <span class="comment">// Convert spaces to underscores to comply with URI standard</span>
          context.actorOf(Props(newPassenger(callButton)), id)
        }
      }
    
      <span class="keyword">override</span> <span class="keyword">def</span> receive = {
        <span class="keyword">case</span> GetChildren(forSomeone: ActorRef) =&gt;
          sender ! Children(context.children, forSomeone)
      }
    }), <span class="string">"PassengersSupervisor"</span>)
  }

  <span class="keyword">def</span> receive = noRouter

  <span class="comment">// TODO: This noRouter method could be made simpler by using a Future.</span>
  <span class="comment">// We'll have to refactor this later.</span>
  <span class="keyword">def</span> noRouter: Receive = {
    <span class="keyword">case</span> GetPassengerBroadcaster =&gt;
      context.actorFor(<span class="string">"PassengersSupervisor"</span>) ! GetChildren(sender)
    <span class="keyword">case</span> Children(passengers, destinedFor) =&gt;
      <span class="keyword">val</span> router = context.actorOf(Props().withRouter(
        BroadcastRouter(passengers.toSeq)), <span class="string">"Passengers"</span>)
        
      destinedFor ! PassengerBroadcaster(router)
      context.become(withRouter(router))
  }
  
  <span class="keyword">def</span> withRouter(router: ActorRef): Receive = {
    <span class="keyword">case</span> GetPassengerBroadcaster =&gt;
      sender ! PassengerBroadcaster(router)
  }

}
</pre></td></tr></table></figure>

<h3 id="using-the-passenger-router">Using the Passenger Router</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="code"><pre><span class="keyword">package</span> zzz.akka.avionics

<span class="keyword">import</span> akka.actor.{ActorSystem, Actor, ActorRef, Props}
<span class="keyword">import</span> akka.testkit.{TestKit, ImplicitSender}
<span class="keyword">import</span> scala.concurrent.util.duration._
<span class="keyword">import</span> com.typesafe.config.ConfigFactory
<span class="keyword">import</span> org.scalatest.{WordSpec, BeforeAndAfterAll}
<span class="keyword">import</span> org.scalatest.matchers.MustMatchers


<span class="comment">// ActorSystem so we have a known quantity we can test with</span>
<span class="class"><span class="keyword">object</span> <span class="title">PassengerSupervisorSpec</span> {</span>
  <span class="keyword">val</span> config = ConfigFactory.parseString(<span class="string">"""
    zzz.akka.avionics.passengers = [
      [ "Kelly Franqui", "23", "A" ],
      [ "Tyrone Dotts", "23", "B" ],
      [ "Malinda Class", "23", "C" ],
      [ "Kenya Jolicoeur", "24", "A" ],
      [ "Christian Piche", "24", "B" ]
    ]
  """</span>)
}

<span class="comment">// We don't want to work with "real" passengers.</span>
 This mock
<span class="comment">// passenger will be much easier to verify things with</span>
<span class="class"><span class="keyword">trait</span> <span class="title">TestPassengerProvider</span> <span class="keyword">extends</span> <span class="title">PassengerProvider</span> {</span>
  <span class="keyword">override</span> <span class="keyword">def</span> newPassenger(callButton: ActorRef): Actor =
    <span class="keyword">new</span> Actor {
      <span class="keyword">def</span> receive = {
        <span class="keyword">case</span> m =&gt; callButton ! m
      }
    }
}

<span class="comment">// The Test class injects the configuration into the</span>
<span class="comment">// ActorSystem</span>
<span class="class"><span class="keyword">class</span> <span class="title">PassengerSupervisorSpec</span> <span class="keyword">extends</span></span>
    TestKit(ActorSystem(<span class="string">"PassengerSupervisorSpec"</span>, PassengerSupervisorSpec.config))
        <span class="keyword">with</span> ImplicitSender
        <span class="keyword">with</span> WordSpec
        <span class="keyword">with</span> BeforeAndAfterAll
        <span class="keyword">with</span> MustMatchers {
  <span class="keyword">import</span> PassengerSupervisor._
  <span class="comment">// Clean up the system when all the tests are done</span>
  <span class="keyword">override</span> <span class="keyword">def</span> afterAll() {
    system.shutdown()
  }

  <span class="string">"PassengerSupervisor"</span> should {
    <span class="string">"work"</span> in {
      <span class="comment">// Get our SUT</span>
      <span class="keyword">val</span> a = system.actorOf(Props(<span class="keyword">new</span> PassengerSupervisor(testActor) <span class="keyword">with</span> TestPassengerProvider))
      
      <span class="comment">// Grab the BroadcastRouter</span>
      a ! GetPassengerBroadcaster
      <span class="keyword">val</span> broadcaster = expectMsgPF() {
        <span class="keyword">case</span> PassengerBroadcaster(b) =&gt;
          <span class="comment">// Exercise the BroadcastRouter</span>
          b ! <span class="string">"Hithere"</span>
          
          <span class="comment">// All 5 passengers should say "Hithere"</span>
          expectMsg(<span class="string">"Hithere"</span>)
          expectMsg(<span class="string">"Hithere"</span>)
          expectMsg(<span class="string">"Hithere"</span>)
          expectMsg(<span class="string">"Hithere"</span>)
          expectMsg(<span class="string">"Hithere"</span>)
          
          <span class="comment">// And then nothing else!</span>
          expectNoMsg(<span class="number">100.</span>milliseconds)
          <span class="comment">// Return the BroadcastRouter</span>
          b
      }
      
      <span class="comment">// Ensure that the cache works</span>
      a ! GetPassengerBroadcaster
      expectMsg(PassengerBroadcaster(`broadcaster`))
    }
  }
}
</pre></td></tr></table></figure>

<p>TODO</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/akka/">akka</a><a href="/tags/scala/">scala</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://zhpooer.github.io/2014/08/04/akka-in-action-system-structure/" data-title="Akka in Action-System Structure &amp; Routing Messages | Poe&#39;s World" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/08/05/akka-in-action-message-channels/" title="Akka in Action-Message Channels &amp; Finite State Machines">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Akka in Action-Message Channels &amp; Finite State Machines</span>
</a>
</div>


<div class="next">
<a href="/2014/08/04/akka-in-action-distribute-akka-app/"  title="Akka in Action-Distribute Akka App">
 <strong>NEXT:</strong><br/> 
 <span>Akka in Action-Distribute Akka App
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#pipes-and-filters"><span class="toc-number">1.</span> <span class="toc-text">Pipes and Filters</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#scatter-gather-pattern"><span class="toc-number">2.</span> <span class="toc-text">Scatter-Gather Pattern</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#competing-tasks"><span class="toc-number">2.1.</span> <span class="toc-text">Competing Tasks</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#routing-messages"><span class="toc-number">3.</span> <span class="toc-text">Routing Messages</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#roundrobinrouter"><span class="toc-number">3.1.</span> <span class="toc-text">RoundRobinRouter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smallestmailboxrouter"><span class="toc-number">3.2.</span> <span class="toc-text">SmallestMailboxRouter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configuring-a-router"><span class="toc-number">3.3.</span> <span class="toc-text">Configuring a Router</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#routers-and-children"><span class="toc-number">3.4.</span> <span class="toc-text">Routers and Children</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#letting-the-router-create-the-routees"><span class="toc-number">3.5.</span> <span class="toc-text">Letting the Router Create the Routees</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#passing-the-router-pre-created-actors"><span class="toc-number">3.6.</span> <span class="toc-text">Passing the Router Pre-Created Actors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-router-and-its-children-s-life-cycles"><span class="toc-number">3.7.</span> <span class="toc-text">The Router and Its Children’s Life Cycles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#routers-on-a-plane"><span class="toc-number">3.8.</span> <span class="toc-text">Routers on a Plane</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#the-passenger-router"><span class="toc-number">3.8.1.</span> <span class="toc-text">The Passenger Router</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#using-the-passenger-router"><span class="toc-number">3.8.2.</span> <span class="toc-text">Using the Passenger Router</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/AJAX/" title="AJAX">AJAX<sup>1</sup></a></li>
		
			<li><a href="/tags/Akka/" title="Akka">Akka<sup>1</sup></a></li>
		
			<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
		
			<li><a href="/tags/DOM/" title="DOM">DOM<sup>2</sup></a></li>
		
			<li><a href="/tags/EL表达式/" title="EL表达式">EL表达式<sup>1</sup></a></li>
		
			<li><a href="/tags/HBase/" title="HBase">HBase<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>2</sup></a></li>
		
			<li><a href="/tags/HttpSession/" title="HttpSession">HttpSession<sup>1</sup></a></li>
		
			<li><a href="/tags/IO/" title="IO">IO<sup>1</sup></a></li>
		
			<li><a href="/tags/Illustrator/" title="Illustrator">Illustrator<sup>3</sup></a></li>
		
			<li><a href="/tags/JSP/" title="JSP">JSP<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaBean/" title="JavaBean">JavaBean<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>1</sup></a></li>
		
			<li><a href="/tags/Mybatis/" title="Mybatis">Mybatis<sup>1</sup></a></li>
		
			<li><a href="/tags/NoSql/" title="NoSql">NoSql<sup>1</sup></a></li>
		
			<li><a href="/tags/SASS/" title="SASS">SASS<sup>1</sup></a></li>
		
			<li><a href="/tags/SAX/" title="SAX">SAX<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletRequest/" title="ServletRequest">ServletRequest<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletResponse/" title="ServletResponse">ServletResponse<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://zhpooer.github.io" target="_blank" title="zhpooer">zhpooer</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"zhpoooer"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
