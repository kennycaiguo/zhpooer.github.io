
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>BackBone | Poe&#39;s World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zhpooer">
    
    <meta name="description" content="什么是前端， Html +　Javascript
html javascript 混杂在一起，开起来是一个大杂烩
什么是好的代码，应当把你的应用解藕成一系列相互平等且独立的页面
使用类、继承、对象和设计模式
MVC:数据(模型)　展示层(视图)　用户交互层(控制器)

用户和应用产生交互
控制器的事">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="Poe&#39;s World" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Poe&#39;s World" title="Poe&#39;s World"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Poe&#39;s World">Poe&#39;s World</a></h1>
				<h2 class="blog-motto">竹杖芒鞋轻胜马，一蓑烟雨任平生</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/english-monthly">英语角</a></li>
					
						<li><a href="/about">关于</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:zhpooer.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/04/21/backbone/" title="BackBone" itemprop="url">BackBone</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://zhpooer.github.io" title="zhpooer">zhpooer</a>
    </p>
  <p class="article-time">
    <time datetime="2015-04-21T12:13:57.000Z" itemprop="datePublished">4月 21 2015</time>
    更新日期:<time datetime="2015-04-23T03:46:28.830Z" itemprop="dateModified">4月 23 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#-model-"><span class="toc-number">1.</span> <span class="toc-text">模型(Model)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">2.</span> <span class="toc-text">视图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">3.</span> <span class="toc-text">控制器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">4.</span> <span class="toc-text">程序入口</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#todo"><span class="toc-number">5.</span> <span class="toc-text">TODO</span></a></li></ol>
		</div>
		
		<p>什么是前端， Html +　Javascript</p>
<p>html javascript 混杂在一起，开起来是一个大杂烩</p>
<p>什么是好的代码，应当把你的应用解藕成一系列相互平等且独立的页面</p>
<p>使用类、继承、对象和设计模式</p>
<p>MVC:数据(模型)　展示层(视图)　用户交互层(控制器)</p>
<ol>
<li>用户和应用产生交互</li>
<li>控制器的事件处理器被触发</li>
<li>控制器从模型中请求数据，并将其交给视图</li>
<li>视图将数据呈现给用户</li>
</ol>
<h1 id="-model-">模型(Model)</h1>
<p>用来存放所有的数据对象</p>
<p>模型不必知晓视图和控制器的细节，只需要包行数据及直接和这些数据相关的逻辑</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre>  <span class="comment">// model.js</span>
  <span class="comment">// 用户字段</span>
  <span class="keyword">var</span> User = Backbone.Model.extend({
    defaults: {
      identity: UserType.SelfEmployed,
      canSpouseGuarantee: UserMap.CanSpouseGuarantee.Canot,
      socialSecurityFundmonth: -<span class="number">1</span>,
    },
    isCompany: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">var</span> identity = <span class="keyword">this</span>.<span class="keyword">get</span>(<span class="string">'identity'</span>);
      <span class="keyword">return</span> identity != UserType.WageEarner && identity != UserType.Other;
    }
  });

  <span class="comment">// 记录页面信息</span>
  <span class="keyword">var</span> PageInfo = Backbone.Model.extend({
    defaults: {
      permission: [ UserType.BusinessOwner,
                    UserType.SelfEmployed,
                    UserType.WageEarner,
                    UserType.Other ],
      current: <span class="literal">false</span>,  <span class="comment">// 是否当前页</span>
      showInNav: <span class="literal">true</span>, <span class="comment">// 时候要显示在侧边栏上，针对 Index</span>
      forInput: <span class="literal">true</span>,  <span class="comment">// 是否要显示出来以便用户填写</span>
      complete: <span class="number">0</span>,     <span class="comment">// 显示填写百分比</span>
      completeForCompany: <span class="number">0</span>, <span class="comment">// 针对企业显示的百分比</span>
      validateKeys: [], <span class="comment">// 必须填写的字段，需要验证的字段，如有特殊情况，重写 isAllFilled</span>
      validateDepends: [] <span class="comment">// 在一定条件下必须填写的字段 参考 UserInfo.js</span>
    },
    initialize: <span class="function"><span class="keyword">function</span><span class="params">( properties )</span>{</span>
      _.extend( <span class="keyword">this</span>, properties );
    }
  }
</pre></td></tr></table></figure>

<h1 id="-">视图</h1>
<p>视图层是呈现给用户的，用户与之产生交互。视图不必知晓模型和控制器中的细节</p>
<p>Html 页面, html 模板</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/template"</span> <span class="attribute">id</span>=<span class="value">"navTemplate"</span>&gt;</span><span class="javascript">
  &lt;i&gt;<span class="xml"><span class="tag">&lt;/<span class="title">i</span>&gt;</span>
  <span class="tag">&lt;<span class="title">span</span>&gt;</span>${name}<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
</span></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</pre></td></tr></table></figure>

<h1 id="-">控制器</h1>
<p>控制器是模型和视图之间的纽带。控制器从视图获得事件和输入，对它们进行处理，
并相应的更新视。当页面加载时，控制器会给视图添加事件监听。</p>
<p>不使用类库和框架也能实现视图</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>$(<span class="string">''</span>).click(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
  <span class="comment">// any code here </span>
});
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
</pre></td><td class="code"><pre><span class="comment">// views.js</span>
(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>

  <span class="keyword">var</span> models = $.app.models;
  <span class="keyword">var</span> PageInfos = models.PageInfos;

  <span class="comment">// 每个页面的原型</span>
  <span class="keyword">var</span> PageView = Backbone.View.extend({
    initialize: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      _.bindAll(<span class="keyword">this</span>, <span class="string">'display'</span>);
      <span class="keyword">this</span>.setElement( <span class="keyword">this</span>.model.<span class="keyword">get</span>(<span class="string">'el'</span>) );
      <span class="keyword">this</span>.model.<span class="keyword">set</span>({view: <span class="keyword">this</span>});

      <span class="comment">// 如果是当前页，则显示出来</span>
      <span class="keyword">this</span>.model.bind(<span class="string">'change:current'</span>, <span class="keyword">this</span>.display);
      <span class="keyword">this</span>.display();
      <span class="keyword">if</span>(<span class="keyword">this</span>.init) <span class="keyword">this</span>.init();
    },
    show: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">this</span>.beforeEnter();
      <span class="keyword">this</span>.$el.show();
    },
    hide: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">this</span>.$el.hide();
      <span class="keyword">this</span>.afterLeave();
    },
    <span class="comment">// 在显示页面之前，需要如何，比如 slogan 隐藏侧边栏</span>
    beforeEnter: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
    },
    <span class="comment">// 在离开页面之后需要如何</span>
    afterLeave: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>},
    display: <span class="function"><span class="keyword">function</span><span class="params">(model, current)</span> {</span>
      <span class="keyword">if</span>( current ){
        <span class="keyword">this</span>.show();
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>.hide();
      }
    },
    <span class="comment">// 因为要大量用到， 所以抽出来一个方法</span>
    <span class="comment">// 将页面显示，绑定到用户变量</span>
    bindWithUser: <span class="function"><span class="keyword">function</span><span class="params">( user, field, event, selector, params)</span>{</span>
      <span class="keyword">var</span> self = <span class="keyword">this</span>;
      <span class="comment">// 用户点击的时候， 回调函数</span>
      params = params || {};

      <span class="keyword">var</span> changeCallback = params.changeCallback;

      <span class="comment">// 当同步的时候， 回调函数</span>
      <span class="keyword">var</span> syncCallback = params.syncCallback;

      <span class="keyword">var</span> change = <span class="function"><span class="keyword">function</span><span class="params">(e)</span>{</span>
        <span class="keyword">var</span> $target = $(e.currentTarget);
        <span class="keyword">var</span> type = $target.data(<span class="string">'type'</span>);
        user.<span class="keyword">set</span>(field, type);
        <span class="comment">// console.log(changeCallback);</span>
        <span class="keyword">if</span>(changeCallback)  changeCallback();
      };

      <span class="keyword">var</span> sync = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        self.$(selector).removeClass(<span class="string">'cur'</span>);
        self.$(selector + <span class="string">'[data-type='</span> + user.<span class="keyword">get</span>(field) + <span class="string">']'</span>).addClass(<span class="string">'cur'</span>);
        <span class="keyword">if</span>(syncCallback)  syncCallback();
      };

      sync();
      self.listenTo(user, <span class="string">'change:'</span> + field, sync);
      <span class="keyword">this</span>.$el.on(event, selector, change);
    }
  });

  <span class="comment">// 侧边栏控制器</span>
  <span class="keyword">var</span> NavItem = Backbone.View.extend({
    tagName: <span class="string">'li'</span>,
    <span class="comment">// TODO 点击实现</span>
    events: {
      <span class="string">"click"</span>: <span class="string">"switchTo"</span>
    },
    initialize: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      _.bindAll(<span class="keyword">this</span>, <span class="string">'toggleCurrent'</span>);
      <span class="keyword">this</span>.template = $(<span class="string">"#navTemplate"</span>).template();

      <span class="keyword">this</span>.listenTo(<span class="keyword">this</span>.model, <span class="string">'change:current'</span>, <span class="keyword">this</span>.toggleCurrent);
      <span class="keyword">this</span>.listenTo(<span class="keyword">this</span>.model, <span class="string">'change:forInput'</span>, <span class="keyword">this</span>.toggleVisible);
    },
    <span class="comment">// 切换到当前页面</span>
    switchTo: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="comment">// appView 监听事件</span>
      Backbone.trigger(<span class="string">"switch"</span>, <span class="keyword">this</span>.model);
    },
	  render: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> element = $.tmpl(<span class="keyword">this</span>.template, <span class="keyword">this</span>.model.toJSON());
		  <span class="keyword">this</span>.$el.html(element);
      <span class="keyword">this</span>.toggleCurrent();
      <span class="keyword">this</span>.toggleVisible();
		  <span class="keyword">return</span> <span class="keyword">this</span>;
    },
    toggleCurrent: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">if</span>(<span class="keyword">this</span>.model.<span class="keyword">get</span>(<span class="string">'current'</span>))  <span class="keyword">this</span>.$el.addClass(<span class="string">'cur'</span>);
      <span class="keyword">else</span> <span class="keyword">this</span>.$el.removeClass(<span class="string">'cur'</span>);
    },
    toggleVisible: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">if</span>(<span class="keyword">this</span>.model.<span class="keyword">get</span>(<span class="string">'forInput'</span>))  <span class="keyword">this</span>.$el.show();
      <span class="keyword">else</span> <span class="keyword">this</span>.$el.hide();
    }
  });


  <span class="comment">// 主控制器</span>
  <span class="keyword">var</span> AppView = Backbone.View.extend({
    events: {
      <span class="string">'click footer.next a'</span>: <span class="string">"gotoNext"</span>
    },
    initialize: <span class="function"><span class="keyword">function</span><span class="params">(data)</span>{</span>
      _.bindAll(<span class="keyword">this</span>, <span class="string">'syncForView'</span>, <span class="string">'pageSwitch'</span>);

      <span class="keyword">this</span>.$nav = <span class="keyword">this</span>.$(<span class="string">'nav ul'</span>);
      <span class="keyword">this</span>.$navIndicator = <span class="keyword">this</span>.$(<span class="string">'nav .cur-step'</span>);
      <span class="keyword">this</span>.user = data.user;
      <span class="keyword">this</span>.cur = <span class="literal">null</span>;  <span class="comment">// 记录当前的 page</span>
      <span class="keyword">this</span>.addNav();
      <span class="keyword">this</span>.gotoNext();
      <span class="keyword">this</span>.syncForView();

      <span class="keyword">this</span>.listenTo(Backbone, <span class="string">'switch'</span>, <span class="keyword">this</span>.pageSwitch);
      <span class="keyword">this</span>.listenTo(Backbone, <span class="string">'goto'</span>, <span class="keyword">this</span>.gotoPage);
      <span class="comment">// 根据用户选择身份来刷新是否要填写的内容</span>
      <span class="keyword">this</span>.listenTo(<span class="keyword">this</span>.user, <span class="string">'change:identity'</span>, <span class="keyword">this</span>.syncForView);
    },
    <span class="comment">// 根据id导航</span>
    gotoPage: <span class="function"><span class="keyword">function</span><span class="params">(pageId)</span>{</span>
      <span class="keyword">var</span> page = <span class="keyword">this</span>.model.find( <span class="function"><span class="keyword">function</span><span class="params">(m)</span>{</span>
        <span class="keyword">return</span> m.<span class="keyword">get</span>(<span class="string">'el'</span>) == pageId;
      });
      <span class="keyword">if</span>(page) <span class="keyword">this</span>.setCurrent(page);
    },
    <span class="comment">// 点击导航栏切换</span>
    pageSwitch: <span class="function"><span class="keyword">function</span><span class="params">(page)</span>{</span>
      <span class="keyword">if</span>(page == <span class="keyword">this</span>.cur ) <span class="keyword">return</span>;
      <span class="keyword">if</span>( !<span class="keyword">this</span>.chkIsFilled() ) {
        $.gritter.add({
	        <span class="comment">// (string | mandatory) the text inside the notification</span>
	        text: <span class="string">'请将字段填充'</span>
        });
        <span class="keyword">return</span>;
      }
      <span class="comment">// 获得没有填写完整 切 index 比要切换的page 小的</span>
      <span class="keyword">var</span> isNotFilled = <span class="keyword">this</span>.model.find(<span class="function"><span class="keyword">function</span><span class="params">(m)</span>{</span>
        <span class="keyword">return</span> page.<span class="keyword">get</span>(<span class="string">'index'</span>) &gt; m.<span class="keyword">get</span>(<span class="string">'index'</span>) && m.isAllFilled(<span class="keyword">this</span>.user);
      });

      <span class="keyword">if</span>(!isNotFilled)
        <span class="keyword">this</span>.setCurrent(page);
    },
    syncForView:<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">var</span> user = <span class="keyword">this</span>.user;
      <span class="keyword">this</span>.model.<span class="keyword">each</span>(<span class="function"><span class="keyword">function</span><span class="params">(page)</span>{</span>
        page.refresh(user.<span class="keyword">get</span>(<span class="string">'identity'</span>));
      });
    },
    addNav: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">this</span>.$nav.html(<span class="string">''</span>);
		  <span class="keyword">this</span>.model.<span class="keyword">each</span>( <span class="function"><span class="keyword">function</span> <span class="params">(page)</span> {</span>
        <span class="keyword">if</span>(page.<span class="keyword">get</span>(<span class="string">'showInNav'</span>)) {
          <span class="keyword">var</span> view = <span class="keyword">new</span> NavItem({ model: page });
          <span class="keyword">this</span>.$nav.append(view.render().el);
        }
		  }, <span class="keyword">this</span>);
    },
    <span class="comment">// 检查当前页面是否全部正确填写</span>
    chkIsFilled: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">if</span>( !<span class="keyword">this</span>.cur) <span class="keyword">return</span> <span class="literal">true</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>.cur.isAllFilled(<span class="keyword">this</span>.user);
    },
    <span class="comment">// 点击切换到下一个页面</span>
    gotoNext: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">if</span>( !<span class="keyword">this</span>.chkIsFilled() ) {
        $.gritter.add({
	        text: <span class="string">'请填充字段'</span>
        });
        <span class="comment">// return;</span>
      }
      <span class="keyword">this</span>.setCurrent(<span class="keyword">this</span>.getNextView());
    },
    <span class="comment">// 获取下一个页面</span>
    getNextView: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">var</span> curIndex = -<span class="number">1</span>;
      <span class="keyword">if</span>(<span class="keyword">this</span>.cur) curIndex = <span class="keyword">this</span>.cur.<span class="keyword">get</span>(<span class="string">"index"</span>);

      <span class="keyword">var</span> avaliables = <span class="keyword">this</span>.model.filter(<span class="function"><span class="keyword">function</span><span class="params">(p)</span> {</span>
        <span class="keyword">var</span> pIndex = p.<span class="keyword">get</span>(<span class="string">'index'</span>);
        <span class="keyword">return</span> pIndex &gt; curIndex && p.<span class="keyword">get</span>(<span class="string">'forInput'</span>);;
      });
      <span class="keyword">var</span> next = _.min( avaliables , <span class="function"><span class="keyword">function</span><span class="params">(m)</span>{</span>
        <span class="keyword">return</span> m.<span class="keyword">get</span>(<span class="string">'index'</span>);
      });
      <span class="keyword">if</span>(next == Infinity) next = <span class="keyword">this</span>.cur;

      <span class="keyword">return</span> next || <span class="keyword">this</span>.cur;
    },
    <span class="comment">// 设置当前选中页面</span>
    setCurrent: <span class="function"><span class="keyword">function</span><span class="params">(cur)</span>{</span>
      <span class="keyword">if</span>(<span class="keyword">this</span>.cur) { <span class="keyword">this</span>.cur.<span class="keyword">set</span>({current: <span class="literal">false</span>}); }
      cur.<span class="keyword">set</span>({ current: <span class="literal">true</span> });
      <span class="keyword">this</span>.cur = cur;
      <span class="keyword">this</span>.setIndicator();
    },
    <span class="comment">// 设置百分数</span>
    setIndicator: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">var</span> self = <span class="keyword">this</span>;

      <span class="keyword">var</span> p = <span class="keyword">this</span>.model.reduce(<span class="function"><span class="keyword">function</span><span class="params">(percent, page)</span>{</span>
        <span class="keyword">if</span>(page.isAllFilled(self.user) && !page.<span class="keyword">get</span>(<span class="string">"showInNav"</span>) && page.<span class="keyword">get</span>(<span class="string">"forInput"</span>)) {
          <span class="keyword">var</span> tmp = -<span class="number">1</span>;
          <span class="keyword">if</span>( self.user.isCompany() ) {
            tmp = page.<span class="keyword">get</span>(<span class="string">"complete"</span>);
          } <span class="keyword">else</span> {
            tmp = page.<span class="keyword">get</span>(<span class="string">"completeForCompany"</span>);
          }
          <span class="keyword">return</span> percent &gt; tmp ? percent : tmp;
        } <span class="keyword">else</span> {
          <span class="keyword">return</span> percent;
        }
      }, <span class="number">0</span>);

      <span class="keyword">this</span>.$navIndicator.html( p + <span class="string">'%'</span>);
    }
  });

  $.app.views.AppView = AppView;
  $.app.views.PageView = PageView;

}).call(<span class="keyword">this</span>);
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
</pre></td><td class="code"><pre><span class="comment">// 每个页面都有自己的控制器</span>
(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>

  <span class="keyword">var</span> models = $.app.models;
  <span class="keyword">var</span> PageInfo = models.PageInfo;
  <span class="keyword">var</span> UserType = models.UserType;
  <span class="keyword">var</span> PageView = $.app.views.PageView;

  <span class="keyword">var</span> telRegex =  <span class="regexp">/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/</span>;

  $.app.pages.BasicInfo = <span class="function"><span class="keyword">function</span><span class="params">(user)</span>{</span>

    <span class="keyword">var</span> info = <span class="keyword">new</span> PageInfo({
      el: <span class="string">"#partialBasicInfo"</span>,
      name: <span class="string">"基本信息"</span>,
      index: <span class="number">1</span>,
      complete: <span class="number">0</span>,
      <span class="comment">// 如果所有的字段都要填写， 就不用重写 isAllFilled</span>
      validateKeys: [<span class="string">'identity'</span>, <span class="string">'userName'</span>, <span class="string">'cellPhoneNumber'</span>],
      <span class="comment">// 重写 pageInfo 方法，因为并不是所有字段都要验证</span>
      isAllFilled: <span class="function"><span class="keyword">function</span><span class="params">(model)</span> {</span>
        <span class="comment">// 调用父类方法</span>
        <span class="keyword">if</span>(<span class="keyword">this</span>.__proto__.isAllFilled(model)) {
          <span class="keyword">var</span> id = model.get(<span class="string">'identity'</span>);
          <span class="comment">// 如果是企业主那么 需要填写 share</span>
          <span class="keyword">if</span>(id == UserType.BusinessOwner || id == UserType.SelfEmployed) {
            <span class="keyword">return</span> !<span class="keyword">this</span>.isEmpty( model.get(<span class="string">'share'</span>) );
          }
          <span class="keyword">return</span> <span class="literal">true</span>;
        }
        <span class="keyword">return</span> <span class="literal">false</span>;
      }
    });

    <span class="keyword">var</span> BasicInfoView = PageView.extend({
      init: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="comment">// 绑定作用域</span>
        _.bindAll(<span class="keyword">this</span>, <span class="string">"syncIdentity"</span>, <span class="string">"syncShare"</span>);

        <span class="comment">// 缓存选择器</span>
        <span class="keyword">this</span>.$telError = $(<span class="string">'#telError'</span>);
        <span class="keyword">this</span>.$nameError = $(<span class="string">'#nameError'</span>);
        <span class="keyword">this</span>.$nameInput = $(<span class="string">"#username"</span>);
        <span class="keyword">this</span>.$telInput = $(<span class="string">"#tel"</span>);

        <span class="comment">//初始化参数</span>
        <span class="keyword">this</span>.syncIdentity();
        <span class="keyword">this</span>.syncShare();
        <span class="keyword">this</span>.$telInput.val(user.get(<span class="string">'cellPhoneNumber'</span>));
        <span class="keyword">this</span>.$nameInput.val(user.get(<span class="string">'userName'</span>));

        <span class="comment">// 监听变化</span>
        <span class="keyword">this</span>.listenTo(user, <span class="string">'change:identity'</span>, <span class="keyword">this</span>.syncIdentity);
        <span class="keyword">this</span>.listenTo(user, <span class="string">'change:share'</span>, <span class="keyword">this</span>.syncShare);
        <span class="keyword">this</span>.listenTo(user, <span class="string">'change:userName'</span>, <span class="function"><span class="keyword">function</span><span class="params">(model, val)</span>{</span>
          <span class="keyword">this</span>.$nameInput.val(val);
        });
        <span class="keyword">this</span>.listenTo(user, <span class="string">'change:cellPhoneNumber'</span>, <span class="function"><span class="keyword">function</span><span class="params">(model, val)</span>{</span>
          <span class="keyword">this</span>.$telInput.val(val);
        });
      },
      events: {
        <span class="string">"change #tel"</span>: <span class="string">"chkTel"</span>,
        <span class="string">"change #username"</span>: <span class="string">"chkName"</span>,
        <span class="string">"click .form .identity li"</span>: <span class="string">"selectType"</span>,
        <span class="string">"click .form .info a"</span>: <span class="string">"selectShare"</span>
      },
      syncIdentity: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        <span class="keyword">var</span> $cur = <span class="keyword">this</span>.$(<span class="string">'.identity li[data-type='</span> + user.get(<span class="string">'identity'</span>)  + <span class="string">']'</span>);
        $(<span class="string">'.identity li'</span>).removeClass(<span class="string">'cur'</span>);
        $cur.addClass(<span class="string">'cur'</span>);
      },
      syncShare: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        <span class="keyword">var</span> $cur = <span class="keyword">this</span>.$(<span class="string">'.identity .info a[data-type='</span> + user.get(<span class="string">'share'</span>)  + <span class="string">']'</span>);
        $(<span class="string">'.identity .info a'</span>).removeClass(<span class="string">'cur'</span>);
        $cur.addClass(<span class="string">'cur'</span>);
      },
      chkTel: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        <span class="keyword">var</span> tel = <span class="keyword">this</span>.$telInput.val();
        <span class="keyword">if</span>( !telRegex.test(tel) ) {
          <span class="keyword">this</span>.$telError.show();
        } <span class="keyword">else</span> {
          <span class="keyword">this</span>.$telError.hide();
          <span class="comment">// 如果正确，就保存起来</span>
          user.set(<span class="string">'cellPhoneNumber'</span>, tel);
          <span class="keyword">return</span> <span class="literal">true</span>;
        }
        <span class="keyword">if</span>( ret == <span class="string">""</span> ){
          user.set(<span class="string">'cellPhoneNumber'</span>, <span class="string">""</span>);
        }
        <span class="keyword">return</span> <span class="literal">false</span>;
      },
      chkName: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        <span class="keyword">var</span> username = $.trim(<span class="keyword">this</span>.$nameInput.val());
        <span class="keyword">if</span>(username==<span class="string">""</span>) {
          <span class="keyword">this</span>.showNameError(<span class="string">"请输入用户名"</span>);
          user.set(<span class="string">'userName'</span>, <span class="string">""</span>);
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
        <span class="keyword">else</span> <span class="keyword">if</span>( <span class="regexp">/^\d.*$/</span>.test( username ) ){
          <span class="keyword">this</span>.showNameError(<span class="string">"用户名不能以数字开头"</span>);
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
        <span class="keyword">else</span> <span class="keyword">if</span>(username.length&lt;<span class="number">2</span> || username.length&gt;<span class="number">15</span> ){
          <span class="keyword">this</span>.showNameError(<span class="string">"合法长度为2-15个字符"</span>);
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
        <span class="keyword">else</span> {
          <span class="keyword">this</span>.showNameError(<span class="string">""</span>);
        }
        user.set(<span class="string">'userName'</span>, username);
        <span class="keyword">return</span> <span class="literal">true</span>;
      },
      showNameError: <span class="function"><span class="keyword">function</span><span class="params">(notify)</span> {</span>
        <span class="keyword">this</span>.$nameError.html(notify);
        <span class="keyword">if</span>( notify != <span class="string">""</span> ) <span class="keyword">this</span>.$nameError.show();
        <span class="keyword">else</span> <span class="keyword">this</span>.$nameError.hide();
      },
      selectType: <span class="function"><span class="keyword">function</span><span class="params">(e)</span>{</span>
        <span class="keyword">var</span> target = $(e.currentTarget);
        user.set(<span class="string">'identity'</span>, target.data(<span class="string">'type'</span>));
      },
      selectShare: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> {</span>
        <span class="keyword">var</span> target = $(e.currentTarget);
        user.set(<span class="string">'share'</span>, target.data(<span class="string">'type'</span>));
      }
    });

    <span class="keyword">var</span> page = <span class="keyword">new</span> BasicInfoView({ model: info });

    <span class="keyword">return</span> info;
  };
}).call(<span class="keyword">this</span>);
</pre></td></tr></table></figure>

<h1 id="-">程序入口</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="code"><pre><span class="comment">// app.js</span>
$(<span class="function"><span class="keyword">function</span><span class="params">()</span><span class="comment">{

  var views = $.app.views;
  var models = $.app.models;
  var pages = $.app.pages;

  var PageInfo = models.PageInfo;
  var PageInfos = models.PageInfos;
  var PageView = views.PageView;
  var AppView = views.AppView;
  var User = models.User;

  var app = app || {}</span>;</span>

  app.user = <span class="keyword">new</span> User();

  app.pages = <span class="keyword">new</span> PageInfos();

  app.pages.<span class="keyword">add</span>( pages.Slogan(app.user) );
  app.pages.<span class="keyword">add</span>( pages.BasicInfo(app.user));
  app.pages.<span class="keyword">add</span>( pages.CompanyType(app.user));
  app.pages.<span class="keyword">add</span>( pages.IncomeType(app.user));
  app.pages.<span class="keyword">add</span>( pages.WorkingAge(app.user));
  app.pages.<span class="keyword">add</span>( pages.CompanyPosition(app.user));
  app.pages.<span class="keyword">add</span>( pages.CreditStanding(app.user));
  app.pages.<span class="keyword">add</span>( pages.SocialSecurityfund(app.user));
  app.pages.<span class="keyword">add</span>( pages.UserInfo(app.user) );
  app.pages.<span class="keyword">add</span>( pages.HouseInfo(app.user) );
  app.pages.<span class="keyword">add</span>( pages.MonthIncome(app.user) );
  app.pages.<span class="keyword">add</span>( pages.LoansInfo(app.user) );
  app.pages.<span class="keyword">add</span>(pages.CarInfo(app.user));
  <span class="comment">// TODO</span>
  app.pages.<span class="keyword">add</span>( pages.Region(app.user) );

  app.pages.<span class="keyword">add</span>( pages.Review(app.user) );
  app.pages.<span class="keyword">add</span>( pages.CompanyRegion(app.user) );
  app.pages.<span class="keyword">add</span>( pages.Bill(app.user) );
  app.pages.<span class="keyword">add</span>( pages.Complete(app.user) );
  app.pages.<span class="keyword">add</span>( pages.CreditInfo(app.user) );

  <span class="keyword">var</span> s = <span class="keyword">new</span> AppView(<span class="comment">{model: app.pages, el: '.container', user: app.user}</span>);
});
</pre></td></tr></table></figure>

<h1 id="todo">TODO</h1>
<ol>
<li>模型的拷贝</li>
<li>route</li>
<li>模块化 requirejs </li>
</ol>
  
	</div>
		<footer class="article-footer clearfix">




<div class="article-share" id="share">

  <div data-url="http://zhpooer.github.io/2015/04/21/backbone/" data-title="BackBone | Poe&#39;s World" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2015/04/18/susy/"  title="susy">
 <strong>NEXT:</strong><br/> 
 <span>susy
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#-model-"><span class="toc-number">1.</span> <span class="toc-text">模型(Model)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">2.</span> <span class="toc-text">视图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">3.</span> <span class="toc-text">控制器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">4.</span> <span class="toc-text">程序入口</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#todo"><span class="toc-number">5.</span> <span class="toc-text">TODO</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/AJAX/" title="AJAX">AJAX<sup>1</sup></a></li>
		
			<li><a href="/tags/Akka/" title="Akka">Akka<sup>1</sup></a></li>
		
			<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
		
			<li><a href="/tags/DOM/" title="DOM">DOM<sup>2</sup></a></li>
		
			<li><a href="/tags/EL表达式/" title="EL表达式">EL表达式<sup>1</sup></a></li>
		
			<li><a href="/tags/HBase/" title="HBase">HBase<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>2</sup></a></li>
		
			<li><a href="/tags/HttpSession/" title="HttpSession">HttpSession<sup>1</sup></a></li>
		
			<li><a href="/tags/IO/" title="IO">IO<sup>1</sup></a></li>
		
			<li><a href="/tags/Illustrator/" title="Illustrator">Illustrator<sup>3</sup></a></li>
		
			<li><a href="/tags/JSP/" title="JSP">JSP<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaBean/" title="JavaBean">JavaBean<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>1</sup></a></li>
		
			<li><a href="/tags/Mybatis/" title="Mybatis">Mybatis<sup>1</sup></a></li>
		
			<li><a href="/tags/NoSql/" title="NoSql">NoSql<sup>1</sup></a></li>
		
			<li><a href="/tags/SASS/" title="SASS">SASS<sup>1</sup></a></li>
		
			<li><a href="/tags/SAX/" title="SAX">SAX<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletRequest/" title="ServletRequest">ServletRequest<sup>1</sup></a></li>
		
			<li><a href="/tags/ServletResponse/" title="ServletResponse">ServletResponse<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://zhpooer.github.io" target="_blank" title="zhpooer">zhpooer</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"zhpoooer"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
